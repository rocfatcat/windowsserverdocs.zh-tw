---
title: RAS 閘道高可用性
description: 您可以使用本主題來瞭解 Windows Server 2016 中軟體定義網路（SDN）的 RAS 多租使用者閘道高可用性設定。
manager: brianlic
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.suite: na
ms.technology: networking-sdn
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: lizross
author: eross-msft
ms.openlocfilehash: 5fca4fc6a636bcde155e60b6da3c827bc9313606
ms.sourcegitcommit: da7b9bce1eba369bcd156639276f6899714e279f
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/26/2020
ms.locfileid: "80313040"
---
# <a name="ras-gateway-high-availability"></a>RAS 閘道高可用性

>適用於：Windows Server (半年通道)、Windows Server 2016

您可以使用本主題來瞭解適用于軟體定義網路（SDN）之 RAS 多租使用者閘道的高可用性設定。  
  
本主題包含下列各節。  
  
-   [RAS 閘道總覽](#bkmk_overview)  
  
-   [閘道集區總覽](#bkmk_pools)  
  
-   [RAS 閘道部署總覽](#bkmk_deployment)  
  
-   [RAS 閘道與網路控制站的整合](#bkmk_integration)  
  
## <a name="ras-gateway-overview"></a><a name="bkmk_overview"></a>RAS 閘道總覽  
如果您的組織是雲端服務提供者（CSP）或具有多個租使用者的企業，您可以在多租使用者模式中部署 RAS 閘道，以提供進出虛擬和實體網路（包括網際網路）的網路流量路由。  
  
您可以在多組織使用者共用模式中將 RAS 閘道部署為邊緣閘道，以將租使用者客戶網路流量路由至租使用者虛擬網路和資源。  
  
當您部署多個可提供高可用性和容錯移轉的 RAS 閘道 Vm 實例時，您會部署閘道集區。 在 Windows Server 2012 R2 中，所有閘道 Vm 形成一個單一集區，讓閘道部署的邏輯區隔有點困難。  Windows Server 2012 R2 閘道為閘道 Vm 提供1:1 冗余部署，導致無法使用站對站（S2S） VPN 連線的可用容量。  
  
此問題已在 Windows Server 2016 中解決，它會提供多個閘道集區，這可以是不同類型的邏輯分隔。 M + N 冗余的新模式可讓您更有效率地進行容錯移轉設定。  
  
如需 RAS 閘道的詳細總覽資訊，請參閱[Ras 閘道](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)。  
  
## <a name="gateway-pools-overview"></a><a name="bkmk_pools"></a>閘道集區總覽  
在 Windows Server 2016 中，您可以在一或多個集區中部署閘道。  
  
下圖顯示在虛擬網路之間提供流量路由的不同類型閘道集區。  
  
![RAS 閘道集區](../../../media/RAS-Gateway-High-Availability/ras_pools.png)  
  
每個集區都有下列屬性。  
  
-   每個集區都是 M + N 多餘的。 這表示會由 ' N ' 個待命閘道 Vm 數目來備份作用中閘道 Vm 的數目。 N （待命閘道）的值一律小於或等於 M （作用中閘道）。  
  
-   集區可以執行任何個別的閘道函式，網際網路金鑰交換版本2（IKEv2） S2S、第3層（L3）和一般路由封裝（GRE），或集區可以執行所有這些功能。  
  
-   您可以將單一公用 IP 位址指派給所有集區或集區的子集。 這麼做可大幅減少您必須使用的公用 IP 位址數目，因為可以讓所有租使用者在單一 IP 位址上連接到雲端。 下面的「高可用性」和「負載平衡」一節說明其運作方式。  
  
-   您可以藉由在集區中新增或移除閘道 Vm，輕鬆地相應增加或減少閘道集區。 移除或新增閘道並不會中斷集區所提供的服務。 您也可以新增和移除整個閘道集區。  
  
-   單一租使用者的連線可在多個集區上終止，而在集區中有多個閘道。 不過，如果租使用者的連線在**All**類型閘道集區中終止，它就無法訂閱其他**所有**類型或個別類型閘道集區。  
  
閘道集區也提供啟用額外案例的彈性：  
  
-   單一租使用者集區-您可以建立一個供一個租使用者使用的集區。  
  
-   如果您是透過合作夥伴（轉銷商）通道來銷售雲端服務，您可以為每個轉售商建立一組個別的集區。  
  
-   多個集區可以提供相同的閘道功能，但容量不同。 例如，您可以建立同時支援高輸送量和低輸送量 IKEv2 S2S 連線的閘道集區。  
  
## <a name="ras-gateway-deployment-overview"></a><a name="bkmk_deployment"></a>RAS 閘道部署總覽  
下圖示范 RAS 閘道的一般雲端服務提供者（CSP）部署。  
  
![RAS 閘道部署總覽](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)  
  
使用這種類型的部署時，閘道集區會部署在軟體 Load Balancer （SLB）後方，讓 CSP 為整個部署指派單一公用 IP 位址。 租使用者的多個閘道連線可在多個閘道集區上終止，也可以在集區中的多個閘道上結束 這會透過上圖中的 IKEv2 S2S 連線加以說明，但同樣也適用于其他閘道功能，例如 L3 和 GRE 閘道。  
  
在此圖中，MT BGP 裝置是具有 BGP 的 RAS 多租使用者閘道。 多租使用者 BGP 會用於動態路由。 租使用者的路由是集中式的（稱為路由反射器（RR）的單一點）會處理所有租使用者網站的 BGP 對等互連。 RR 本身會分散到集區中的所有閘道。 這會導致設定，其中租使用者（資料路徑）的連線會在多個閘道上終止，但是租使用者的 RR （BGP 對等點控制路徑）只會在其中一個閘道上。  
  
BGP 路由器會在圖表中分開，以描述此集中式路由概念。 閘道 BGP 實行也提供傳輸路由，可讓雲端作為在兩個租使用者網站之間路由的傳輸點。 這些 BGP 功能適用于所有閘道功能。  
  
## <a name="ras-gateway-integration-with-network-controller"></a><a name="bkmk_integration"></a>RAS 閘道與網路控制站的整合  
RAS 閘道與 Windows Server 2016 中的網路控制站完全整合在一起。 部署 RAS 閘道和網路控制站時，網路控制卡會執行下列功能。  
  
-   閘道集區的部署  
  
-   每個閘道上的租使用者連線設定  
  
-   發生閘道失敗時，將網路流量切換到待命閘道  
  
下列各節提供有關 RAS 閘道和網路控制卡的詳細資訊。  
  
-   [閘道連線的布建和負載平衡（IKEv2、L3 和 GRE）](#bkmk_provisioning)  
  
-   [IKEv2 S2S 的高可用性](#bkmk_ike)  
  
-   [GRE 的高可用性](#bkmk_gre)  
  
-   [L3 轉送閘道的高可用性](#bkmk_l3)  
  
### <a name="provisioning-and-load-balancing-of-gateway-connections-ikev2-l3-and-gre"></a><a name="bkmk_provisioning"></a>閘道連線的布建和負載平衡（IKEv2、L3 和 GRE）  
當租使用者要求閘道連線時，會將要求傳送至網路控制卡。 網路控制卡已設定所有閘道集區的相關資訊，包括每個集區的容量，以及每個集區中的每個閘道。 網路控制卡會為連線選取正確的集區和閘道。 此選項是根據連接的頻寬需求。 網路控制卡會使用「最適合」演算法，在集區中有效率地挑選連接。 如果這是租使用者的第一次連線，此時也會指定連線的 BGP 對等互連點。  
  
在網路控制卡選取連線的 RAS 閘道之後，網路控制卡會為閘道上的連線布建必要的設定。 如果連接是 IKEv2 S2S 連線，網路控制卡也會在 SLB 集區上布建網路位址轉譯（NAT）規則;SLB 集區上的此 NAT 規則會將來自租使用者的連接要求導向至指定的閘道。 租使用者是由來源 IP 來區分，這應該是唯一的。  
  
> [!NOTE]  
> L3 和 GRE 連線會略過 SLB，並直接與指定的 RAS 閘道連接。  這些連線要求遠端端點路由器（或其他協力廠商裝置）必須正確設定，才能與 RAS 閘道連接。  
  
如果已針對連線啟用 BGP 路由，則會由 RAS 閘道起始 BGP 對等互連，而路由會在內部部署與雲端閘道之間交換。 BGP 所學習到的路由（如果未使用 BGP，則是以靜態方式設定的路由）會傳送至網路控制站。 然後，網路控制站會向下連接至安裝租使用者 Vm 的 Hyper-v 主機。 此時，可以將租使用者流量路由傳送至正確的內部部署網站。 網路控制站也會建立相關聯的 Hyper-v 網路虛擬化原則，以指定閘道位置，並向下連接至 Hyper-v 主機。  
  
### <a name="high-availability-for-ikev2-s2s"></a><a name="bkmk_ike"></a>IKEv2 S2S 的高可用性  
集區中的 RAS 閘道是由不同租使用者的連線和 BGP 對等互連所組成。 每個集區都有「作用中閘道」和「N」待命閘道。  
  
網路控制站會以下列方式處理閘道的失敗。  
  
-   網路控制站會持續偵測所有集區中的閘道，並偵測失敗或失敗的閘道。 網路控制站可以偵測下列類型的 RAS 閘道失敗。  
  
    -   RAS 閘道 VM 失敗  
  
    -   RAS 閘道執行所在的 Hyper-v 主機失敗  
  
    -   RAS 閘道服務失敗  
  
    網路控制站會儲存所有已部署之作用中閘道的設定。 設定是由連線設定和路由設定所組成。  
  
-   當閘道失敗時，它會影響閘道上的租使用者連線，以及位於其他閘道上但其 RR 位於失敗閘道上的租使用者連接。 第二個連接的停機時間小於先前的連線。 當網路控制站偵測到失敗的閘道時，它會執行下列工作。  
  
    -   從計算主機移除受影響連接的路由。  
  
    -   移除這些主機上的 Hyper-v 網路虛擬化原則。  
  
    -   選取待命閘道、將其轉換成作用中閘道，並設定閘道。  
  
    -   變更 SLB 集區上的 NAT 對應，以指向新閘道的連線。  
  
-   同時，當新的主動閘道上出現設定時，會重新建立 IKEv2 S2S 連線和 BGP 對等互連。 雲端閘道或內部部署閘道可以起始連線和 BGP 對等互連。 閘道會重新整理其路由，並將其傳送至網路控制卡。 在網路控制卡學習閘道探索到的新路由之後，網路控制站會將路由和相關聯的 Hyper-v 網路虛擬化原則，傳送至失敗影響的租使用者 Vm 所在的 Hyper-v 主機。 此網路控制卡活動類似于新連線設定的情況，只有在較大規模的情況下才會發生。  
  
### <a name="high-availability-for-gre"></a><a name="bkmk_gre"></a>GRE 的高可用性  
網路控制站的 RAS 閘道容錯移轉回應程式-包括失敗偵測、將連線和路由設定複製到待命閘道、受影響連線的 BGP/靜態路由的容錯移轉（包括在計算主機和 BGP 重新對等互連上進行路由提款和重新設定），以及在計算主機上重新設定 Hyper-v 網路虛擬化原則的程式，對於 GRE 閘道和連線而言 不過，重新建立 GRE 連線的方式會有所不同，但 GRE 的高可用性解決方案則有一些額外的需求。  
  
![GRE 的高可用性](../../../media/RAS-Gateway-High-Availability/ras_ha.png)  
  
在閘道部署時，會為每個 RAS 閘道 VM 指派一個動態 IP 位址（DIP）。 此外，每個閘道 VM 也會被指派一個虛擬 IP 位址（VIP）來提供 GRE 高可用性。 Vip 只會指派給可接受 GRE 連線的集區中的閘道，而非 GRE 集區。 指派的 Vip 會使用 BGP 通告到機架頂端（TOR）交換器，然後進一步將 Vip 通告到雲端實體網路。 這讓閘道可以從 GRE 連線另一端所在的遠端路由器或協力廠商裝置進行連線。 此 BGP 對等互連與租使用者路由交換的租使用者層級 BGP 對等不同。  
  
在 GRE 連線布建期間，網路控制站會選取閘道、在選取的閘道上設定 GRE 端點，並傳回所指派閘道的 VIP 位址。 然後，此 VIP 會設定為遠端路由器上的目的地 GRE 通道位址。  
  
當閘道失敗時，網路控制站會將失敗閘道的 VIP 位址和其他設定資料複製到待命閘道。 當待命閘道變成作用中狀態時，它會將 VIP 公告至其 TOR 交換器，並將它進一步公佈到實體網路。 遠端路由器會繼續將 GRE 通道連線到相同的 VIP，而路由基礎結構則可確保封包會路由傳送至新的作用中閘道。  
  
### <a name="high-availability-for-l3-forwarding-gateways"></a><a name="bkmk_l3"></a>L3 轉送閘道的高可用性  
Hyper-v 網路虛擬化 L3 轉送閘道是資料中心內的實體基礎結構與 Hyper-v 網路虛擬化雲端中虛擬化基礎結構之間的橋樑。 在多組織使用者共用的 L3 轉送閘道上，每個租使用者都使用自己的 VLAN 標記邏輯網路，與租使用者的實體網路連線。  
  
當新的租使用者建立新的 L3 閘道時，網路控制卡閘道 Service Manager 會選取可用的閘道 VM，並使用高可用性客戶位址（CA）空間 IP 位址（來自租使用者的 VLAN 標記邏輯網路）來設定新的租使用者介面。). IP 位址會用來作為遠端（實體網路）閘道上的對等 IP 位址，而是下一個躍點來連線到租使用者的 Hyper-v 網路虛擬化網路。  
  
與 IPsec 或 GRE 網路連線不同的是，TOR 交換器不會動態學習租使用者的 VLAN 標記網路。 租使用者的 VLAN 已標記網路的路由必須在 TOR 交換器和實體基礎結構與閘道之間的所有中繼交換器和路由器上設定，以確保端對端連線能力。  以下是虛擬網路設定的範例 CSP，如下圖所示。  
  
|網路|子網路|VLAN 識別碼|預設閘道|  
|-----------|----------|-----------|-------------------|  
|Contoso L3 邏輯網路|10.127.134.0/24|1001|10.127.134.1|  
|Woodgrove L3 邏輯網路|10.127.134.0/24|1002|10.127.134.1|  
  
以下是範例租使用者閘道設定，如下圖所示。  
  
|租使用者名稱|L3 閘道 IP 位址|VLAN 識別碼|對等 IP 位址|  
|---------------|-------------------------|-----------|-------------------|  
|Contoso|10.127.134.50|1001|10.127.134.55|  
|Woodgrove|10.127.134.60|1002|10.127.134.65|  
  
以下是 CSP 資料中心內這些設定的說明。  
  
![L3 轉送閘道的高可用性](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)  
  
L3 轉送閘道內容中的閘道失敗、失敗偵測和閘道容錯移轉程式，類似于 IKEv2 和 GRE RAS 閘道的進程。 其差異在於外部 IP 位址的處理方式。  
  
當閘道 VM 狀態變成狀況不良時，網路控制卡會從集區中選取其中一個待命閘道，並重新布建待命閘道上的網路連線和路由。 移動連接時，L3 轉送閘道的高可用性 CA 空間 IP 位址也會移到新的閘道 VM，以及租使用者的 CA 空間 BGP IP 位址。  
  
因為 L3 對等互連 IP 位址會在容錯移轉期間移到新的閘道 VM，所以遠端實體基礎結構再次能夠連線到此 IP 位址，然後再連線到 Hyper-v 網路虛擬化工作負載。 針對 BGP 動態路由，因為 CA 空間 BGP IP 位址已移至新的閘道 VM，所以遠端 BGP 路由器可以重新建立對等互連，並再次瞭解所有的 Hyper-v 網路虛擬化路由。  
  
> [!NOTE]  
> 您必須分別設定 TOR 交換器和所有中繼路由器，才能使用 VLAN 標記的邏輯網路來進行租使用者通訊。 此外，L3 容錯移轉僅限於以這種方式設定的機架。 因此，您必須仔細設定 L3 閘道集區，而且必須分別完成手動設定。  
  


