---
title: RAS 閘道高可用性
description: 若要深入了解高可用性組態 RAS 多租用戶閘道的軟體定義網路 (SDN) Windows Server 2016 中，您可以使用本主題。
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-sdn
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 8ce515ceeb7ab6989ef18055f312983a6518a1a1
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59847759"
---
# <a name="ras-gateway-high-availability"></a>RAS 閘道高可用性

>適用於：Windows Server （半年通道），Windows Server 2016

您可以使用本主題來深入了解高可用性組態 RAS 多租用戶閘道的軟體定義網路 (SDN)。  
  
本主題涵蓋下列各節。  
  
-   [RAS 閘道概觀](#bkmk_overview)  
  
-   [閘道集區概觀](#bkmk_pools)  
  
-   [RAS 閘道部署概觀](#bkmk_deployment)  
  
-   [RAS 閘道與網路控制站的整合](#bkmk_integration)  
  
## <a name="bkmk_overview"></a>RAS 閘道概觀  
如果您的組織是雲端服務提供者 (CSP) 或多個租用戶的企業，您就可以在多租用戶的模式，以提供網路流量路由與虛擬和實體網路，包括網際網路部署 RAS 閘道。  
  
您可以在多租用戶模式中部署 RAS 閘道，為最新的閘道路由傳送給租用戶虛擬網路和資源的租用戶客戶網路流量。  
  
當您部署多個提供高可用性和容錯移轉的 RAS 閘道 Vm 執行個體時，您要部署閘道集區。 Windows Server 2012 r2 中的所有閘道 Vm 都形成單一的集區，使得閘道部署的邏輯分隔有點困難。  Windows Server 2012 R2 閘道提供 1:1 備援部署閘道的站對站 (S2S) 的可用容量不足的情況會產生 VPN 連線的 Vm。  
  
它提供多個閘道集區-會邏輯區隔不同類型的 Windows Server 2016 中已解決此問題。 M + N 備援的新模式允許更有效率的容錯移轉設定。  
  
如需 RAS 閘道的詳細概觀資訊，請參閱 < [RAS 閘道](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)。  
  
## <a name="bkmk_pools"></a>閘道集區概觀  
在 Windows Server 2016 中，您可以部署一或多個集區中的閘道。  
  
下圖顯示不同類型的提供虛擬網路之間的流量路由的閘道集區。  
  
![RAS 閘道集區](../../../media/RAS-Gateway-High-Availability/ras_pools.png)  
  
每個集區具有下列屬性。  
  
-   每個集區是 M + N 備援。 這表示，是 'active 閘道的 Vm 數目會由待命的閘道 Vm 的' n ' 數目。 N （待命的閘道） 的值一律是小於或等於 M （作用中的閘道）。  
  
-   集區可以執行任何個別的閘道函式-網際網路金鑰交換版本 2 (IKEv2) S2S、 第 3 層 (L3)，和 Generic Routing Encapsulation (GRE)-或集區可以執行所有這些函式。  
  
-   所有集區或集區的子集，您可以指派單一的公用 IP 位址。 這麼做能夠大幅減少的公用 IP 位址，您必須使用，因為可能有連線到雲端的單一 IP 位址上的所有租用戶。 高可用性和負載平衡下的一節說明其運作方式。  
  
-   您可以輕鬆地會藉由新增或移除閘道 Vm 集區中調整閘道集區增加或相應減少。 移除或加入閘道不會破壞的集區所提供的服務。 您也可以新增和移除的閘道的整個集區。  
  
-   單一租用戶的連線可以在多個集區和集區中的多個閘道上終止。 不過，如果租用戶都有連線終止**所有**輸入閘道集區，它便無法訂閱其他**所有**型別或個別類型閘道集區。  
  
閘道集區也提供的彈性，以啟用其他案例：  
  
-   單一租用戶的集區-您可以建立一個集區，以供一個租用戶。  
  
-   如果您有銷售管道夥伴 （轉銷商） 的雲端服務，您可以建立不同的集區集針對每個轉售商。  
  
-   多個集區可以提供相同的閘道函式，但不同的容量。 例如，您可以建立支援高輸送量及低輸送量 IKEv2 S2S 連線的閘道集區。  
  
## <a name="bkmk_deployment"></a>RAS 閘道部署概觀  
下圖示範典型的雲端服務提供者 (CSP) 部署的 RAS 閘道。  
  
![RAS 閘道部署概觀](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)  
  
這種部署類型，使用閘道集區部署背後的軟體負載平衡器 (SLB)，可讓 CSP 可以指派整個部署的單一公用 IP 位址。 在多個閘道的集區-同時也會在集區中的多個閘道，可以終止的租用戶的多個閘道連線。 說明透過在上圖中，IKEv2 S2S 連線，但這也適用其他閘道函式，例如 L3 以及 GRE 的閘道。  
  
在圖中，MT BGP 裝置是 RAS 多租用戶閘道 bgp。 多租用戶 BGP 用於動態路由。 租用戶的路由集中式-名為路由反映程式 (RR) 的單一點、 處理的 BGP 對等互連的所有租用戶網站。 RR 本身會分散到集區中的所有閘道。 這會導致其中租用戶 （資料路徑） 的連線終止於多個閘道，但租用戶 （BGP 對等互連點-控制路徑） 的 RR 是只有其中一個閘道的組態。  
  
在圖表中，以描述此集中式的路由概念 BGP 路由器被分開的。 閘道 BGP 實作同時也提供的傳輸路由，可使用雲端，以做為兩個租用戶站台之間路由的傳輸點。 這些 BGP 功能都適用於閘道的所有函式項目。  
  
## <a name="bkmk_integration"></a>RAS 閘道與網路控制站的整合  
RAS 閘道完全整合與 Windows Server 2016 中的網路控制站。 當部署 RAS 閘道和網路控制站時，網路控制站就會執行下列功能。  
  
-   閘道集區的部署  
  
-   每個閘道上的租用戶連線的設定  
  
-   切換網路流量流向閘道失敗時的待命的閘道  
  
下列各節提供有關 RAS 閘道和網路控制站的詳細的資訊。  
  
-   [佈建和負載平衡 （IKEv2，L3，GRE） 的閘道連線](#bkmk_provisioning)  
  
-   [IKEv2 S2S 的高可用性](#bkmk_ike)  
  
-   [GRE 的高可用性](#bkmk_gre)  
  
-   [轉送閘道 L3 的高可用性](#bkmk_l3)  
  
### <a name="bkmk_provisioning"></a>佈建和負載平衡 （IKEv2，L3，GRE） 的閘道連線  
當租用戶要求的閘道連線時，要求會傳送至網路控制卡中。 網路控制站被設定所有閘道集區，包括每個集區中的每個集區和每個閘道的容量的相關資訊。 網路控制卡選取正確的集區和連線的閘道。 此選取項目根據連線的頻寬需求。 網路控制站會使用"best fit"演算法，來有效率地挑選集區中的連線。 如果這是租用戶的第一個連線，連線的 BGP 對等互連點也會指定這一次。  
  
網路控制卡選取 RAS 閘道連線之後，網路控制站會佈建在閘道上連接必要的設定。 如果連線是 IKEv2 S2S 連線，網路控制站也會佈建在 SLB 集區; 上的網路位址轉譯 (NAT) 規則SLB 的集區上的此 NAT 規則會指示從租用戶將連線要求到指定的閘道。 來源 IP，這必須是唯一的差別在於租用戶。  
  
> [!NOTE]  
> L3 與 GRE 連線略過 SLB，並直接與指定的 RAS 閘道連線。  這些連線要求，遠端端點路由器 （或其他協力廠商裝置） 必須正確設定為使用 RAS 閘道連線。  
  
如果連接已啟用 BGP 路由 BGP 對等互連由 RAS 閘道-然後內部部署和雲端之間交換路由閘道。 所學到的 BGP （或，會以靜態方式設定的路由，如果未使用 BGP） 路由傳送至網路控制站。 網路控制站，然後連接到安裝在其租用戶 Vm 的 HYPER-V 主機的路由。 到目前為止，您還可以租用戶流量路由至正確在內部部署站台。 網路控制站也會建立相關聯的 HYPER-V 網路虛擬化原則，指定閘道的位置，並將它們連接到 HYPER-V 主機。  
  
### <a name="bkmk_ike"></a>IKEv2 S2S 的高可用性  
RAS 閘道集區中包含連接和 BGP 對等互連不同的租用戶。 每個集區已是 '使用中的閘道和' n ' 待命的閘道。  
  
網路控制卡會以下列方式處理失敗的閘道。  
  
-   網路控制卡不斷 ping 的閘道，在所有集區和可以偵測失敗的閘道或失敗。 網路控制站可以偵測到下列類型的 RAS 閘道失敗。  
  
    -   RAS 閘道 VM 失敗  
  
    -   失敗的 RAS 閘道正在執行的 HYPER-V 主機  
  
    -   RAS 閘道服務失敗  
  
    網路控制站會儲存所有已部署的使用中閘道的設定。 組態是由連線設定，且路由的設定所組成。  
  
-   當閘道失敗時，它會影響租用戶連線閘道上，以及租用戶連線都位於其他閘道，但其 RR 位於上失敗的閘道。 其中的第二個連線的停機時間小於前者。 當網路控制站偵測到失敗的閘道時，它會執行下列工作。  
  
    -   計算主機中移除受影響的連線的路由。  
  
    -   移除這些主機上的 HYPER-V 網路虛擬化原則。  
  
    -   選取待命的閘道，將它轉換為使用中的閘道，以及設定閘道。  
  
    -   變更指向新的閘道連線 SLB 集區上的 NAT 對應。  
  
-   同時，因為組態會出現在新的作用中閘道中，IKEv2 S2S 連線和 BGP 對等互連是重新建立。 連接和 BGP 對等互連可起始的雲端閘道或內部部署閘道。 閘道會重新整理其路由，並將它們傳送至網路控制站。 網路控制卡學習新的閘道所探索到的路由之後，網路控制站會傳送路由和相關聯的 HYPER-V 網路虛擬化原則到 HYPER-V 主機的失敗影響的租用戶 Vm 的所在位置。 此網路控制器活動是類似新的連線設定的情況，只有發生大規模。  
  
### <a name="bkmk_gre"></a>GRE 的高可用性  
RAS 閘道容錯移轉回應，由網路控制站-包括失敗偵測，複製 連接到待命的閘道，容錯移轉的受影響的連線的路由，BGP/靜態路由組態的程序 (包括提款和重新上最重要的路由計算主機和 BGP 重新對等互連），並重新設定的計算主機-HYPER-V 網路虛擬化原則也適用於 GRE 閘道和連線。 GRE 連線重新建立會以不同的方式，不過，和 GRE 的高可用性解決方案有一些額外的需求。  
  
![GRE 的高可用性](../../../media/RAS-Gateway-High-Availability/ras_ha.png)  
  
在閘道部署時，RAS 閘道的每個 VM 會指派動態 IP 位址 (DIP)。 此外，每個閘道 VM 也被指派 GRE 高可用性的虛擬 IP 位址 (VIP)。 只可以接受 GRE 連線的集區中的閘道，不適用於非 GRE 集區，會指派 Vip。 指派的 Vip 會公告至頂端使用 BGP，然後進一步到雲端的實體網路通告 Vip rack (TOR) 交換器。 這可讓閘道連線從遠端路由器或協力廠商裝置另一端的 GRE 連線所在的位置。 此 BGP 對等互連是不同的租用戶層級 BGP 對等的租用戶路由交換。  
  
GRE 連線佈建時，網路控制卡選取閘道、 設定 GRE 端點上選取的閘道，並傳回已指派閘道的 VIP 位址。 此 VIP 然後設定為目的地的遠端路由器的 GRE 通道位址。  
  
當閘道失敗時，網路控制站會將失敗的閘道和其他組態資料的 VIP 位址複製到待命的閘道。 作用中待命的閘道時，它會通告其 TOR 交換器至 VIP，並進一步實體網路。 遠端路由器可以持續連接至相同的 VIP 的 GRE 通道和路由基礎結構可確保封包會路由傳送到新的作用中閘道。  
  
### <a name="bkmk_l3"></a>轉送閘道 L3 的高可用性  
HYPER-V 網路虛擬化 L3 轉寄閘道是在資料中心的實體基礎結構與 HYPER-V 網路虛擬化雲端中的虛擬化基礎結構之間的橋樑。 在多租用戶的 L3 轉寄閘道，每個租用戶會使用它自己的 VLAN 已標記的邏輯網路與租用戶的實體網路連線。  
  
當新的租用戶建立新的 L3 閘道時，網路控制站閘道 Service Manager 選取可用的閘道 VM，並設定新的租用戶介面使用高可用性客戶位址 (CA) 空間中的 IP 位址 （租用戶的 VLAN 已標記的邏輯網路). IP 位址做為遠端 （實體網路） 閘道上，對等體 IP 位址，並為下個躍點連線到租用戶的 HYPER-V 網路虛擬化網路。  
  
不同於 IPsec 或 GRE 網路連線，TOR 交換器將不了解租用戶的 VLAN 標記的網路以動態方式。 租用戶的 VLAN 標記網路的路由必須在 TOR 交換器和所有中繼的交換器和路由器之間的實體基礎結構和確保端對端連線的閘道上設定。  以下是範例 CSP 虛擬網路組態，在下圖中所述。  
  
|Network|子網路|VLAN 識別碼|預設閘道|  
|-----------|----------|-----------|-------------------|  
|Contoso L3 邏輯網路|10.127.134.0/24|1001|10.127.134.1|  
|Woodgrove L3 邏輯網路|10.127.134.0/24|1002|10.127.134.1|  
  
以下是範例租用戶閘道設定，在下圖中所述。  
  
|租用戶名稱|L3 閘道 IP 位址|VLAN 識別碼|對等體 IP 位址|  
|---------------|-------------------------|-----------|-------------------|  
|Contoso|10.127.134.50|1001|10.127.134.55|  
|Woodgrove|10.127.134.60|1002|10.127.134.65|  
  
以下是在 CSP 資料中心的這些設定的圖例。  
  
![轉送閘道 L3 的高可用性](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)  
  
閘道失敗，失敗偵測和 L3 轉寄閘道的內容中的閘道容錯移轉程序是類似於 IKEv2 和 GRE RAS 閘道的程序。 差異是中的外部 IP 位址的處理的方式。  
  
當閘道 VM 狀態會變為狀況不良時，網路控制站從集區中選取其中一個待命的閘道，並重新佈建的網路連線和待命的閘道上的路由。 雖然移動連接，L3 轉寄閘道的高可用 CA 空間的 IP 位址也會移動到租用戶的 CA 空間 BGP IP 位址以及新的閘道 VM。  
  
因為 L3 對等互連的 IP 位址會移至新的閘道 VM，在容錯移轉期間，遠端的實體基礎結構是一次能夠連接到此 IP 位址，並接著，連線到 HYPER-V 網路虛擬化工作負載。 BGP 動態路由，BGP IP 位址會移至新的閘道 VM，CA 空間為遠端的 BGP 路由器可以重新建立對等互連，並一次了解 HYPER-V 網路虛擬化的所有路由。  
  
> [!NOTE]  
> 若要使用 VLAN 已標記的邏輯網路的租用戶通訊，您必須個別設定的 TOR 交換器及其所有中繼路由器。 颾魤 ㄛ L3 容錯移轉是限制為只在機架中這種方式設定。 因為這個緣故，必須仔細設定 L3 閘道集區，並手動設定必須分開完成。  
  


