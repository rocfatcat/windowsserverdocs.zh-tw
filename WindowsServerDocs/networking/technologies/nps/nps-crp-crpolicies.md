---
title: 連線要求原則
description: 本主題概要說明 Windows Server 2016 中的網路原則伺服器連線要求原則。
manager: brianlic
ms.prod: windows-server
ms.technology: networking
ms.topic: article
ms.assetid: 4ec45e0c-6b37-4dfb-8158-5f40677b0157
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 0b373e496567f414657b380bad952baefcbe4b18
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/27/2019
ms.locfileid: "71396364"
---
# <a name="connection-request-policies"></a>連線要求原則

>適用於：Windows Server (半年度管道)、Windows Server 2016

您可以使用本主題來瞭解如何使用 NPS 連線要求原則，將 NPS 設定為 RADIUS 伺服器、RADIUS proxy 或兩者。

>[!NOTE]
>除了本主題之外，還提供下列連接要求原則檔。
> - [設定連線要求原則](nps-crp-configure.md)
> - [設定遠端 RADIUS 伺服器群組](nps-crp-rrsg-configure.md)

連線要求原則是一組條件和設定，可讓網路系統管理員指定哪些遠端驗證撥入使用者服務（RADIUS）伺服器執行連線要求的驗證與授權，執行網路原則伺服器（NPS）的伺服器會從 RADIUS 用戶端接收。 您可以設定連線要求原則，以指定哪些 RADIUS 伺服器用於 RADIUS 帳戶處理。

您可以建立連線要求原則，以便在本機處理從 RADIUS 用戶端傳送的某些 RADIUS 要求訊息（NPS 作為 RADIUS 伺服器使用），而其他類型的訊息則轉送到另一部 RADIUS 伺服器（NPS 用來作為 RADIUS proxy）。

使用連線要求原則時，您可以使用 NPS 做為 RADIUS 伺服器或 RADIUS proxy （根據下列因素）： 

- 一天中的時間和一周的哪一天
- 連接要求中的領域名稱
- 所要求的連線類型
- RADIUS 用戶端的 IP 位址

只有當傳入訊息的設定符合 NPS 上設定的其中一個連線要求原則時，NPS 才會處理或轉送 RADIUS 存取要求訊息。 

如果原則設定相符，而原則要求 NPS 處理訊息，NPS 會作為 RADIUS 伺服器，並驗證和授權連線要求。 如果原則設定相符，而原則要求 NPS 轉送訊息，NPS 會扮演 RADIUS proxy，並將連線要求轉送到遠端 RADIUS 伺服器進行處理。

如果連入 RADIUS 存取要求訊息的設定不符合至少一個連線要求原則，則會將拒絕存取訊息傳送給 RADIUS 用戶端，而嘗試連線到網路的使用者或電腦將會被拒絕存取。

## <a name="configuration-examples"></a>設定範例

下列設定範例會示範如何使用連線要求原則。

### <a name="nps-as-a-radius-server"></a>做為 RADIUS 伺服器的 NPS

預設連線要求原則是唯一設定的原則。 在此範例中，NPS 設定為 RADIUS 伺服器，而且所有連線要求都是由本機 NPS 處理。 NPS 可以驗證和授權其帳戶位於 NPS 網域網域和受信任網域中的使用者。


### <a name="nps-as-a-radius-proxy"></a>做為 RADIUS Proxy 的 NPS

系統會刪除預設連線要求原則，並建立兩個新的連線要求原則，以將要求轉送至兩個不同的網域。 在此範例中，NPS 設定為 RADIUS proxy。 NPS 不會處理本機伺服器上的任何連接要求。 相反地，它會將連接要求轉送到 NPS 或其他設定為遠端 RADIUS 伺服器群組成員的 RADIUS 伺服器。


### <a name="nps-as-both-radius-server-and-radius-proxy"></a>NPS 同時做為 RADIUS 伺服器和 RADIUS proxy

除了預設的連線要求原則之外，還會建立新的連線要求原則，將連線要求轉送到不受信任網域中的 NPS 或其他 RADIUS 伺服器。 在此範例中，proxy 原則會先出現在原則的已排序清單中。 如果連線要求符合 proxy 原則，則會將連線要求轉送到遠端 RADIUS 伺服器群組中的 RADIUS 伺服器。 如果連線要求不符合 proxy 原則，但符合預設的連線要求原則，NPS 會在本機伺服器上處理連接要求。 如果連線要求不符合任一個原則，則會將它捨棄。

### <a name="nps-as-radius-server-with-remote-accounting-servers"></a>NPS 作為具有遠端帳戶管理伺服器的 RADIUS 伺服器

在此範例中，本機 NPS 未設定為執行帳戶處理，而且會修訂預設連線要求原則，以便將 RADIUS 帳戶處理訊息轉送到遠端 RADIUS 伺服器群組中的 NPS 或其他 RADIUS 伺服器。 雖然會轉送帳戶處理訊息，但不會轉送驗證和授權訊息，而且本機 NPS 會針對本機網域和所有信任的網域執行這些功能。


### <a name="nps-with-remote-radius-to-windows-user-mapping"></a>NPS 與 Windows 使用者對應的遠端 RADIUS

在此範例中，NPS 會將驗證要求轉送到遠端 RADIUS 伺服器，並使用本機 Windows 使用者帳戶進行授權，以作為每個個別連線要求的 radius 伺服器和 RADIUS proxy。 此設定的執行方式是將遠端 RADIUS 設定為 Windows 使用者對應屬性，做為連線要求原則的條件。 （此外，在本機建立的使用者帳戶必須與遠端使用者帳戶名稱相同，以供遠端 RADIUS 伺服器執行驗證。）

## <a name="connection-request-policy-conditions"></a>連線要求原則條件

連線要求原則條件是一或多個 RADIUS 屬性，與連入 RADIUS 存取要求訊息的屬性相比較。 如果有多個條件，則連接要求訊息和連線要求原則中的所有條件都必須相符，NPS 才能強制執行原則。


以下是您可以在連線要求原則中設定的可用條件屬性。

### <a name="connection-properties-attribute-group"></a>連接屬性屬性群組

[連接屬性] 屬性群組包含下列屬性。

- **框架通訊協定**。 用來指定連入封包的框架類型。 範例包括點對點通訊協定（PPP）、序列線路網際網路通訊協定（SLIP）、框架轉送和 X。
- **服務類型**。 用來指定所要求的服務類型。 範例包括框架（例如 PPP 連線）和登入（例如 Telnet 連線）。 如需 RADIUS 服務類型的詳細資訊，請參閱 RFC 2865 「遠端驗證撥入使用者服務（RADIUS）」。
- 通道**類型**。 用來指定要求的用戶端所建立的通道類型。 通道類型包含「點對點通道通訊協定」（PPTP）和「第二層通道通訊協定」（L2TP）。

### <a name="day-and-time-restrictions-attribute-group"></a>日期和時間限制屬性群組 

[日期和時間限制] 屬性群組包含 [日期和時間限制] 屬性。 您可以使用這個屬性來指定一周中的哪一天，以及連接嘗試的時間。 日期和時間相對於 NPS 的日期和時間。

### <a name="gateway-attribute-group"></a>閘道屬性群組

[閘道] 屬性群組包含下列屬性。

- **呼叫的工作站識別碼**。 用來指定網路存取伺服器的電話號碼。 此屬性是字元字串。 您可以使用模式比對語法來指定區功能變數代碼。
- **NAS 識別碼**。 用來指定網路存取伺服器的名稱。 此屬性是字元字串。 您可以使用模式比對語法來指定 NAS 識別碼。
- **NAS IPv4 位址**。 用來指定網路存取伺服器（RADIUS 用戶端）的網際網路通訊協定第4版（IPv4）位址。 此屬性是字元字串。 您可以使用模式比對語法來指定 IP 網路。
- **NAS IPv6 位址**。 用來指定網路存取伺服器（RADIUS 用戶端）的網際網路通訊協定第6版（IPv6）位址。 此屬性是字元字串。 您可以使用模式比對語法來指定 IP 網路。
- **NAS 埠類型**。 用來指定存取用戶端所使用的媒體類型。 範例包括類比電話線路（稱為非同步）、整合式服務數位網路（ISDN）、通道或虛擬私人網路（Vpn）、IEEE 802.11 無線和乙太網路交換器。

### <a name="machine-identity-attribute-group"></a>電腦識別屬性群組

機器識別屬性群組包含機器識別屬性。 藉由使用此屬性，您可以指定在原則中用來識別用戶端的方法。

### <a name="radius-client-properties-attribute-group"></a>RADIUS 用戶端屬性屬性群組

[RADIUS 用戶端屬性] 屬性群組包含下列屬性。

- **呼叫站識別碼**。 用來指定呼叫者（存取用戶端）所使用的電話號碼。 此屬性是字元字串。 您可以使用模式比對語法來指定區功能變數代碼。  在 802.1 x 驗證中，MAC 位址通常會填入，並可與用戶端進行比對。  針對 [接受使用者但不驗證認證] 設定連線要求原則時，此欄位通常用於 Mac 位址略過案例。  
- **用戶端易記名稱**。 用來指定要求驗證之 RADIUS 用戶端電腦的名稱。 此屬性是字元字串。 您可以使用模式比對語法來指定用戶端名稱。
- **用戶端 IPv4 位址**。 用來指定網路存取伺服器（RADIUS 用戶端）的 IPv4 位址。 此屬性是字元字串。 您可以使用模式比對語法來指定 IP 網路。
- **用戶端 IPv6 位址**。 用來指定網路存取伺服器的 IPv6 位址（RADIUS 用戶端）。 此屬性是字元字串。 您可以使用模式比對語法來指定 IP 網路。
- **用戶端廠商**。 用來指定要求驗證之網路存取伺服器的廠商。 執行 [路由及遠端存取] 服務的電腦是 Microsoft NAS 製造商。 您可以使用此屬性為不同的 NAS 製造商設定不同的原則。 此屬性是字元字串。 您可以使用模式比對語法。

### <a name="user-name-attribute-group"></a>使用者名稱屬性群組

[使用者名稱] 屬性群組包含 [使用者名稱] 屬性。 藉由使用此屬性，您可以指定使用者名稱或使用者名稱的一部分，而該名稱必須符合 RADIUS 訊息中的存取用戶端所提供的使用者名稱。 此屬性是一個字元字串，通常包含領域名稱和使用者帳戶名稱。 您可以使用模式比對語法來指定使用者名稱。

## <a name="connection-request-policy-settings"></a>連線要求原則設定

連線要求原則設定是套用至連入 RADIUS 訊息的一組屬性。 設定包含下列屬性群組。

- 驗證
- 帳戶處理
- 屬性操作
- 轉送要求
- 進階

下列各節提供有關這些設定的其他詳細資料。

### <a name="authentication"></a>驗證

藉由使用此設定，您可以覆寫所有網路原則中設定的驗證設定，也可以指定連線到您的網路所需的驗證方法與類型。

>[!IMPORTANT]
>如果您在連線要求原則中設定的驗證方法，比您在網路原則中設定的驗證方法低，則會覆寫您在網路原則中設定的更安全的驗證方法。 例如，如果您有一個需要使用受保護的可延伸驗證通訊協定的網路原則-Microsoft 挑戰交握驗證通訊協定第2版 \(PEAP-MS-CHAP v2 @ no__t-1，這是以密碼為基礎的驗證適用于安全無線的方法，而且您也會設定連線要求原則來允許未經驗證的存取，因此不需要使用 PEAP-ms-chap v2 來驗證用戶端。 在此範例中，所有連線到您網路的用戶端都會被授與未經驗證的存取權。

### <a name="accounting"></a>帳戶處理

藉由使用此設定，您可以設定連線要求原則，將帳戶處理資訊轉送到遠端 RADIUS 伺服器群組中的 NPS 或其他 RADIUS 伺服器，讓遠端 RADIUS 伺服器群組執行帳戶處理。

>[!NOTE]
>如果您有多個 RADIUS 伺服器，而且想要將所有伺服器的帳戶處理資訊儲存在一個中央 RADIUS 計量資料庫中，您可以在每個 RADIUS 伺服器上的原則中使用連線要求原則帳戶處理設定，以轉送來自下列位置的帳戶處理資料：所有伺服器到一個 NPS 或其他指定為帳戶處理伺服器的 RADIUS 伺服器。

連線要求原則帳戶處理設定功能與本機 NPS 的帳戶處理設定無關。 換句話說，如果您將本機 NPS 設定為將 RADIUS 帳戶處理資訊記錄到本機檔案或 Microsoft SQL Server 資料庫，不論您是否設定連線要求原則，將會計訊息轉寄到遠端 RADIUS，它都會這麼做。伺服器群組。

如果您想要從遠端（但不是在本機）記錄帳戶處理資訊，您必須將本機 NPS 設定為不執行帳戶處理，同時在連線要求原則中設定帳戶處理，以將計量資料轉送到遠端 RADIUS 伺服器群組。

### <a name="attribute-manipulation"></a>屬性操作

您可以設定一組「尋找和取代」規則，以操作下列其中一個屬性的文字字串。

- 使用者名稱
- 呼叫的工作站識別碼
- 呼叫站識別碼

在 RADIUS 訊息受限於驗證和帳戶處理設定之前，先前的其中一個屬性會進行尋找和取代規則處理。 屬性操作規則只適用于單一屬性。 您無法為每個屬性設定屬性操作規則。 此外，您可以操作的屬性清單是靜態清單;您無法將加入可供操作的屬性清單。

>[!NOTE]
>如果您使用 MS-CHAP v2 驗證通訊協定，則在使用連線要求原則轉送 RADIUS 訊息時，無法操作 [使用者名稱] 屬性。 唯一的例外狀況是使用反斜線（\) 字元，而操作只會影響其左邊的資訊。 反斜線字元通常用來表示功能變數名稱（反斜線字元左邊的資訊）和網域內的使用者帳戶名稱（反斜線字元右邊的資訊）。 在此情況下，只允許修改或取代功能變數名稱的屬性操作規則。

如需如何在 [使用者名稱] 屬性中操作領域名稱的範例，請參閱在[NPS 中使用正則運算式](nps-crp-reg-expressions.md)主題中的「在使用者名稱屬性中操作領域名稱的範例」一節。

### <a name="forwarding-request"></a>轉送要求

您可以設定下列用於 RADIUS 存取要求訊息的轉送要求選項：

- **驗證此伺服器上的要求**。 藉由使用此設定，NPS 會使用 Windows NT 4.0 網域、Active Directory 或本機安全性帳戶管理員（SAM）使用者帳戶資料庫來驗證連線要求。 此設定也會指定 nps 所使用的相符網路原則，以及使用者帳戶的撥入內容，由 NPS 用來授權連線要求。 在此情況下，NPS 會設定為以 RADIUS 伺服器的形式執行。

- 將**要求轉寄到下列遠端 RADIUS 伺服器群組**。 藉由使用此設定，NPS 會將連線要求轉送到您指定的遠端 RADIUS 伺服器群組。 如果 NPS 收到的有效「存取-接受」訊息對應至「存取要求」訊息，則會將連線嘗試視為已驗證和已授權。 在此情況下，NPS 會作為 RADIUS proxy。

- **接受沒有驗證認證的使用者**。 藉由使用此設定，NPS 不會驗證嘗試連線到網路的使用者身分識別，NPS 也不會嘗試驗證使用者或電腦是否有權連線到網路。 當 NPS 設定為允許未經驗證的存取，且收到連線要求時，NPS 會立即傳送接受存取訊息給 RADIUS 用戶端，並將使用者或電腦授與網路存取權。 這項設定適用于某些類型的強制通道，其中的存取用戶端會在驗證使用者認證之前，先進行通道處理。

>[!NOTE]
>當存取用戶端的驗證通訊協定是 MS-CHAP v2 或可延伸驗證通訊協定-傳輸層安全性（EAP-TLS）（兩者都提供相互驗證）時，就無法使用此驗證選項。 在相互驗證中，存取用戶端證明它是驗證服務器（NPS）的有效存取用戶端，而驗證服務器證明它是存取用戶端的有效驗證服務器。 使用此驗證選項時，會傳回「接受存取」訊息。 不過，驗證服務器不會提供對存取用戶端的驗證，而相互驗證也會失敗。

如需如何使用正則運算式來建立路由規則，將具有指定領域名稱的 RADIUS 訊息轉送到遠端 RADIUS 伺服器群組的範例，請參閱使用一般的主題中的「proxy 伺服器的 RADIUS 訊息轉送範例」一節。 [NPS 中的運算式](nps-crp-reg-expressions.md)。

### <a name="advanced"></a>進階

您可以設定 advanced 屬性來指定一系列的 RADIUS 屬性：

- 當 NPS 做為 RADIUS 驗證或帳戶處理伺服器使用時，新增至 RADIUS 回應訊息。 當網路原則和連線要求原則上都有指定的屬性時，在 RADIUS 回應訊息中傳送的屬性會是兩組屬性的組合。
- 當 NPS 做為 RADIUS 驗證或帳戶處理 proxy 使用時，新增至 RADIUS 訊息。 如果屬性已存在於轉送的訊息中，則會以連線要求原則中指定的屬性值取代。 

此外，在 [ **Advanced** ] 類別的 [連線要求原則**設定**] 索引標籤上，有一些可供設定的屬性會提供特殊功能。 例如，當您想要在兩個使用者帳戶資料庫之間分割連接要求的驗證和授權時，可以設定 [**遠端 RADIUS 到 Windows 使用者對應**] 屬性。

[ **Windows 使用者對應的遠端 RADIUS** ] 屬性會指定針對由遠端 radius 伺服器驗證的使用者，進行 windows 授權。 換句話說，遠端 RADIUS 伺服器會針對遠端使用者帳戶資料庫中的使用者帳戶執行驗證，但是本機 NPS 會針對本機使用者帳戶資料庫中的使用者帳戶來授權連接要求。 當您想要允許訪客存取您的網路時，這會很有用。

例如，合作夥伴組織的訪客可以由他們自己的夥伴組織 RADIUS 伺服器進行驗證，然後在您的組織中使用 Windows 使用者帳戶來存取網路上的來賓區域網路（LAN）。

提供特殊功能的其他屬性包括：

- **IPFilter 和 ms-隔離-會話-Timeout**。 當您使用路由及遠端存取 VPN 部署來部署網路存取隔離控制（NAQC）時，會使用這些屬性。
- **Passport-使用者對應-UPN-尾碼**。 這個屬性可讓您使用 Windows Live™ ID 使用者帳號憑證來驗證連接要求。
- 通道 **-標記**。 此屬性會指定當您部署虛擬區域網路（Vlan）時，NAS 應指派連線的 VLAN ID 號碼。

## <a name="default-connection-request-policy"></a>預設連線要求原則

當您安裝 NPS 時，會建立預設的連線要求原則。 此原則具有下列設定。

- 未設定驗證。
- 帳戶處理未設定為將帳戶處理資訊轉送到遠端 RADIUS 伺服器群組。
- 屬性未設定為將連線要求轉送到遠端 RADIUS 伺服器群組的屬性操作規則。
- 已設定轉送要求，以便在本機 NPS 上驗證和授權連線要求。
- 未設定 Advanced 屬性。

預設連線要求原則使用 NPS 做為 RADIUS 伺服器。 若要將執行 NPS 的伺服器設定為 RADIUS proxy，您還必須設定遠端 RADIUS 伺服器群組。 當您使用 [新增連線要求原則] [建立新的連線要求原則] 時，可以建立新的遠端 RADIUS 伺服器群組。 您可以刪除預設連線要求原則，或確認預設連線要求原則是 NPS 所處理的最後一個原則，其方式是將它放在原則的已排序清單中。

>[!NOTE]
>如果 NPS 和遠端存取服務已安裝在同一部電腦上，而遠端存取服務設定為 Windows 驗證和帳戶處理，則遠端存取驗證和帳戶處理要求可能會轉送到 RADIUS 伺服器. 當遠端存取驗證和帳戶處理要求符合設定為將其轉送到遠端 RADIUS 伺服器群組的連線要求原則時，就會發生這種情況。
