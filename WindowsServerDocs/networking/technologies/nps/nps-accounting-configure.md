---
title: 設定網路原則伺服器計量
description: 本主題提供有關 Windows Server 2016 中網路原則伺服器的文字檔和 SQL Server 記錄的資訊。
manager: dougkim
ms.prod: windows-server
ms.technology: networking
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: lizross
author: eross-msft
ms.date: 05/25/2018
ms.openlocfilehash: 26edf4d1ae4a30ccd9219392c7c4ee3604dcdad9
ms.sourcegitcommit: da7b9bce1eba369bcd156639276f6899714e279f
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/26/2020
ms.locfileid: "80316359"
---
# <a name="configure-network-policy-server-accounting"></a>設定網路原則伺服器計量

有三種類型的網路原則伺服器記錄 \(NPS\)：

- **事件記錄**。 主要用於稽核和疑難排解連線嘗試問題。 您可以在 NPS 主控台中取得 NPS 屬性來設定 NPS 事件記錄。

- **將使用者驗證和帳戶處理要求記錄到本機**檔案。 主要用於連線分析及計費用途。 將它做為安全性調查工具也很有用，因為它提供追蹤惡意使用者攻擊後活動的方法。 您可以使用 [帳戶處理] 設定向導來設定本機檔案記錄。

- **將使用者驗證和帳戶處理要求記錄到 MICROSOFT SQL SERVER XML 相容的資料庫**。 用於允許執行 NPS 的多部伺服器擁有一個資料來源。 還可提供使用關聯式資料庫的優點。 您可以使用 [帳戶處理] 設定向導來設定 SQL Server 記錄。

## <a name="use-the-accounting-configuration-wizard"></a>使用帳戶處理設定精靈

藉由使用 [帳戶處理設定]，您可以設定下列四個帳戶處理設定：

- **僅限 SQL 記錄**。 藉由使用這項設定，您可以設定 SQL Server 的資料連結，以允許 NPS 連線到 SQL Server 並將其傳送至資料。 此外，此 wizard 可以在 SQL Server 上設定資料庫，以確保資料庫與 NPS SQL Server 記錄相容。
- **僅限文字記錄**。 藉由使用此設定，您可以設定 NPS 將計量資料記錄到文字檔中。
- **平行記錄**。 藉由使用此設定，您可以設定 SQL Server 的資料連結和資料庫。 您也可以設定文字檔記錄，讓 NPS 同時記錄到文字檔和 SQL Server 資料庫。 
- **具有備份的 SQL 記錄**。 藉由使用此設定，您可以設定 SQL Server 的資料連結和資料庫。 此外，您可以設定 NPS 在 SQL Server 記錄失敗時使用的文字檔記錄。

除了這些設定之外，SQL Server 記錄和文字記錄都可讓您指定 NPS 是否要在記錄失敗時繼續處理連線要求。 您可以在 [本機檔案記錄] 屬性、[SQL server 記錄內容] 和 [執行帳戶處理] 設定向導中的 [**記錄失敗動作] 區段**中指定此項。

### <a name="to-run-the-accounting-configuration-wizard"></a>執行帳戶處理設定向導

若要執行 [帳戶處理設定向導]，請完成下列步驟：

1. 開啟 NPS 主控台或 NPS Microsoft Management Console （MMC）嵌入式管理單元。
2. 在主控台樹中，按一下 [**帳戶**處理]。
3. 在詳細資料窗格的 [**帳戶**處理] 中，按一下 [**設定帳戶**處理]。

## <a name="configure-nps-log-file-properties"></a>設定 NPS 記錄檔屬性

您可以設定網路原則伺服器（NPS）來執行使用者驗證要求、接受存取訊息、拒絕存取訊息、帳戶處理要求和回應，以及週期性遠端驗證撥入使用者服務（RADIUS）帳戶處理狀態更新。 您可以使用這個程式來設定要儲存會計資料的記錄檔。

如需解讀記錄檔的詳細資訊，請參閱[解讀 NPS 資料庫格式記錄](https://technet.microsoft.com/library/cc771748.aspx)檔。

若要避免記錄檔填滿硬碟，強烈建議您將它們保存在非系統磁碟分割的磁碟分割中。 以下提供設定 NPS 帳戶處理的詳細資訊：

- 若要傳送另一個程序收集的記錄檔資料，可以設定 NPS 寫入具名管道。 若要使用具名管道，請將記錄檔資料夾設定為 \\成 .\pipe 或 \\ComputerName\pipe。 具名管道伺服器程式會建立名為的具名管道，\\.\pipe\iaslog.log 以接受資料。 在 [本機檔案內容] 對話方塊的 [建立新的記錄檔] 中，在使用具名管道時選取 [不要 (不限制檔案大小)]。

- 您可以使用系統環境變數 (取代使用者變數) 建立記錄檔目錄，例如 %systemdrive%、%systemroot% 以及 %windir%。 例如，下列使用環境變數% windir% 的路徑，會在子資料夾 \System32\Logs 的系統目錄中尋找記錄檔（亦即，%windir%\System32\Logs\)。

- 切換記錄檔格式不會建立新的記錄。 如果變更記錄檔格式，變更時正在使用中的檔案將包含混合的兩種格式 (記錄開始時的記錄擁有先前格式，記錄結束時的記錄擁有新格式)。

- 如果 RADIUS 帳戶處理因硬碟已滿或其他原因而失敗，NPS 會停止處理連線要求，避免使用者存取網路資源。

- 除了記錄到本機檔案之外，NPS 還提供記錄到 Microsoft® SQL Server™ 資料庫的能力。

若要執行此程式，至少需要**Domain Admins**群組的成員資格。


### <a name="to-configure-nps-log-file-properties"></a>設定 NPS 記錄檔屬性

1. 開啟 NPS 主控台或 NPS Microsoft Management Console （MMC）嵌入式管理單元。
2. 在主控台樹中，按一下 [**帳戶**處理]。
3. 在詳細資料窗格的 [**記錄檔屬性**] 中，按一下 [**變更記錄檔屬性**]。 [**記錄檔屬性**] 對話方塊隨即開啟。
4. 在 [**記錄**檔內容] 的 [**設定**] 索引標籤上，于 [**記錄下列資訊**] 中，確定您已選擇要記錄足夠的資訊以達成您的帳戶處理目標。 例如，如果您的記錄需要完成會話相互關聯，請選取所有核取方塊。
5. 在 [**記錄失敗] 動作**中，如果您想要 NPS 在記錄檔已滿或無法使用時停止處理存取要求訊息，請選取 [**如果記錄失敗，捨棄連接要求**]。 如果您想要 NPS 在記錄失敗時繼續處理連接要求，請勿選取此核取方塊。
6. 在 [**記錄檔屬性**] 對話方塊中，按一下 [**記錄**檔] 索引標籤。
7. 在 [**記錄**檔] 索引標籤的 [**目錄**] 中，輸入您要儲存 NPS 記錄檔的位置。 預設位置是 systemroot\System32\LogFiles 資料夾。<br>如果您未在**記錄檔目錄**中提供完整路徑語句，則會使用預設路徑。 例如，如果您在 [記錄檔**目錄**] 中輸入**npslogfile (** ，此檔案位於%systemroot%\System32\NPSLogFile。
8. 在 [**格式**] 中，按一下 [**符合 DTS 規範**]。 如果您想要的話，可以改為選取舊版的檔案格式，例如**ODBC \(舊版\)** 或**IAS \(舊版\)** 。<br>**ODBC**和**IAS**舊版檔案類型包含 NPS 傳送到其 SQL Server 資料庫的資訊子集。 **DTS 相容**檔案類型的 xml 格式與 NPS 用來將資料匯入其 SQL Server 資料庫的 xml 格式相同。 因此， **DTS 相容**的檔案格式可提供更有效率且完整的資料傳輸到 NPS 的標準 SQL Server 資料庫。
9. 在 [**建立新的記錄**檔] 中，若要設定 NPS 在指定的間隔啟動新的記錄檔，請按一下您想要使用的間隔：
    - 針對繁重的交易量和記錄活動，按一下 [**每天**]。
    - 對於較小的交易量和記錄活動，按一下 [**每週**] 或 [**每月**]。
    - 若要將所有交易儲存在一個記錄檔中，請按一下 **永不 \(無限制的檔案大小\)** 。
    - 若要限制每個記錄檔的大小，請按一下 [**當記錄檔到達此大小**]，然後輸入檔案大小，在此之後就會建立新的記錄檔。 預設大小為 10 MB。
10. 如果您想要 NPS 在硬碟接近容量時，刪除舊的記錄檔來建立新記錄檔的磁碟空間，請確定已選取 [**當磁片已滿時，刪除較舊的記錄**檔]。 此選項無法使用，不過，如果 [**建立新的記錄**檔] 的值永遠不會 **\(無限制的檔案大小\)** 。 此外，如果最舊的記錄檔是目前的記錄檔，則不會刪除它。

## <a name="configure-nps-sql-server-logging"></a>設定 NPS SQL Server 記錄

您可以使用此程式，將 RADIUS 帳戶處理資料記錄到執行 Microsoft SQL Server 的本機或遠端資料庫。

>[!NOTE]
>NPS 會將計量資料格式化為 XML 檔，它會傳送至您在 NPS 中指定的 SQL Server 資料庫中的**report_event**預存程式。 若要讓 SQL Server 記錄正常運作，SQL Server 資料庫中必須有一個名為**report_event**的預存程式，該程式可以從 NPS 接收和剖析 XML 檔。

您至少必須是 Domain Admins 或對等群組的成員，才能完成這項程序。

### <a name="to-configure-sql-server-logging-in-nps"></a>在 NPS 中設定 SQL Server 記錄

1. 開啟 NPS 主控台或 NPS Microsoft Management Console （MMC）嵌入式管理單元。
2. 在主控台樹中，按一下 [**帳戶**處理]。
3. 在詳細資料窗格的 [ **SQL Server 記錄**內容] 中，按一下 [**變更 SQL Server 記錄屬性**]。 [ **SQL Server 記錄屬性**] 對話方塊隨即開啟。
4. 在 **[記錄下列資訊**] 中，選取您想要記錄的資訊： 
    - 若要記錄所有的帳戶處理要求，請按一下 [**帳戶處理要求**]。
    - 若要記錄驗證要求，請按一下 [**驗證要求**]。
    - 若要記錄週期性帳戶處理狀態，請按一下 [**定期帳戶處理狀態**]。
    - 若要記錄週期性狀態（例如暫時帳戶處理要求），請按一下 [**定期狀態**]。
5. 若要設定執行 NPS 的伺服器與 SQL Server 之間允許的並行會話數目，請在 [**並行會話的最大數目**] 中輸入數位。
6. 若要設定 SQL Server 資料來源，請在**SQL Server 記錄**中，按一下 [**設定**]。 [**資料連結屬性**] 對話方塊隨即開啟。 在 [**連接**] 索引標籤上，指定下列各項： 
    - 若要指定資料庫儲存所在的伺服器名稱，請在 [**選取或輸入伺服器名稱**] 中輸入或選取名稱。
    - 若要指定用來登入伺服器的驗證方法，請按一下 [**使用 WINDOWS NT 整合式安全性**]。 或者，按一下 [**使用特定的使用者名稱和密碼**]，然後在 [**使用者名稱**] 和 [**密碼**] 中輸入認證。
    - 若要允許空白密碼，請按一下 [**空白密碼**]。
    - 若要儲存密碼，請按一下 [**允許儲存密碼**]。
    - 若要在執行 SQL Server 的電腦上指定要連接的資料庫，請按一下 [**選取伺服器上的資料庫**]，然後從清單中選取資料庫名稱。
7. 若要測試 NPS 與 SQL Server 之間的連接，請按一下 [**測試**連線]。 按一下 **[確定] 關閉 [** **資料連結屬性**]。
8. 如果您想要 NPS 在 SQL Server 記錄失敗時繼續進行文字檔記錄，請在 [**記錄失敗] 動作**中，選取 [**啟用容錯移轉的文字檔記錄**]。 
9. 在 [**記錄失敗] 動作**中，如果您想要 NPS 在記錄檔已滿或無法使用時停止處理存取要求訊息，請選取 [**如果記錄失敗，捨棄連接要求**]。 如果您想要 NPS 在記錄失敗時繼續處理連接要求，請勿選取此核取方塊。

## <a name="ping-user-name"></a>Ping 使用者名稱

某些 RADIUS proxy 伺服器和網路存取伺服器會定期傳送驗證和帳戶處理要求（稱為 ping 要求），以確認 NPS 是否存在於網路上。 這些 Ping 要求包括虛構的使用者名稱。 當 NPS 處理這些要求時，事件與帳戶處理記錄會被存取拒絕記錄填滿，使得追蹤有效記錄變得更困難。

當您設定**ping 使用者名稱**的登錄專案時，NPS 會比對登錄專案值與其他伺服器的 ping 要求中的使用者名稱值。 **Ping 使用者名稱**登錄專案會指定 RADIUS proxy 伺服器和網路存取伺服器所傳送的虛構使用者名稱（或使用者名稱模式，其中包含符合虛構使用者名稱的變數）。 當 NPS 收到與**ping 使用者名稱**登錄專案值相符的 ping 要求時，nps 會拒絕驗證要求，而不會處理要求。 NPS 不會在任何記錄檔中記錄與虛構使用者名稱有關的交易，這樣事件日誌才比較容易解譯。

預設不會安裝**Ping 使用者名稱**。 您必須將**ping 使用者名稱**新增至登錄。 您可以使用登錄編輯程式將項目新增至登錄中。

>[!CAUTION]
>編輯登錄錯誤可能會嚴重損毀系統。 變更登錄之前，您應該先備份電腦所有的重要資料。

### <a name="to-add-ping-user-name-to-the-registry"></a>將 ping 使用者名稱新增至登錄

本機 Administrators 群組的成員可以將 Ping 使用者名稱新增至下列登錄機碼，做為字串值：

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **名稱**： `ping user-name`
- **類型**： `REG_SZ`
- **資料**：*使用者名稱*

>[!TIP]
>若要為**ping 使用者名稱**值指定一個以上的使用者名稱，請在 [**資料**] 中輸入名稱模式，例如 DNS 名稱，包括萬用字元。
