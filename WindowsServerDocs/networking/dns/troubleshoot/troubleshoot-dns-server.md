---
title: 疑難排解 DNS 伺服器
description: 本文介紹如何從伺服器端針對 DNS 問題進行疑難排解。
manager: dcscontentpm
ms.topic: article
ms.author: delhan
ms.date: 8/8/2019
author: Deland-Han
ms.openlocfilehash: ce4a3f4a183478cd250159f1953a0fd2193f6de6
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/07/2020
ms.locfileid: "87964074"
---
# <a name="troubleshooting-dns-servers"></a>對 DNS 伺服器進行疑難排解

本文討論如何對 DNS 伺服器上的問題進行疑難排解。

## <a name="check-ip-configuration"></a>檢查 IP 設定

1. `ipconfig /all`在命令提示字元中執行，並確認 IP 位址、子網路遮罩和預設閘道。

2. 檢查 DNS 伺服器是否對所查閱的名稱具有授權。 若是如此，請參閱[檢查授權資料的問題](#checking-for-problems-with-authoritative-data)。

3. 執行下列命令：

   ```cmd
   nslookup <name> <IP address of the DNS server>
   ```
   例如：
   ```cmd
   nslookup app1 10.0.0.1
   ```
   如果您收到失敗或超時回應，請參閱[檢查是否有遞迴問題](#checking-for-recursion-problems)。

4. 排清解析程式快取。 若要這麼做，請在系統管理命令提示字元視窗中執行下列命令：

   ```cmd
   dnscmd /clearcache
   ```
   或者，在系統管理 PowerShell 視窗中，執行下列 Cmdlet：
   ```powershell
   Clear-DnsServerCache
   ```

5. 重複步驟3。

## <a name="check-dns-server-problems"></a>檢查 DNS 伺服器問題

### <a name="event-log"></a>事件記錄檔

請檢查下列記錄檔，以查看是否有任何記錄的錯誤：

- Application

- 系統

- DNS 伺服器

### <a name="test-by-using-nslookup-query"></a>使用 nslookup 查詢進行測試

執行下列命令，並檢查是否可從用戶端電腦連線到 DNS 伺服器。

```cmd
nslookup <client name> <server IP address>
```

- 如果解析程式傳回用戶端的 IP 位址，伺服器就不會有任何問題。

- 如果解析程式傳回「伺服器失敗」或「拒絕查詢」的回應，可能是區域已暫停，或伺服器可能超載。 您可以在 DNS 主控台中檢查區域屬性的 [一般] 索引標籤，以瞭解是否已暫停。

如果解析程式傳回「伺服器已超時的要求」或「沒有伺服器的回應」回應，表示 DNS 服務可能未執行。 嘗試重新開機 DNS 伺服器服務，方法是在伺服器上的命令提示字元中輸入下列命令：

```cmd
net start DNS
```

如果在服務執行時發生此問題，伺服器可能不會接聽您在 nslookup 查詢中使用的 IP 位址。 在 DNS 主控台之 [伺服器屬性] 頁面的 [**介面**] 索引標籤上，系統管理員可以限制 dns 伺服器只接聽選取的位址。 如果 DNS 伺服器已設定為將服務限制為其所設定之 IP 位址的特定清單，則用來聯繫 DNS 伺服器的 IP 位址可能不在清單中。 您可以嘗試在清單中使用不同的 IP 位址，或將 IP 位址新增至清單。

在罕見的情況下，DNS 伺服器可能會有先進的安全性或防火牆設定。 如果伺服器位於另一個只能透過轉送主機 (的網路，例如封包篩選路由器或 proxy 伺服器) ，則 DNS 伺服器可能會使用非標準埠來接聽和接收用戶端要求。 根據預設，nslookup 會將查詢傳送至 UDP 埠53上的 DNS 伺服器。 因此，如果 DNS 伺服器使用任何其他埠，nslookup 查詢就會失敗。 如果您認為這可能是問題，請檢查中繼篩選是否刻意用來封鎖知名 DNS 埠上的流量。 如果不是，請嘗試修改防火牆上的封包篩選器或連接埠規則，以允許 UDP/TCP 埠53上的流量。

## <a name="checking-for-problems-with-authoritative-data"></a>檢查授權資料的問題

檢查傳回錯誤回應的伺服器是否為區域的主伺服器 (區域的標準主伺服器，或使用 Active Directory 整合來載入區域的伺服器) 或主控區域次要複本的伺服器。

### <a name="if-the-server-is-a-primary-server"></a>如果伺服器是主伺服器

當使用者在區域中輸入資料時，可能會發生使用者錯誤而造成此問題。 或者，這可能是影響 Active Directory 複寫或動態更新的問題所造成。

### <a name="if-the-server-is-hosting-a-secondary-copy-of-the-zone"></a>如果伺服器裝載區域的次要複本

1. 檢查主伺服器上的區域， (這部伺服器從中提取區域轉送) 的伺服器。

   > [!NOTE]
   >您可以在 DNS 主控台中檢查次要區域的內容，以判斷哪一部伺服器為主伺服器。

   如果主伺服器上的名稱不正確，請移至步驟4。

2. 如果主伺服器上的名稱正確，請檢查主伺服器上的序號是否小於或等於次要伺服器上的序號。 如果是，請修改主伺服器或次要伺服器，讓主伺服器上的序號大於次要伺服器上的序號。

3. 在次要伺服器上，強制從 DNS 主控台內或藉由執行下列命令來進列區域轉送：

   ```cmd
   dnscmd /zonerefresh <zone name>
   ```

   例如，如果區域是 corp.contoso.com，請輸入： `dnscmd /zonerefresh corp.contoso.com` 。

4. 再次檢查次要伺服器，以查看是否已正確傳輸區域。 如果沒有，您可能會遇到區域轉送問題。 如需詳細資訊，請參閱[區域傳輸問題](#zone-transfer-problems)。

5. 如果已正確地傳輸區域，請檢查資料是否現在正確。 如果不是，則主要區域中的資料不正確。 當使用者在區域中輸入資料時，可能會發生使用者錯誤而造成此問題。 或者，這可能是影響 Active Directory 複寫或動態更新的問題所造成。

## <a name="checking-for-recursion-problems"></a>檢查遞迴問題

若要讓遞迴順利執行，遞迴查詢的路徑中使用的所有 DNS 伺服器都必須能夠回應和轉送正確的資料。 如果無法這麼做，遞迴查詢可能會因為下列任何原因而失敗：

- 查詢會在完成之前就超時。

- 查詢期間所使用的伺服器無法回應。

- 查詢期間使用的伺服器提供不正確的資料。

開始在原始查詢中使用的伺服器上進行疑難排解。 檢查 DNS 主控台中伺服器屬性的 [轉寄站] 索引標籤，以檢查此伺服器**是否將查詢**轉送到另一部伺服器。 如果已選取 [**啟用**轉寄站] 核取方塊，而且列出一或多部伺服器，此伺服器會轉送查詢。

如果此伺服器將查詢轉送到另一部伺服器，請檢查是否有影響此伺服器轉送查詢之伺服器的問題。 若要檢查是否有問題，請參閱[檢查 DNS 伺服器問題](#check-dns-server-problems)。 當該區段指示您在用戶端上執行工作時，請改為在伺服器上執行。

如果伺服器狀況良好且可轉寄查詢，請重複此步驟，並檢查此伺服器轉送查詢的目標伺服器。

如果此伺服器不會將查詢轉送到另一部伺服器，請測試此伺服器是否可以查詢根功能變數名稱伺服器。 若要這樣做，請執行下列命令：

```cmd
nslookup
server <IP address of server being examined>
set q=NS
 ```

- 如果解析程式傳回根功能變數名稱伺服器的 IP 位址，您可能會在根伺服器與您嘗試解析的名稱或 IP 位址之間有中斷的委派。 請遵循[測試中斷的委派](#test-a-broken-delegation)程式來判斷您有中斷委派的位置。

- 如果解析程式傳回「對伺服器超時的要求」回應，請檢查根提示是否指向正常運作的根功能變數名稱伺服器。 若要這麼做，請使用[來查看目前的根提示](#to-view-the-current-root-hints)程式。 如果根提示指向正常運作的根功能變數名稱伺服器，您可能會有網路問題，或者伺服器可能會使用可防止解析程式查詢伺服器的先進防火牆設定，如[檢查 DNS 伺服器問題](#check-dns-server-problems)一節中所述。 遞迴超時預設值也可能太短。

### <a name="test-a-broken-delegation"></a>測試中斷的委派

藉由查詢有效的根功能變數名稱伺服器，開始執行下列程式中的測試。 此測試會帶您逐步執行一項程式，將所有的 DNS 伺服器從根目錄向下查詢到您要測試的伺服器是否有中斷的委派。

1. 在您要測試之伺服器上的命令提示字元中，輸入下列內容：

   ```cmd
   nslookup
   server <server IP address>
   set norecursion
   set querytype= <resource record type>
   <FQDN>
   ```
   > [!NOTE]
   >資源記錄類型是您在原始查詢中查詢的資源記錄類型，而 FQDN 則是您查詢 (以) 期間終止的 FQDN。

2. 如果回應包含委派伺服器的「NS」和「A」資源記錄的清單，請針對每部伺服器重複步驟1，並使用「A」資源記錄中的 IP 位址做為伺服器 IP 位址。

   - 如果回應未包含「NS」資源記錄，則您會有中斷的委派。

   - 如果回應包含「NS」資源記錄，但沒有「A」資源記錄，請輸入**set 遞迴**，並針對「NS」記錄中所列伺服器的「A」資源記錄個別進行查詢。 如果您在區域中找不到每個 NS 資源記錄的 "A" 資源記錄至少有一個有效的 IP 位址，您就會有一個中斷的委派。

3. 如果您判斷有中斷的委派，請使用委派區域的正確 DNS 伺服器的有效 IP 位址，在父區域中新增或更新「A」資源記錄來修正此問題。

### <a name="to-view-the-current-root-hints"></a>若要查看目前的根提示

1. 啟動 DNS 主控台。

2. 新增或連接至失敗遞迴查詢的 DNS 伺服器。

3. 以滑鼠右鍵按一下伺服器，然後選取 [**屬性**]。

4. 按一下 [根提示]。

檢查根伺服器的基本連線能力。

- 如果根提示顯示為正確設定，請確認失敗名稱解析中使用的 DNS 伺服器可以透過 IP 位址 ping 根伺服器。

- 如果根功能變數名稱伺服器沒有以 IP 位址回應 ping，則根功能變數名稱伺服器的 IP 位址可能已變更。 不過，不常看到根功能變數名稱伺服器的重新設定。

## <a name="zone-transfer-problems"></a>區域轉送問題

執行下列檢查：

- 檢查主要和次要 DNS 伺服器的事件檢視器。

- 檢查主伺服器，查看它是否拒絕傳送安全性傳輸。

- 在 DNS 主控台中，檢查區域屬性的 [**區域傳輸**] 索引標籤。 如果伺服器限制區域傳輸到伺服器清單（例如 [區域] 內容的 [**名稱伺服器**] 索引標籤上所列的），請確定次要伺服器位於該清單上。 請確定伺服器已設定為傳送區域轉送。

- 遵循[檢查 DNS 伺服器問題](#check-dns-server-problems)一節中的步驟，檢查主伺服器是否有問題。 當系統提示您在用戶端上執行工作時，請改為在次要伺服器上執行此工作。

- 檢查次要伺服器是否正在執行另一部 DNS 伺服器（例如 BIND）。 如果是，問題可能是下列其中一個原因：

  - Windows 主伺服器可能設定為傳送快速區域轉送，但協力廠商次要伺服器可能不支援快速區域轉送。 如果是這種情況，請在伺服器屬性的 [ **Advanced** ] 索引標籤上，選取 [**啟用**系結次要] 核取方塊，以停用主伺服器上的快速區域轉送。

  - 如果 Windows server 上的正向對應區域包含記錄類型 (例如，次要伺服器不支援的 SRV 記錄) ，則次要伺服器可能會在提取區域時發生問題。

檢查主伺服器是否正在執行另一個 DNS 伺服器（例如 BIND）。 若是如此，主伺服器上的區域可能包含不相容的 Windows 無法辨識的資源記錄。

如果主要或次要伺服器正在執行另一部 DNS 伺服器，請檢查這兩部伺服器，確定其支援相同的功能。 您可以在伺服器的 [內容] 頁面的 [ **Advanced** ] 索引標籤上，檢查 DNS 主控台中的 Windows server。 除了 [啟用系結次要複本] 方塊以外，此頁面還包含 [**名稱檢查**] 下拉式清單。 這可讓您選取對 DNS 名稱中的字元強制執行嚴格的 RFC 合規性。

