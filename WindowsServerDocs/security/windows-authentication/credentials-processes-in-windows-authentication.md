---
title: Windows 驗證中的認證程序
description: Windows Server 安全性
ms.prod: windows-server
ms.technology: security-windows-auth
ms.topic: article
ms.assetid: 48c60816-fb8b-447c-9c8e-800c2e05b14f
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/12/2016
ms.openlocfilehash: 2de8383ce6a946dfdd80cfc027478c495037169b
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/08/2020
ms.locfileid: "80857581"
---
# <a name="credentials-processes-in-windows-authentication"></a>Windows 驗證中的認證程序

>適用於：Windows Server (半年通道)、Windows Server 2016

這個適用于 IT 專業人員的參考主題說明 Windows 驗證如何處理認證。

Windows 認證管理是作業系統從服務或使用者接收認證，並保護該資訊以供未來呈現驗證目標的程式。 如果是已加入網域的電腦，驗證目標就是網域控制站。 用於驗證的認證是數位檔，可將使用者的身分識別與某種形式的真品證明（例如憑證、密碼或 PIN）產生關聯。

根據預設，Windows 認證會針對本機電腦上的安全性帳戶管理員（SAM）資料庫進行驗證，或透過 Winlogon 服務，針對加入網域的電腦上的 Active Directory 進行驗證。 認證會透過登入使用者介面上的使用者輸入來收集，或透過應用程式開發介面（API）以程式設計方式來呈現，以提供給驗證目標。

本機安全性資訊儲存在登錄中**HKEY_LOCAL_MACHINE \security**底下。 儲存的資訊包括原則設定、預設安全性值，以及帳戶資訊，例如快取的登入認證。 SAM 資料庫的複本也會儲存在這裡，雖然它是有寫入保護的。

下圖顯示所需的元件，以及認證通過系統來驗證使用者或進程以成功登入的路徑。

![此圖顯示所需的元件，以及認證通過系統來驗證使用者或進程以成功登入的路徑。](../media/credentials-processes-in-windows-authentication/AuthN_LSA_Architecture_Client.gif)

下表描述在登入時管理驗證程式中的認證的每個元件。

**所有系統的驗證元件**

|Component|描述|
|-------|--------|
|使用者登入|Winlogon 是負責管理安全使用者互動的可執行檔。 Winlogon 服務會藉由將使用者動作在安全桌面（登入 UI）所收集的認證傳遞給本地安全機構（LSA）到 Secur32，來起始 Windows 作業系統的登入程式。|
|應用程式登入|不需要互動式登入的應用程式或服務登入。 使用者所起始的大部分進程都會使用 Secur32 以使用者模式執行，而在啟動時起始的進程（例如服務）則是使用 Ksecdd 以核心模式執行。<p>如需使用者模式和核心模式的詳細資訊，請參閱本主題中的應用程式和使用者模式或服務和核心模式。|
|Secur32.dll|形成驗證程式基礎的多個驗證提供者。|
|Lsasrv.dll|LSA 伺服器服務，這兩者都會強制執行安全性原則，並作為 LSA 的安全性套件管理員。 LSA 包含 Negotiate 函式，此函式會在判斷哪一個通訊協定成功之後，選取 NTLM 或 Kerberos 通訊協定。|
|安全性支援提供者|一組可個別叫用一或多個驗證通訊協定的提供者。 預設的提供者集合可能會隨著 Windows 作業系統的每個版本而變更，而且可以寫入自訂提供者。|
|Netlogon.dll|Net Logon 服務執行的服務如下所示：<p>-維護電腦的安全通道（不要與 Schannel 混淆）到網域控制站。<br />-透過安全通道將使用者的認證傳遞至網域控制站，並傳回使用者的網域安全識別碼（Sid）和使用者權限。<br />-在網域名稱系統（DNS）中發佈服務資源記錄，並使用 DNS 將名稱解析成網域控制站的網際網路通訊協定（IP）位址。<br />-根據用於同步處理主域控制站（Pdc）和備份網域控制站（Bdc）的遠端程序呼叫（RPC），來執行複寫通訊協定。|
|Samsrv .dll|儲存本機安全性帳戶的安全性帳戶管理員（SAM）會強制執行本機儲存的原則，並支援 Api。|
|登錄|登錄包含 SAM 資料庫的複本、本機安全性原則設定、預設的安全性值，以及只有系統可存取的帳戶資訊。|

本主題包含下列各節：

-   [使用者登入的認證輸入](#BKMK_CrentialInputForUserLogon)

-   [應用程式和服務登入的認證輸入](#BKMK_CredentialInputForApplicationAndServiceLogon)

-   [本地安全機構](#BKMK_LSA)

-   [快取的認證和驗證](#BKMK_CachedCredentialsAndValidation)

-   [認證儲存和驗證](#BKMK_CredentialStorageAndValidation)

-   [安全性帳戶管理員資料庫](#BKMK_SAM)

-   [本機網域和受信任的網域](#BKMK_LocalDomainsAndTrustedDomains)

-   [Windows 驗證中的憑證](#BKMK_CertificatesInWindowsAuthentication)

## <a name="credential-input-for-user-logon"></a><a name="BKMK_CrentialInputForUserLogon"></a>使用者登入的認證輸入
在 Windows Server 2008 和 Windows Vista 中，已使用認證提供者模型取代圖形化識別和驗證（GINA）架構，讓您可以透過使用登入磚來列舉不同的登入類型。 以下說明這兩種模型。

**圖形化識別和驗證架構**

圖形化識別和驗證（GINA）架構適用于 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Windows 2000 Professional 作業系統。 在這些系統中，每個互動式登入會話都會建立個別的 Winlogon 服務實例。 GINA 架構會載入至 Winlogon 所使用的進程空間、接收和處理認證，並透過 LSALogonUser 對驗證介面進行呼叫。

在會話0中執行互動式登入的 Winlogon 實例。 會話0會主控系統服務和其他重要的程式，包括本地安全機構（LSA）處理常式。

下圖顯示 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Microsoft Windows 2000 Professional 的認證程式。

![此圖顯示 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Microsoft Windows 2000 Professional 的認證程式](../media/credentials-processes-in-windows-authentication/AuthN_GINA_Architecture.gif)

**認證提供者架構**

認證提供者架構適用于本主題開頭的**適用**物件清單中指定的版本。 在這些系統中，認證輸入架構會使用認證提供者變更為可擴充的設計。 這些提供者是由安全桌面上的不同登入磚所表示，可允許任何數目的登入案例-相同使用者的不同帳戶和不同的驗證方法，例如密碼、智慧卡和生物識別。

使用認證提供者架構時，Winlogon 一律會在收到安全的注意順序事件之後啟動登入 UI。 登入 UI 會針對提供者設定要列舉的不同認證類型數目，查詢每個認證提供者。 認證提供者可以選擇指定其中一個磚做為預設值。 所有提供者列舉其磚之後，登入 UI 就會向使用者顯示。 使用者會與磚互動以提供其認證。 登入 UI 會提交這些認證以進行驗證。

認證提供者不是強制執行機制。 它們可用來收集和序列化認證。 「本地安全機構」和「驗證」套件會強制執行安全性。

認證提供者會在電腦上註冊，並負責下列各項：

-   描述驗證所需的認證資訊。

-   使用外部驗證授權單位來處理通訊和邏輯。

-   封裝認證以進行互動式和網路登入。

封裝認證以進行互動式和網路登入，包括序列化的進程。 藉由序列化認證，可以在登入 UI 上顯示多個登入磚。 因此，您的組織可以透過使用自訂的認證提供者，控制登入顯示，例如使用者、用於登入的目標系統、網路和工作站鎖定/解除鎖定原則的預先登錄存取。 多個認證提供者可以共存于同一部電腦上。

單一登入（SSO）提供者可以開發做為標準認證提供者，或做為預先登入存取提供者。

Windows 的每個版本都包含一個預設的認證提供者，以及一個預設的預先登入存取提供者（PLAP），也稱為 SSO 提供者。 SSO 提供者可讓使用者在登入本機電腦之前，先連接到網路。 當此提供者執行時，提供者不會列舉登入 UI 上的磚。

SSO 提供者的目的是要用於下列案例：

-   **網路驗證和電腦登入是由不同的認證提供者處理。** 此案例的變化包括：

    -   使用者可以選擇連線到網路，例如連接到虛擬私人網路（VPN），然後再登入電腦，但不需要進行此連線。

    -   需要網路驗證，才能抓取在本機電腦上進行互動式驗證時所使用的資訊。

    -   有多個網路驗證，接著是其中一個其他案例。 例如，使用者向網際網路服務提供者（ISP）進行驗證、向 VPN 驗證，然後使用其使用者帳號憑證來登入本機。

    -   已停用快取的認證，在本機登入驗證使用者之前，需要透過 VPN 進行遠端存取服務連線。

    -   網域使用者未在已加入網域的電腦上設定本機帳戶，必須先透過 VPN 連線建立遠端存取服務連線，才能完成互動式登入。

-   **網路驗證和電腦登入是由相同的認證提供者處理。** 在此案例中，使用者必須先連接到網路，才能登入電腦。

**登入磚列舉**

認證提供者會列舉下列實例中的登入磚：

-   針對在本主題開頭的**適用**物件清單中指定的作業系統。

-   認證提供者會列舉用於工作站登入的磚。 認證提供者通常會將驗證的認證序列化至本地安全機構。 此程式會顯示每個使用者特定的圖格，以及每個使用者的目標系統特定的磚。

-   登入和驗證架構可讓使用者使用認證提供者所列舉的磚來解除鎖定工作站。 通常，目前登入的使用者是預設的磚，但如果有多個使用者登入，則會顯示許多磚。

-   認證提供者會列舉磚以回應使用者要求，以變更其密碼或其他私人資訊，例如 PIN。 通常，目前登入的使用者是預設的磚;不過，如果有一位以上的使用者登入，則會顯示許多磚。

-   認證提供者會根據要用於遠端電腦驗證的序列化認證來列舉磚。 認證 UI 不會使用與登入 UI、解除鎖定工作站或變更密碼相同的提供者實例。 因此，在認證 UI 的實例之間，無法在提供者中維護狀態資訊。 此結構會針對每一部遠端電腦登入產生一個磚，假設認證已正確地序列化。 此案例也用於使用者帳戶控制（UAC），這有助於防止未經授權的電腦變更，方法是先提示使用者提供許可權或系統管理員密碼，再允許可能影響電腦操作的動作，或變更影響電腦其他使用者的設定。

下圖顯示本主題開頭的 [**適用**于] 清單中指定之作業系統的認證處理常式。

![此圖顯示在本主題開頭的 * * 適用于 * * 清單中指定之作業系統的認證處理常式](../media/credentials-processes-in-windows-authentication/AuthN_CredMan_CredProv.gif)

## <a name="credential-input-for-application-and-service-logon"></a><a name="BKMK_CredentialInputForApplicationAndServiceLogon"></a>應用程式和服務登入的認證輸入
Windows 驗證的設計目的是要管理不需要使用者互動的應用程式或服務認證。 使用者模式中的應用程式會根據其可存取的系統資源而受到限制，而服務可以對系統記憶體和外部裝置具有不受限制的存取權。

系統服務和傳輸層級應用程式會透過 Windows 中的安全性支援提供者介面（SSPI）存取安全性支援提供者（SSP），這會提供函式來列舉系統上可用的安全性套件、選取套件，以及使用該封裝來取得已驗證的連線。

當用戶端/伺服器連線已通過驗證時：

-   連接之用戶端上的應用程式會使用 SSPI 函數 `InitializeSecurityContext (General)`，將認證傳送至伺服器。

-   連接的伺服器端上的應用程式會以 `AcceptSecurityContext (General)`的 SSPI 函式來回應。

-   `InitializeSecurityContext (General)` 和 `AcceptSecurityContext (General)` 的 SSPI 函式會重複，直到所有必要的驗證訊息都已交換為成功或失敗驗證為止。

-   連接經過驗證之後，伺服器上的 LSA 會使用來自用戶端的資訊來建立安全性內容，其中包含存取權杖。

-   接著，伺服器可以呼叫 SSPI 函數 `ImpersonateSecurityContext`，將存取權杖附加至服務的模擬執行緒。

**應用程式和使用者模式**

Windows 中的使用者模式是由兩個可將 i/o 要求傳遞至適當核心模式驅動程式的系統所組成：環境系統，它會執行為許多不同類型的作業系統所撰寫的應用程式，以及可代表環境系統運作系統特定功能的整數系統。

整數系統會代表環境系統管理操作 system'specific 功能，並包含安全性系統進程（LSA）、工作站服務和伺服器服務。 安全性系統程式會處理安全性權杖、授與或拒絕許可權來存取以資源許可權為基礎的使用者帳戶、處理登入要求並起始登入驗證，並決定作業系統需要進行哪些系統資源的審核。

應用程式可以在使用者模式中執行，應用程式可以在其中以任何主體的形式執行，包括本機系統（系統）的安全性內容。 應用程式也可以在核心模式中執行，應用程式可以在本機系統（系統）的安全性內容中執行。

SSPI 可透過 Secur32 模組取得，這是用來取得整合式安全性服務以進行驗證、訊息完整性和訊息隱私權的 API。 它提供應用層級通訊協定與安全性通訊協定之間的抽象層。 由於不同的應用程式需要不同的方式來識別或驗證使用者，以及在透過網路傳送時加密資料的不同方式，因此 SSPI 提供了一種方法來存取包含不同驗證和密碼編譯功能的動態連結程式庫（Dll）。 這些 Dll 稱為安全性支援提供者（Ssp）。

受管理的服務帳戶和虛擬帳戶是在 Windows Server 2008 R2 和 Windows 7 中引進，以提供重要的應用程式，例如 Microsoft SQL Server 和 Internet Information Services （IIS），並隔離自己的網域帳戶，同時不需要系統管理員手動管理服務主體名稱（SPN）和這些帳戶的認證。 如需這些功能及其在驗證中之角色的詳細資訊，請參閱[Windows 7 和 Windows Server 2008 R2 的受管理的服務帳戶檔](https://technet.microsoft.com/library/ff641731(v=ws.10).aspx)和[群組受管理的服務帳戶總覽](../group-managed-service-accounts/group-managed-service-accounts-overview.md)。

**服務和核心模式**

雖然大部分的 Windows 應用程式都是在啟動的使用者的安全性內容中執行，但這對服務來說並不是如此。 當使用者啟動電腦時，服務控制器會啟動許多 Windows 服務（例如網路和列印服務）。 這些服務可能會以本機服務或本機系統的身分執行，而且可能會在使用者最後一次登出後繼續執行。

> [!NOTE]
> 服務通常會在稱為本機系統（系統）、網路服務或本機服務的安全性內容中執行。  Windows Server 2008 R2 引進了以受管理的服務帳戶（也就是網域主體）執行的服務。

在啟動服務之前，服務控制器會使用針對服務所指定的帳號登入，然後提供服務的認證以供 LSA 進行驗證。 Windows 服務會執行程式設計介面，供服務控制器管理員用來控制服務。 Windows 服務可以在系統啟動時自動啟動，或使用服務控制程式手動啟動。 例如，當 Windows 用戶端電腦加入網域時，電腦上的 messenger 服務會連線到網域控制站，並開啟它的安全通道。 若要取得已驗證的連線，服務必須擁有遠端電腦的本地安全機構（LSA）信任的認證。 與網路中的其他電腦通訊時，LSA 會使用本機電腦網域帳戶的認證，如同在本機系統和網路服務的安全性內容中執行的所有其他服務一樣。 本機電腦上的服務是以系統的身分執行，因此不需要向 LSA 呈現認證。

Ksecdd 檔案會管理和加密這些認證，並在 LSA 中使用本機程序呼叫。 檔案類型為 WINSPOOL.DRV （驅動程式），也稱為核心模式安全性支援提供者（SSP），而在本主題開頭的 [**適用于**] 清單中指定的版本，則為 FIPS 140-2 層級1相容。

核心模式具有電腦的硬體和系統資源的完整存取權。 核心模式會阻止使用者模式服務和應用程式存取不應存取之作業系統的重要區域。

## <a name="local-security-authority"></a><a name="BKMK_LSA"></a>本地安全機構
「本地安全機構」（LSA）是一個受保護的系統程式，可在本機電腦上驗證和登入使用者。 此外，LSA 也會維護電腦上本機安全性的所有層面（這些層面統稱為本機安全性原則）的相關資訊，並提供在名稱和安全識別碼（Sid）之間進行轉譯的各種服務。 安全性系統程式（本地安全機構伺服器服務（LSASS））會追蹤安全性原則，以及在電腦系統上生效的帳戶。

LSA 會根據發出使用者帳戶的下列兩個實體中的哪一個來驗證使用者的身分識別：

-   **本地安全機構。** LSA 可以藉由檢查位於同一部電腦上的安全性帳戶管理員（SAM）資料庫來驗證使用者資訊。 任何工作站或成員伺服器都可以儲存本機使用者帳戶和本機群組的相關資訊。 不過，這些帳戶只能用來存取工作站或電腦。

-   **本機網域或受信任網域的安全性授權單位。** LSA 會聯繫發出帳戶的實體，並要求驗證帳戶是否有效，以及要求是否源自帳戶持有者。

本機安全性授權子系統服務 (LSASS) 會代表使用中 Windows 工作階段的使用者，將認證儲存在記憶體中。 預存認證可讓使用者順暢地存取網路資源（例如檔案共用、Exchange Server 信箱和 SharePoint 網站），而不必為每個遠端服務重新輸入其認證。

LSASS 可以使用多種形式儲存認證，包括：

-   可回復的已加密純文字

-   Kerberos 票證（票證授權票證（Tgt），服務票證）

-   NT 雜湊

-   LAN Manager （LM）雜湊

如果使用者使用智慧卡登入 Windows，LSASS 不會儲存純文字密碼，但會儲存該帳戶的對應 NT 雜湊值和智慧卡的純文字 PIN。 如果為互動式登入所需的智慧卡啟用帳戶屬性，則會為帳戶自動產生隨機 NT 雜湊值，而不是原始的密碼雜湊。 設定屬性時自動產生的密碼雜湊不會變更。

如果使用者使用與 LAN Manager （LM）雜湊相容的密碼登入 Windows 電腦，則記憶體中會有此驗證器。

您不能停用在記憶體中純文字認證的儲存體，即使需要它們的認證提供者已被停用。

預存認證會直接與上一次重新開機之後啟動且尚未關閉的本機安全性授權子系統服務（LSASS）登入會話產生關聯。 例如，當使用者執行下列其中一項動作時，會建立具有儲存的 LSA 認證的 LSA 工作階段：

-   登入電腦上的本機會話或遠端桌面通訊協定（RDP）會話

-   使用 [RunAs] 選項執行工作

-   在電腦上執行使用中的 Windows 服務

-   執行排程的工作或批次工作

-   使用遠端系統管理工具在本機電腦上執行工作

在某些情況下，LSA 秘密（也就是只能供系統帳戶處理常式存取的秘密資料片段）會儲存在硬碟上。 部分這些密碼是重新開機後必須保留的認證，它們是以加密形式儲存在硬碟上。 儲存為 LSA 密碼的認證可能包括：

-   電腦的 Active Directory Domain Services （AD DS）帳戶的帳戶密碼

-   電腦上設定的 Windows 服務的帳戶密碼

-   已設定排程工作的帳戶密碼

-   IIS 應用程式集區及網站的帳戶密碼

-   Microsoft 帳戶的密碼

在 Windows 8.1 中引進的用戶端作業系統會為 LSA 提供額外的保護，以防止未受保護的進程讀取記憶體和插入程式碼。 這種保護會針對 LSA 儲存和管理的認證增加安全性。

如需這些額外保護的詳細資訊，請參閱設定[其他 LSA 保護](../credentials-protection-and-management/configuring-additional-lsa-protection.md)。

## <a name="cached-credentials-and-validation"></a><a name="BKMK_CachedCredentialsAndValidation"></a>快取的認證和驗證
驗證機制會依賴登入時的認證呈現方式。 不過，當電腦與網域控制站中斷連線，而且使用者正在出示網域認證時，Windows 會使用驗證機制中快取認證的程式。

每次使用者登入網域時，Windows 會快取所提供的認證，並將其儲存在作業系統登錄中的安全性 hive 中。

使用快取的認證時，使用者可以登入網域成員，而不需要連線到該網域內的網域控制站。


## <a name="credential-storage-and-validation"></a><a name="BKMK_CredentialStorageAndValidation"></a>認證儲存和驗證
您不一定要使用一組認證來存取不同的資源。 例如，在存取遠端伺服器時，系統管理員可能會想要使用管理而不是使用者認證。 同樣地，如果使用者存取外部資源（例如銀行帳戶），則他或她只能使用不同于其網域認證的認證。 下列各節說明目前版本的 Windows 作業系統與 Windows Vista 和 Windows XP 作業系統之間的認證管理差異。

### <a name="remote-logon-credential-processes"></a>遠端登入認證進程
遠端桌面通訊協定（RDP）會使用 Windows 8 中引進的遠端桌面用戶端，來管理連線到遠端電腦之使用者的認證。 純文字格式的認證會傳送到主機嘗試執行驗證程式的目標主機，如果成功，則會將使用者連接到允許的資源。 RDP 不會將認證儲存在用戶端上，但是使用者的網域認證會儲存在 LSASS 中。

在 Windows Server 2012 R2 和 Windows 8.1 中引進，受限制的系統管理模式會為遠端登入案例提供額外的安全性。 這種遠端桌面模式會導致用戶端應用程式以 NT 單向函式（NTOWF）執行網路登入挑戰回應，或在驗證遠端主機時使用 Kerberos 服務票證。 系統管理員通過驗證之後，在 LSASS 中並沒有個別的帳號憑證，因為它們並未提供給遠端主機。 相反地，系統管理員會擁有會話的電腦帳號憑證。 系統管理員認證不會提供給遠端主機，因此會以電腦帳戶的身分執行動作。 資源也會限制為電腦帳戶，而系統管理員無法使用自己的帳戶來存取資源。

### <a name="automatic-restart-sign-on-credential-process"></a>自動重新開機登入認證進程
當使用者登入 Windows 8.1 裝置時，LSA 會將使用者認證儲存在只能由 LSASS.EXE 存取的加密記憶體中。 當 Windows Update 起始自動重新開機而沒有使用者目前狀態時，這些認證會用來設定使用者的自動登入。

重新開機時，使用者會自動透過自動登入機制登入，然後電腦會另外鎖定以保護使用者的會話。 鎖定是透過 Winlogon 起始，而認證管理則是由 LSA 來完成。 藉由在主控台上自動登入和鎖定使用者的會話，使用者的鎖定畫面應用程式將會重新開機並可供使用。

如需 ARSO 的詳細資訊，請參閱[Winlogon 自動重新開機&#40;登&#41;入 ARSO](winlogon-automatic-restart-sign-on-arso.md)。

### <a name="stored-user-names-and-passwords-in-windows-vista-and-windows-xp"></a>Windows Vista 和 Windows XP 中的預存使用者名稱和密碼
在 Windows Server 2008、Windows Server 2003、Windows Vista 和 Windows XP 中，[控制台] 中**儲存的使用者名稱和密碼**可簡化管理和使用多個登入認證，包括用於智慧卡和 Windows Live 認證的 x.509 憑證（現在稱為 Microsoft 帳戶）。 認證-使用者設定檔的一部分會儲存到需要的位置。 這個動作可以藉由確保如果有一項密碼遭到入侵，而不會危及所有安全性，以每個資源為基礎來提高安全性。

使用者登入並嘗試存取其他受密碼保護的資源（例如伺服器上的共用），而且如果使用者的預設登入認證不足以取得存取權，就會查詢**儲存的使用者名稱和密碼**。 如果已將具有正確登入資訊的替代認證儲存在**儲存的使用者名稱和密碼**中，就會使用這些認證來取得存取權。 否則，系統會提示使用者提供新的認證，之後可以在登入會話或後續會話期間，儲存以供重複使用。

適用下列限制：

-   如果**儲存的使用者名稱和密碼**包含對特定資源無效或不正確的認證，則會拒絕對資源的存取，而且不會出現 [已**儲存的使用者名稱和密碼**] 對話方塊。

-   **儲存的使用者名稱和密碼**只會儲存 NTLM、Kerberos 通訊協定、Microsoft 帳戶（先前稱為 WINDOWS Live ID）和安全通訊端層（SSL）驗證的認證。 某些版本的 Internet Explorer 會維護自己的快取，以進行基本驗證。

這些認證會成為使用者本機設定檔在 \Documents 和 Settings\Username\Application Data\Microsoft\Credentials 目錄中的加密部分。 因此，如果使用者的網路原則支援漫遊使用者設定檔，這些認證就可以與使用者漫遊。 不過，如果使用者在兩部不同的電腦上有已**儲存之使用者名稱和密碼**的副本，並變更與其中一部電腦上的資源相關聯的認證，則變更不會傳播到第二部電腦上**儲存的使用者名稱和密碼**。

### <a name="windows-vault-and-credential-manager"></a>Windows 保存庫和認證管理員
認證管理員是在 Windows Server 2008 R2 和 Windows 7 中引進，做為用來儲存和管理使用者名稱和密碼的控制台功能。 認證管理員可讓使用者將與其他系統和網站相關的認證儲存在安全的 Windows 保存庫中。 某些版本的 Internet Explorer 會使用這項功能來驗證網站。

使用認證管理員的認證管理是由本機電腦上的使用者所控制的。 使用者可以儲存和存放支援的瀏覽器及 Windows 應用程式的認證，便於在需要登入這些資源時使用。 認證會儲存在電腦上使用者設定檔下的特殊加密資料夾中。 支援這項功能的應用程式（透過使用認證管理員 Api）（例如網頁瀏覽器和應用程式），可以在登入程式期間，對其他電腦和網站呈現正確的認證。

當網站、應用程式或其他電腦要求透過 NTLM 或 Kerberos 通訊協定進行驗證時，會出現一個對話方塊，您可以在其中選取 [**更新預設認證**] 或 [**儲存密碼**] 核取方塊。 這個對話方塊可讓使用者在本機儲存認證，是由支援認證管理員 Api 的應用程式所產生。 如果使用者選取 [**儲存密碼**] 核取方塊，認證管理員會針對使用中的驗證服務，追蹤使用者的使用者名稱、密碼和相關資訊。

下次使用服務時，認證管理員會自動提供儲存在 Windows 保存庫中的認證。 如果不接受這個認證，則會提示使用者輸入正確的存取資訊。 如果使用新的認證來授與存取權，認證管理員會使用新的認證來覆寫先前的認證，然後將新的認證儲存在 Windows 保存庫中。

## <a name="security-accounts-manager-database"></a><a name="BKMK_SAM"></a>安全性帳戶管理員資料庫
安全性帳戶管理員（SAM）是儲存本機使用者帳戶和群組的資料庫。 它會出現在每個 Windows 作業系統中;不過，當電腦加入網域時，Active Directory 管理 Active Directory 網域中的網域帳戶。

例如，即使沒有任何人為登入，執行 Windows 作業系統的用戶端電腦也會與網域控制站通訊來加入網路網域。 若要起始通訊，電腦在網域中必須有使用中的帳戶。 在接受來自電腦的通訊之前，網域控制站上的 LSA 會驗證電腦的身分識別，然後將電腦的安全性內容與人為安全性主體進行比對。 此安全性內容會定義特定電腦或網路上的使用者、服務或電腦上的使用者或服務的身分識別和功能。 例如，包含在安全性內容中的存取權杖，會定義可存取的資源（例如檔案共用或印表機），以及該主體可執行檔動作（例如讀取、寫入或修改），也就是該資源上的使用者、電腦或服務。

使用者或電腦的安全性內容可能會因一部電腦而異，例如當使用者登入伺服器或工作站，而不是使用者自己的主要工作站時。 它也可能會因一個會話而異，例如當系統管理員修改使用者的權利和許可權時。 此外，當使用者或電腦以獨立、網路或 Active Directory 網域的一部分進行操作時，安全性內容通常會不同。

## <a name="local-domains-and-trusted-domains"></a><a name="BKMK_LocalDomainsAndTrustedDomains"></a>本機網域和受信任的網域
當兩個網域之間有信任存在時，每個網域的驗證機制會依賴來自其他網域之驗證的有效性。 信任有助於透過驗證傳入驗證要求是否來自受信任的授權單位（受信任的網域），以提供資源網域（信任網域）中共用資源的受控制存取權。 如此一來，信任就會作為橋接器，讓只有經過驗證的驗證要求可在網域之間移動。

特定信任通過驗證要求的方式，取決於其設定方式。 信任關係可以是單向的，方法是提供來自受信任網域的存取權給信任網域中的資源，或將存取權提供給另一個網域中的資源，藉此雙向。 信任也是不可轉移的，在這種情況下，信任只存在於兩個信任夥伴網域之間，或可轉移，在此情況下，信任會自動延伸到任何夥伴信任的其他任何網域。

如需有關與驗證有關的網域和樹系信任關係的詳細資訊，請參閱[委派的驗證和信任關係](https://technet.microsoft.com/library/dn169022.aspx)。

## <a name="certificates-in-windows-authentication"></a><a name="BKMK_CertificatesInWindowsAuthentication"></a>Windows 驗證中的憑證
公開金鑰基礎結構（PKI）是軟體、加密技術、程式和服務的組合，可讓組織保護其通訊和商務交易。 PKI 保護通訊和商務交易的能力，是根據已驗證使用者與受信任資源之間的數位憑證交換。

數位憑證是一種電子檔，其中包含其所屬實體的相關資訊、其所發行的實體、唯一的序號或一些其他唯一的識別碼、發行和到期日，以及數位指紋。

驗證是判斷遠端主機是否可以受到信任的程式。 若要建立其可信度，遠端主機必須提供可接受的驗證憑證。

遠端主機藉由從憑證授權單位單位（CA）取得憑證來建立其可信度。 CA 接著可以擁有較高授權的認證，這會建立信任鏈。 若要判斷憑證是否值得信任，應用程式必須判斷根 CA 的身分識別，然後判斷它是否值得信任。

同樣地，遠端主機或本機電腦必須判斷使用者或應用程式所呈現的憑證是否為正版。 使用者透過 LSA 和 SSPI 呈現的憑證，會在本機電腦上的本機登入、網路或網域上，透過 Active Directory 中的憑證存放區進行評估，以獲得真實性。

若要產生憑證，驗證資料會透過雜湊演算法（例如安全雜湊演算法1（SHA1））傳遞，以產生訊息摘要。 訊息摘要接著會使用寄件者的私密金鑰來進行數位簽署，以證明訊息摘要是由寄件者所產生。

> [!NOTE]
> SHA1 是 Windows 7 和 Windows Vista 中的預設值，但在 Windows 8 中已變更為 SHA2。

**智慧卡驗證**

智慧卡技術是以憑證為基礎的驗證範例。 使用智慧卡登入網路可提供強式的驗證形式，因為它會在向網域驗證使用者時，使用以密碼編譯為基礎的識別和擁有證明。 Active Directory 憑證服務（AD CS）會透過發行每張智慧卡的登入憑證來提供密碼編譯的識別。

如需智慧卡驗證的相關資訊，請參閱[Windows 智慧卡技術參考](https://technet.microsoft.com/library/ff404297.aspx)。

Windows 8 引進了虛擬智慧卡技術。 它會在電腦中儲存智慧卡的憑證，然後使用裝置的防篡改信賴平臺模組（TPM）安全性晶片來保護它。 如此一來，電腦實際上會變成智慧卡，必須接收使用者的 PIN 才能進行驗證。

**遠端和無線驗證**

遠端和無線網路驗證是另一種使用憑證進行驗證的技術。 網際網路驗證服務（IAS）和虛擬私人網路伺服器使用可延伸的驗證通訊協定-傳輸層級安全性（EAP-TLS）、受保護的可延伸驗證通訊協定（PEAP），或網際網路通訊協定安全性（IPsec），為許多網路存取類型（包括虛擬私人網路（VPN）和無線連線）執行憑證型驗證。

如需網路中以憑證為基礎之驗證的相關資訊，請參閱[網路存取驗證和憑證](https://technet.microsoft.com/library/cc759575(WS.10).aspx)。

## <a name="see-also"></a><a name="BKMK_SeeAlso"></a>另請參閱
[Windows 驗證概念](https://docs.microsoft.com/windows-server/security/windows-authentication/windows-authentication-concepts)


