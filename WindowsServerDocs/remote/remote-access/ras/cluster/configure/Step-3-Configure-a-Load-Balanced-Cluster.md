---
title: 步驟 3 設定負載平衡叢集
description: 本主題是部署在 Windows Server 2016 的叢集中的遠端存取快速入門的一部分。
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology:
- networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: f000066e-7cf8-4085-82a3-4f4fe1cb3c5c
ms.author: pashort
author: shortpatti
ms.openlocfilehash: f835e27a80e661ff1f066af4779bd7c033cddc99
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/31/2019
ms.locfileid: "66446619"
---
# <a name="step-3-configure-a-load-balanced-cluster"></a>步驟 3 設定負載平衡叢集

>適用於：Windows Server （半年通道），Windows Server 2016

準備叢集的伺服器之後, 設定單一伺服器上進行負載平衡、 設定所需的憑證，並部署叢集。  
  
|工作|描述|  
|----|--------|  
|[3.1 設定的 IPv6 首碼](#BKMK_Prefix)|如果公司的環境是 IPv4 + IPv6，或僅 IPv6，然後在單一遠端存取伺服器上，確定 指派給 DirectAccess 用戶端電腦的 IPv6 首碼夠大，足以涵蓋各種您叢集中的伺服器。|  
|[3.2 啟用負載平衡](#BKMK_NLB)|啟用負載平衡單一遠端存取伺服器上。|  
|[3.3 安裝 IP-HTTPS 憑證](#BKMK_InstallIPHTTP)|在叢集中的每一部伺服器需要伺服器憑證來驗證 IP-HTTPS 連線。  匯出從單一遠端存取伺服器的 IP-HTTPS 憑證，並將它部署在您將新增到叢集的每部伺服器上。 這是必要的只有在使用非自我簽署的憑證。|  
|[3.4 安裝網路位置伺服器憑證](#BKMK_NLS)|如果單一伺服器部署在本機網路位置伺服器，則您必須部署在叢集中的每部伺服器上，網路位置伺服器憑證。 如果網路位置伺服器裝載於外部伺服器，就不需要在每一部伺服器上的憑證。 這是必要的只有在使用非自我簽署的憑證。|  
|[3.5 將伺服器新增到叢集](#BKMK_Add)|將所有的伺服器新增到叢集。 要加入的伺服器上時，必須未設定遠端存取。|  
|[3.6 從叢集移除伺服器](#BKMK_remove)|從叢集移除伺服器的指示。|  
|[3.7 停用負載平衡](#BKBK_disable)|停用負載平衡的指示。|  
  
> [!NOTE]  
> DIP 選取的 IP 位址不能在叢集中的第一個遠端存取伺服器的網路介面卡上使用。 開始使用 VIP 和 DIP 新增至網路介面卡的 DirectAccess 部署，將會導致失敗。  
  
> [!NOTE]  
> 請確定不使用已存在於網路上的另一部電腦上的 DIP。  
  
## <a name="BKMK_Prefix"></a>3.1 設定的 IPv6 首碼  
  
### <a name="configDA"></a>若要設定的前置詞  
  
1.  在遠端存取伺服器上，按一下**開始**，然後按一下**遠端存取管理**。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  在 [遠端存取管理] 主控台中，按一下 [設定]  。  
  
3.  在主控台的中間窗格中**步驟 2 DirectAccess 伺服器**區域中，按一下**編輯**。  
  
4.  按一下 **組態的前置詞**。 在上**前置詞組態**頁面上，於**指派給 DirectAccess 用戶端電腦的 IPv6 首碼**，輸入用於子網路長度為 59，比方說，DirectAccess 用戶端電腦的 IPv6 首碼**2001:db8:1:1000:: / 59**。 如果使用 IPv6，也已啟用 VPN，就會顯示 IPv6 首碼，，而且子網路的長度則需要變更到 59 之間。 按一下 [下一步]  。  
  
5.  在主控台中間窗格中，按一下**完成**。  
  
6.  在 [**遠端存取權檢閱**] 對話方塊中，檢閱組態設定，然後按一下**套用**。 在 [套用遠端存取安裝精靈設定]  對話方塊上，按一下 [關閉]  。  
  
## <a name="BKMK_NLB"></a>3.2 啟用負載平衡  
  
#### <a name="to-enable-load-balancing"></a>若要啟用負載平衡  
  
1.  在設定 DirectAccess 伺服器上，按一下**開始**，然後按一下**遠端存取管理**。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  在遠端存取管理主控台中，在左窗格中，按一下**組態**，然後在**工作**窗格中，按一下 **啟用負載平衡**。  
  
3.  啟用負載平衡精靈中，按一下**下一步**。  
  
4.  視您選擇在規劃步驟：  
  
    1.  Windows NLB:在 [**負載平衡方法**頁面上，按一下**使用 Windows 網路負載平衡 (NLB)** ，然後按一下**下一步]** 。  
  
    2.  外部負載平衡器：在上**負載平衡方法**頁面上，按一下**使用外部負載平衡器**，然後按一下**下一步**。  
  
5.  在單一網路介面卡部署中，在**專用的 IP 位址**頁面上，執行下列作業，然後按一下 [**下一步]** :  
  
    1.  在 [ **IPv4 位址**] 方塊中，輸入新的 IPv4 位址，此遠端存取伺服器; 目前 IPv4 位址將會在負載平衡叢集的虛擬 IP 位址 (VIP)。 在 **子網路遮罩**方塊中，輸入子網路遮罩。  
  
    2.  如果公司的環境是原生 IPv6，請在**IPv6 位址** 方塊中，輸入遠端存取伺服器的新 IPv6 位址; 目前 IPv6 位址可以是負載平衡叢集中的 VIP。 在 **子網路首碼長度**方塊中，輸入子網路首碼長度。  
  
6.  在兩個網路介面卡部署上**外部專用的 IP 位址**頁面上，執行下列作業，然後按一下 [**下一步]** :  
  
    1.  在 [ **IPv4 位址**] 方塊中，輸入新的外部 IPv4 位址，此遠端存取伺服器; 目前 IPv4 位址可以是虛擬的 IP 位址 (VIP) 的負載平衡叢集。 在 **子網路遮罩**方塊中，輸入子網路遮罩。  
  
    2.  如果有在遠端存取伺服器的網際網路對向網路介面卡上設定目前的原生的 IPv6 位址**IPv6 位址**方塊中，輸入新的外部 IPv6 位址進行此遠端存取伺服器; 目前的 IPv6位址會是負載平衡叢集的 VIP。 在 **子網路首碼長度**方塊中，輸入子網路首碼長度。  
  
7.  在兩個網路介面卡部署上**內部的專用 IP 位址**頁面上，執行下列作業，然後按一下 [**下一步]** :  
  
    1.  在 [ **IPv4 位址**] 方塊中，輸入新的內部 IPv4 位址，此遠端存取伺服器; 目前 IPv4 位址可以是叢集的負載平衡的 VIP。 在 **子網路遮罩**方塊中，輸入子網路遮罩。  
  
    2.  如果公司的環境是原生 IPv6，請在**IPv6 位址** 方塊中，輸入新的內部 IPv6 位址的遠端存取伺服器; 目前 IPv6 位址可以是叢集的負載平衡的 VIP。 在 **子網路首碼長度**方塊中，輸入子網路首碼長度。  
  
8.  在 **摘要**頁面上，按一下**認可**。  
  
9. 在 [**啟用負載平衡**] 對話方塊中，按一下**關閉**。  
  
10. 啟用負載平衡精靈中，按一下**關閉**。  
  
    > [!NOTE]  
    > 如果正在使用外部負載平衡，請注意虛擬 Ip，並提供他們在外部負載平衡器上。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 對等的命令</em>***  
  
下列 Windows PowerShell Cmdlet 執行與前述程序相同的功能。 在單一行中，輸入各個 Cmdlet (即使因為格式限制，它們可能會在這裡出現自動換行成數行)。  
  
如果您選擇使用 Windows NLB 的規劃步驟中，然後執行下列作業︰  
  
```  
Set-RemoteAccessLoadBalancer -InternetDedicatedIPAddress "2.1.1.20/255.255.255.0" -InternalDedicatedIPAddress @("10.1.1.30/255.255.255.0","3ffe::20/64") -InternetVirtualIPAddress @("2.1.1.1/255.255.255.0","2.1.1.2/255.255.255.0") -InternalVirtualIPAddress @("10.1.1.2/255.255.255.0","3ffe::2/64")  
```  
  
如果您選擇使用外部負載平衡器中的規劃步驟： 執行下列命令，然後：  
  
```  
Set-RemoteAccessLoadBalancer -InternetDedicatedIPAddress "2.1.1.20/255.255.255.0" -InternalDedicatedIPAddress @("10.1.1.30/255.255.255.0","3ffe::20/64") -UseThirdPrtyLoadBalancer  
```  
  
> [!NOTE]  
> 建議您使用不包含負載平衡器設定的變更而變更任何其他設定，如果您使用暫存 Gpo。 必須先套用到負載平衡器設定的任何變更，則應該進行其他組態變更。 此外，新的 DirectAccess 伺服器上設定負載平衡器之後, 請等候一段時間讓 IP 變更，再變更其他新的叢集相關的 DirectAccess 設定，在企業中，DNS 伺服器之間複寫且套用。  
  
## <a name="BKMK_InstallIPHTTP"></a>3.3 安裝 IP-HTTPS 憑證  
您至少必須有本機 **Administrators** 群組的成員資格或同等權限，才能完成此程序。  
  
### <a name="IPHTTPSCert"></a>若要安裝的 IP-HTTPS 憑證  
  
1.  在設定遠端存取伺服器上，按一下**開始**，型別**mmc**按 ENTER 鍵。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  在 MMC 主控台中，按一下 [檔案]  功能表上的 [新增/移除嵌入式管理單元]  。  
  
3.  在上**新增或移除嵌入式管理單元** 對話方塊中，按一下**憑證**，按一下**新增**，按一下 **電腦帳戶**，按一下  **下一步**，按一下**完成**，然後按一下**確定**。  
  
4.  在主控台的左窗格中，瀏覽至**Certificates (Local Computer) \Personal\Certificates**。 IP-HTTPS 憑證上按一下滑鼠右鍵，指向**所有工作**然後按一下**匯出**。  
  
5.  在 **歡迎使用 憑證匯出精靈**頁面上，按一下**下一步**。  
  
6.  在 [匯出私密金鑰]  頁面上，按一下 [是，匯出私密金鑰]  ，然後按 [下一步]  。  
  
7.  在 [**匯出檔案格式**頁面上，按一下**個人資訊交換-PKCS #12 (。PFX)** ，然後按一下**下一步]** 。  
  
8.  上**安全性**頁面上，選取**密碼**核取方塊，輸入密碼的**密碼**方塊，然後確認密碼，然後再按一下**下一步**.  
  
9. 在 [**要匯出的檔案**頁面上，輸入憑證檔案的名稱並將它儲存到桌面，然後按一下**下一步]** 。  
  
10. 在 **完成 憑證匯出精靈**頁面上，按一下**完成**。  
  
11. 在上**憑證匯出精靈** 對話方塊中，按一下**確定**。  
  
12. 將憑證複製到您想要成為叢集成員的所有伺服器。  
  
13. 在新的 DirectAccess 伺服器上，按一下**開始**，型別**mmc**按 ENTER 鍵。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
14. 在 MMC 主控台中，按一下 [檔案]  功能表上的 [新增/移除嵌入式管理單元]  。  
  
15. 在上**新增或移除嵌入式管理單元** 對話方塊中，按一下**憑證**，按一下**新增**，按一下 **電腦帳戶**，按一下  **下一步**，按一下**完成**，然後按一下**確定**。  
  
16. 在主控台的左窗格中，瀏覽至**Certificates (Local Computer) \Personal\Certificates**。 以滑鼠右鍵按一下**憑證**節點，指向**所有工作**，然後按一下**匯入**。  
  
17. 在 [**歡迎使用憑證匯入精靈**頁面上，按一下**下一步]** 。  
  
18. 在 **匯入檔案**頁面上，按一下**瀏覽**來找出憑證。 選取憑證，然後按一下**下一步**。  
  
19. 在 [**私密金鑰保護**頁面上，於**密碼**方塊中輸入密碼，然後再按**下一步]** 。  
  
20. 在 [**憑證存放區**] 頁面上，按 [**下一步**]。  
  
21. 在 [完成憑證匯入精靈]  頁面上，按一下 [完成]  。  
  
22. 在 [**憑證匯入精靈**] 對話方塊中，按一下**確定**。  
  
23. 重複步驟 13 到 22，您想要成為叢集成員的所有伺服器上。  
  
## <a name="BKMK_NLS"></a>3.4 安裝網路位置伺服器憑證  
您至少必須有本機 **Administrators** 群組的成員資格或同等權限，才能完成此程序。  
  
#### <a name="to-install-a-certificate-for-network-location"></a>若要安裝的網路位置的憑證  
  
1.  在遠端存取伺服器上，按一下**開始**，型別**mmc**，然後按 ENTER 鍵。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  按一下 **檔案**，然後按一下**新增/移除嵌入式管理單元**。  
  
3.  按一下 **憑證**，按一下**新增**，按一下 **電腦帳戶**，按一下 **下一步**，按一下 **本機電腦**，按一下**完成**，然後按一下**確定**。  
  
4.  在 [憑證] 嵌入式管理單元的主控台樹狀目錄中，開啟 [憑證 (本機電腦)\個人\憑證]  。  
  
5.  在 [憑證]  上按一下滑鼠右鍵，指向 [所有工作]  ，然後按一下 [要求新憑證]  。  
  
6.  按兩次 [下一步]  。  
  
7.  在 **要求憑證**頁面上，按一下 Web 伺服器憑證範本，然後按一下**的詳細資訊，才能註冊此憑證**。  
  
    如果 Web 伺服器憑證範本未出現，請確定遠端存取伺服器電腦帳戶已註冊的 Web 伺服器憑證範本的權限。 如需詳細資訊，請參閱 <<c0> [ 設定 Web 伺服器憑證範本的權限](https://msdn.microsoft.com/library/ee649249.aspx)。  
  
8.  上**主旨** 索引標籤**憑證內容**對話方塊中，於**主體名稱**，如**類型**，選取**常見名稱**。  
  
9. 在 **值**，輸入網路位置伺服器網站 (例如，「 nls.corp.contoso.com 」) 的內部網路名稱的完整的網域名稱 (FQDN)，然後按一下**新增**。  
  
10. 依序按一下 [確定]  、[註冊]  ，然後按一下 [完成]  。  
  
11. 在 [憑證] 嵌入式管理單元的詳細資料窗格中，確認已向新的憑證使用 FQDN**預定目的**的**伺服器驗證**。  
  
12. 以滑鼠右鍵按一下憑證，然後按一下**屬性**。  
  
13. 在 **易記名稱**，型別**網路位置憑證**，然後按一下  **確定**。  
  
    > [!TIP]  
    > 步驟 12 和 13 是選擇性的但讓您更輕鬆地設定遠端存取時，選取 網路位置的憑證。  
  
14. 重複此程序，您想要成為叢集成員的所有伺服器上。  
  
## <a name="BKMK_Add"></a>3.5 將伺服器新增到叢集  
 
  
#### <a name="to-add-servers-to-the-cluster"></a>若要將伺服器新增到叢集  
  
1.  在設定 DirectAccess 伺服器上，按一下**開始**，然後按一下**遠端存取管理**。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  在 [遠端存取管理] 主控台中，按一下 [設定]  。 中**任務**窗格下方**負載平衡的叢集**，按一下**新增或移除伺服器**。  
  
3.  在 [**新增或移除伺服器**] 對話方塊中，按一下**新增伺服器**。  
  
4.  在 **將伺服器加入**對話方塊的 **選取伺服器**頁面上，輸入其他的遠端存取伺服器的名稱，然後按一下**下一步**。  
  
5.  在 **網路介面卡**頁面上，執行下列動作之一：  
  
    -   如果您要在兩個網路介面卡，部署拓樸**外部介面卡**，選取 連線到外部網路介面卡。 在 **內部介面卡**，選取 連線到內部網路介面卡。  
  
    -   如果您要在具有一個網路介面卡，部署拓樸**網路介面卡**，選取 連線到內部網路介面卡。  
  
6.  在上**網路介面卡**頁面上，於**選取用來驗證 IP-HTTPS 連線的憑證**，按一下 [**瀏覽**找出並選取 IP-HTTPS 憑證，然後按一下**下一步]** 。  
  
7.  在上**網路位置伺服器**頁面上，按一下**瀏覽**若要選取遠端存取伺服器上所執行的網路位置伺服器網站憑證，然後按一下**下一步**.  
  
    > [!NOTE]  
    > **網路位置伺服器**只有網路位置伺服器網站在執行時在遠端存取伺服器上會出現的頁面。  
  
    > [!NOTE]  
    > 如果遠端存取伺服器上也已設定 VPN，您會被要求新增 VPN IP 位址集區資訊在此時。  
  
8.  在 **摘要**頁面上，按一下**新增**。  
  
9. 在 [**完成**] 頁面上，按一下 [**關閉**]。  
  
10. 重複此程序新增至叢集的所有遠端存取伺服器。  
  
11. 在 [**新增或移除伺服器**] 對話方塊中，按一下**認可**。  
  
12. 在 [**加入和移除伺服器**] 對話方塊中，按一下**關閉**。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 對等的命令</em>***  
  
下列 Windows PowerShell Cmdlet 執行與前述程序相同的功能。 在單一行中，輸入各個 Cmdlet (即使因為格式限制，它們可能會在這裡出現自動換行成數行)。  
  
```  
Add-RemoteAccessLoadBalancerNode -RemoteAccessServer <server name>  
```  
  
> [!NOTE]  
> 如果未在負載平衡叢集中啟用 VPN，您應該在將新的伺服器新增至使用 Windows PowerShell cmdlet 的叢集時不提供任何 VPN 位址範圍。 如果您這麼做不小心，從叢集移除伺服器，並將它重新加入叢集但未指定 VPN 位址範圍。  
  
## <a name="BKMK_remove"></a>3.6 從叢集移除伺服器  
 
  
#### <a name="to-remove-a-server-from-the-cluster"></a>若要從叢集移除伺服器  
  
1.  在設定遠端存取伺服器上，按一下**開始**，然後按一下**遠端存取管理**。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  在 [遠端存取管理] 主控台中，按一下 [設定]  。 中**任務**窗格下方**負載平衡的叢集**，按一下**新增或移除伺服器**。  
  
3.  在 [**新增或移除伺服器**] 對話方塊中選取您想要移除的遠端存取伺服器，然後按一下**移除伺服器**。  
  
4.  在 [**移除 Server 警告**] 對話方塊中，請確定您選擇正確的伺服器，然後**確定**。  
  
5.  重複此程序，要從叢集移除的所有遠端存取伺服器。  
  
6.  在 [**新增或移除伺服器**] 對話方塊中，按一下**認可**。  
  
7.  在 [**加入和移除伺服器**] 對話方塊中，按一下**關閉**。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 對等的命令</em>***  
  
下列 Windows PowerShell Cmdlet 執行與前述程序相同的功能。 在單一行中，輸入各個 Cmdlet (即使因為格式限制，它們可能會在這裡出現自動換行成數行)。  
  
```  
Remove-RemoteAccessLoadBalancerNode -RemoteAccessServer <server name>  
```  
  
## <a name="BKBK_disable"></a>3.7 停用負載平衡  
[執行此步驟中使用 Windows PowerShell](assetId:///7a817ca0-2b4a-4476-9d28-9a63ff2453f9)  
  
#### <a name="to-disable-load-balancing"></a>若要停用負載平衡  
  
1.  在設定 DirectAccess 伺服器上，按一下**開始**，然後按一下**遠端存取管理**。 如果出現 [**使用者帳戶控制**] 對話方塊，請確認它所顯示的動作就是您所需的動作，然後按一下 [**是**]。  
  
2.  在 [遠端存取管理] 主控台中，按一下 [設定]  。 在 **工作**窗格下方**負載平衡的叢集**，按一下**停用負載平衡**。  
  
3.  在 [**停用負載平衡**] 對話方塊中，按一下**確定**。  
  
4.  在 [**停用負載平衡**] 對話方塊中，按一下**關閉**。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>Windows PowerShell 對等的命令</em>***  
  
下列 Windows PowerShell Cmdlet 執行與前述程序相同的功能。 在單一行中，輸入各個 Cmdlet (即使因為格式限制，它們可能會在這裡出現自動換行成數行)。  
  
```  
set-RemoteAccessLoadBalancer -disable  
```  
  
停用負載平衡會移除遠端存取設定和 NLB 設定 （若已設定） 從它正在執行所在的伺服器以外的所有伺服器。 此遠端存取伺服器上 （如果它已設定），將會移除 NLB 設定，但會保留遠端存取設定。  
  
按一下 **移除組態設定**會移除遠端存取和 NLB （若已設定） 從部署中的所有伺服器。  
  
> [!NOTE]  
> -   如果所部署的負載平衡時，會解除安裝遠端存取，所有伺服器也會都保留與 Dip。 Vip 會移除。 這會造成失敗的 Vip 位址則針對公司網路的所有路由。 這也會影響已解析為 Vip，例如網路位置伺服器憑證主體名稱的 DNS 項目。 若要避免這個問題，停用負載平衡，這在最後一個遠端存取伺服器上，保留 Vip，然後解除安裝遠端存取。  
> -   在使用後**組 RemoteAccessLoadBalancer** cmdlet 來停用負載平衡，請等待 2 分鐘，再執行任何其他 cmdlet。 這也應該在任何後執行另一個 cmdlet 的指令碼**組 RemoteAccessLoadBalancer-停用**cmdlet。  
> -   停用負載平衡變更專用的 IP 位址到叢集的虛擬 IP 位址。 如此一來，在伺服器上的快取的 DNS 項目到期之前，將會失敗的伺服器名稱查詢的任何作業。 請確定您沒有停用負載平衡，直到伺服器上的快取到期之後執行任何遠端存取 」 PowerShell cmdlet。 此問題是更常見，如果您嘗試停用位於另一個網域的另一部電腦中的機器上的負載平衡。 如果您停用負載平衡中，從遠端存取管理主控台，並可能防止設定被載入，這也會發生。 快取過期或已排清之後，就會載入組態。  
  
## <a name="BKMK_Links"></a>另請參閱  
  
-   [步驟 4：驗證叢集](Step-4-Verify-the-Cluster.md)  
  


