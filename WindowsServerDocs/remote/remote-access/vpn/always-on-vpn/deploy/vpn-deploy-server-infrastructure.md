---
title: 設定伺服器基礎結構
description: 在此步驟中，您可以安裝及設定支援的 VPN 所需的伺服器端元件。 伺服器端元件包括設定將使用者、 VPN 伺服器和 NPS 伺服器所使用的憑證的 PKI。
ms.prod: windows-server-threshold
ms.technology: networking-ras
ms.topic: article
ms.assetid: ''
ms.localizationpriority: medium
ms.author: pashort
author: shortpatti
ms.date: 08/30/2018
ms.reviewer: deverette
ms.openlocfilehash: 8a07d84427b770da465b8712d71eb846a7c9cf8d
ms.sourcegitcommit: 0948a1abff1c1be506216eeb51ffc6f752a9fe7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/06/2019
ms.locfileid: "66749609"
---
# <a name="step-2-configure-the-server-infrastructure"></a>步驟 2. 設定伺服器基礎結構

>適用於：Windows Server （半年通道），Windows Server 2016 中，Windows Server 2012 R2 中，Windows 10

- [**前一個：** 步驟 1.規劃 Always On VPN 部署](always-on-vpn-deploy-planning.md)
- [**下一步:** 步驟 3。設定 Always On VPN 的遠端存取伺服器](vpn-deploy-ras.md)

在此步驟中，您將安裝及設定支援的 VPN 所需的伺服器端元件。 伺服器端元件包括設定將使用者、 VPN 伺服器和 NPS 伺服器所使用的憑證的 PKI。  您也可以設定 RRAS，才能支援 IKEv2 連線和 VPN 連線的執行授權的 NPS 伺服器。

## <a name="configure-certificate-autoenrollment-in-group-policy"></a>在 群組原則中設定憑證自動註冊
在此程序，使網域成員自動要求使用者和電腦憑證 」，群組原則設定網域控制站上。 這樣做可讓 VPN 使用者來要求及擷取自動驗證 VPN 連線的使用者憑證。 同樣地，此原則可讓 NPS 伺服器，要求伺服器驗證憑證自動。 

您以手動方式註冊在 VPN 伺服器上的憑證。

>[!TIP]
>非 domained 加入的電腦，請參閱 < [CA 設定非網域聯結電腦](#ca-configuration-for-non-domain-joined-computers)。 RRAS 伺服器未加入網域，因為無法使用自動註冊，以註冊 VPN 閘道的憑證。  因此，使用離線憑證要求程序。

1. 在網域控制站，開啟 [群組原則管理]。

2. 在 [導覽] 窗格中，以滑鼠右鍵按一下您的網域 (例如 corp.contoso.com)，然後選取**在這個網域中建立 GPO 並連結到**。

3. 在 [新增 GPO] 對話方塊中，輸入**自動註冊原則**，然後選取**確定**。

4. 在 [導覽] 窗格中，以滑鼠右鍵按一下**自動註冊原則**，然後選取**編輯**。

5. 在 群組原則管理編輯器 」 中，完成下列步驟來設定電腦憑證自動註冊：

    1. 在 [導覽] 窗格中，移至**電腦組態** > **原則** > **Windows 設定** >  **安全性設定** > **公開金鑰原則**。

    2. 在 [詳細資料] 窗格中，以滑鼠右鍵按一下**憑證服務用戶端-自動註冊**，然後選取**屬性**。

    3. 在 憑證服務用戶端-自動註冊內容對話方塊的 **組態模型**，選取**已啟用**。

    4. 選取 [更新到期的憑證，更新擱置中的憑證並移除撤銷的憑證]  與 [更新使用憑證範本的憑證]  。

    5. 選取 [確定]。 

6. 在 群組原則管理編輯器 」 中，完成下列步驟來設定使用者憑證自動註冊：

    1. 在 [導覽] 窗格中，移至**使用者設定** > **原則** > **Windows 設定** >  **安全性設定** > **公開金鑰原則**。

    2. 在詳細資料窗格中，以滑鼠右鍵按一下 **\[憑證服務用戶端 – 自動註冊\]** ，然後選取 **\[屬性\]** 。

    3. 在 憑證服務用戶端-自動註冊內容對話方塊的 **組態模型**，選取**已啟用**。

    4. 選取 [更新到期的憑證，更新擱置中的憑證並移除撤銷的憑證]  與 [更新使用憑證範本的憑證]  。

    5. 選取 [確定]。 

    6. 關閉 \[群組原則管理編輯器\]。

7. 關閉 [群組原則管理]。

### <a name="ca-configuration-for-non-domain-joined-computers"></a>加入非網域的電腦的 CA 設定

RRAS 伺服器未加入網域，因為無法使用自動註冊，以註冊 VPN 閘道的憑證。  因此，使用離線憑證要求程序。

1. 在 RRAS 伺服器上，產生的檔案，稱為**VPNGateway.inf**根據範例憑證原則要求在附錄中提供的 （區段 0） 和自訂下列項目：

   - 在 [NewRequest] 區段中，取代 [vpn.contoso.com 用於 [主體名稱，以所選的 [_客戶_] VPN 端點的 FQDN。

   - 在 [擴充功能] 區段中，取代 [vpn.contoso.com 使用主體替代名稱，以所選的 [_客戶_] VPN 端點的 FQDN。

2. 儲存或複製**VPNGateway.inf**檔案，以選擇的位置。

3. 從提升權限的命令提示字元中，瀏覽至包含的資料夾**VPNGateway.inf**檔案並輸入：

   ```
   certreq -new VPNGateway.inf VPNGateway.req
   ```

4. 複製新建**VPNGateway.req**至憑證授權單位伺服器或具有特殊權限存取工作站 (PAW) 的輸出檔。

5. 儲存或複製**VPNGateway.req**檔案到選擇的位置上的憑證授權單位伺服器 」 或 「 特殊權限存取工作站 (PAW)。

6. 從提升權限的命令提示字元中，瀏覽至包含 VPNGateway.req 檔案類型與上一個步驟中建立的資料夾：

   ```
   certreq -attrib “CertificateTemplate:[Customer]VPNGateway” -submit VPNgateway.req VPNgateway.cer
   ```

7. 出現提示時，由憑證授權單位清單 視窗，選取適當的企業 CA，為憑證要求提供服務。

8. 複製新建**VPNGateway.cer** RRAS 伺服器的輸出檔。 

9. 儲存或複製**VPNGateway.cer**選擇的位置，在 RRAS 伺服器上的檔案。

10. 從提升權限的命令提示字元中，瀏覽至包含 VPNGateway.cer 檔案類型與上一個步驟中建立的資料夾：

    ```
    certreq -accept VPNGateway.cer
    ```

11. 執行 憑證 MMC 嵌入式管理單元，如所述[此處](https://docs.microsoft.com/dotnet/framework/wcf/feature-details/how-to-view-certificates-with-the-mmc-snap-in)選取**電腦帳戶**選項。

12. 請確定有效的憑證存在 RRAS 伺服器具有下列屬性：

    - **目的：** 伺服器驗證，IP 安全性 IKE 中繼 

    - **憑證範本：** [_客戶_] VPN 伺服器

#### <a name="example-vpngatewayinf-script"></a>範例：VPNGateway.inf 指令碼

您可以在這裡看到用來要求使用頻外程序的 VPN 閘道憑證的憑證要求原則的範例指令碼。

>[!TIP]
>VPN 供應項目 IP 套件中的憑證要求的原則資料夾下，您可以找到一份 VPNGateway.inf 指令碼。 只會更新 'Subject' 和 '\_繼續\_' 使用客戶特定值。

```
[Version] 

Signature="$Windows NT$"

[NewRequest]
Subject = "CN=vpn.contoso.com"
Exportable = FALSE   
KeyLength = 2048     
KeySpec = 1          
KeyUsage = 0xA0      
MachineKeySet = True
ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
RequestType = PKCS10 

[Extensions]
2.5.29.17 = "{text}"
_continue_ = "dns=vpn.contoso.com&"
```

## <a name="create-the-vpn-users-vpn-servers-and-nps-servers-groups"></a>建立 VPN 使用者、 VPN 伺服器和 NPS 伺服器群組

在此程序中，您可以加入新的 Active Directory (AD) 群組包含可以使用 VPN 來連線到您的組織網路的使用者。

此群組有兩種用途：

- 它會定義哪些使用者需要 VPN 的使用者憑證時，可以自動註冊。

- 它會定義哪些由 NPS 授權以存取 VPN 的使用者。

藉由使用自訂群組，如果您想要撤銷使用者的 VPN 存取權，您可以移除該使用者群組。

此外，您也會加入此群組中包含 VPN 伺服器和另一個群組中包含的 NPS 伺服器。 您可以使用這些群組來限制對其成員的憑證要求。

>[!NOTE]
>我們建議您 VPN 存在於 DMA/周邊網路中的伺服器不是已加入網域。 不過，如果您想要讓已加入網域的較佳管理性方面的 VPN 伺服器 （群組原則，備份/監視 」 代理程式，來管理沒有任何本機使用者），然後加入 AD 群組的 VPN 伺服器憑證範本。

### <a name="configure-the-vpn-users-group"></a>設定 VPN 使用者群組

1. 網域控制站上開啟 Active Directory 使用者和電腦。

2. 以滑鼠右鍵按一下容器或組織單位中，選取**的新**，然後選取**群組**。

3. 在 **群組名稱**，輸入**VPN 使用者**，然後選取**確定**。

4. 以滑鼠右鍵按一下**VPN 使用者**，然後選取**屬性**。

5. 在 **成員** 索引標籤的 VPN 使用者內容對話方塊中，選取**新增**。

6. 在 選取使用者 對話方塊中，新增 所有使用者都需要 VPN 存取，然後選取**確定**。

7. 關閉 [Active Directory 使用者和電腦]。

### <a name="configure-the-vpn-servers-and-nps-servers-groups"></a>設定 VPN 伺服器和 NPS 伺服器群組

1. 網域控制站上開啟 Active Directory 使用者和電腦。

2. 以滑鼠右鍵按一下容器或組織單位中，選取**的新**，然後選取**群組**。

3. 在 **群組名稱**，輸入**VPN 伺服器**，然後選取**確定**。

4. 以滑鼠右鍵按一下**VPN 伺服器**，然後選取**屬性**。

5. 在 **成員** 索引標籤的 VPN 伺服器內容對話方塊中，選取**新增**。

6. 選取**物件的型別**，選取**電腦**核取方塊，然後選取**確定**。

7. 在 **輸入要選取的物件名稱**，輸入 VPN 伺服器的名稱，然後選取**確定**。

8. 選取 [**確定**關閉 VPN 伺服器內容] 對話方塊。

9. 重複上述步驟的 NPS 伺服器群組。

10. 關閉 [Active Directory 使用者和電腦]。

## <a name="create-the-user-authentication-template"></a>建立使用者驗證範本

在此程序中，您可以設定自訂用戶端-伺服器驗證範本。 此範本是必要的因為您想要改善憑證的整體安全性，藉由選取 升級相容性層級，然後選擇 Microsoft 平台密碼編譯提供者。 這最後一項變更可讓您使用用戶端電腦上的 TPM 保護的憑證。 如需 TPM 的概觀，請參閱 <<c0> [ 受信任的平台模組技術概觀](https://docs.microsoft.com/windows/device-security/tpm/trusted-platform-module-overview)。

**程序：**

1. 在 CA 上，開啟 憑證授權單位。

2. 在 [導覽] 窗格中，以滑鼠右鍵按一下**憑證範本**，然後選取**管理**。

3. 在 [憑證範本] 主控台中，以滑鼠右鍵按一下**使用者**，然後選取**複製範本**。

   >[!WARNING]
   >請勿選取**套用**或**確定**隨時之前步驟 10。  如果您輸入所有參數之前，先選取這些按鈕，許多的選擇也變得固定而且不再可供編輯。 例如，在**Cryptography**索引標籤上，如果_傳統密碼編譯儲存提供者_顯示在 [提供者類別目錄] 欄位中，它會變成停用，避免任何進一步的變更。 唯一的替代方法是刪除範本，並重新建立。  

4. 在 [新範本的內容] 對話方塊中，在**一般**索引標籤上，完成下列步驟：

   1. 在 **範本顯示名稱**，型別**VPN 使用者驗證**。

   2. 清除**將憑證發佈到 Active Directory 中的**核取方塊。

5. 在 **安全性**索引標籤上，完成下列步驟：

   1. 選取 **新增**。

   2. 在 [選取使用者、 電腦、 服務帳戶或群組] 對話方塊中，輸入**VPN 使用者**，然後選取**確定**。

   3. 在 **群組或使用者名稱**，選取**VPN 使用者**。

   4. 在  **VPN 使用者的權限**，選取**註冊**並**自動註冊**中核取方塊**允許**資料行。

      >[!TIP]
      >請務必保留選取 [讀取] 核取方塊。 換句話說，您需要註冊的讀取權限。 

   5. 在 **群組或使用者名稱**，選取**Domain Users**，然後選取**移除**。

6. 在 **相容性**索引標籤上，完成下列步驟：

   1. 在 **憑證授權單位**，選取**Windows Server 2012 R2**。

   2. 在 **產生的變更**對話方塊中，選取**確定**。

   3. 在 **憑證收件者**，選取**Windows 8.1 / Windows Server 2012 R2**。

   4. 在 **產生的變更**對話方塊中，選取**確定**。

7. 在 **處理要求**索引標籤上，清除**允許私密金鑰匯出**核取方塊。

8. 在  **Cryptography**索引標籤上，完成下列步驟：

   1. 在 **提供者類別目錄**，選取**金鑰儲存提供者**。

   2. 選取 **要求必須使用下列提供者的其中一個**。

   3. 選取  **Microsoft 平台密碼編譯提供者**核取方塊。

9. 在上**主體名稱**索引標籤上，如果您沒有清除所有的使用者帳戶上所列的電子郵件地址**主體名稱中的包含電子郵件名稱**並**電子郵件名稱**核取方塊。

10. 選取 **確定**儲存 VPN 使用者驗證憑證範本。

11. 關閉 憑證範本主控台。

12. 在 [憑證授權單位] 嵌入式管理單元的瀏覽窗格，以滑鼠右鍵按一下**憑證範本**，選取**新增**，然後選取**要發出的憑證範本**。

13. 選取  **VPN 使用者驗證**，然後選取**確定**。

14. 關閉 [憑證授權單位] 嵌入式管理單元。

## <a name="create-the-vpn-server-authentication-template"></a>建立 VPN 伺服器驗證範本

在此程序，您可以針對您的 VPN 伺服器設定新的伺服器驗證範本。 新增 IP 安全性 (IPsec) IKE 中繼應用程式原則可讓篩選條件的憑證伺服器，如果一個以上的憑證可供伺服器驗證擴充金鑰使用方法。

>[!IMPORTANT]
>VPN 用戶端會從公用網際網路存取此伺服器，因為 主旨 與 替代名稱的不同內部伺服器名稱。 如此一來，您將無法自動註冊此憑證在 VPN 伺服器上。

**必要條件：**

已加入網域的 VPN 伺服器

**程序：**

1. 在 CA 上，開啟 憑證授權單位。

2. 在 [導覽] 窗格中，以滑鼠右鍵按一下**憑證範本**，然後選取**管理**。

3. 在 [憑證範本] 主控台中，以滑鼠右鍵按一下**RAS 及 IAS 伺服器**，然後選取**複製範本**。

4. 在 [新範本的內容] 對話方塊中，在**一般**索引標籤中，於**範本顯示名稱**，輸入 VPN 伺服器的描述性名稱，例如**VPN 伺服器驗證**或是**RADIUS 伺服器**。

5. 在 **延伸模組**索引標籤上，完成下列步驟：

    1. 選取 **應用程式原則**，然後選取**編輯**。

    2. 在 **編輯應用程式原則延伸**對話方塊中，選取**新增**。

    3. 在 **新增應用程式原則**對話方塊中，選取**IP 安全性 IKE 中繼**，然後選取**確定**。
   
        新增 IP 安全性 IKE 中繼到 EKU，有助於在 VPN 伺服器有一個以上的伺服器驗證憑證的其中的案例中。 當 IP 安全性 IKE 中繼存在時，IPSec 僅使用這兩個 EKU 選項使用的憑證。 如果沒有這麼做，IKEv2 驗證失敗，但是錯誤 13801:IKE 驗證認證就是無法接受的。

    4. 選取 [ **[確定]** 以返回**新範本的內容**] 對話方塊。

6. 在 **安全性**索引標籤上，完成下列步驟：

    1. 選取 **新增**。

    2. 在 **選取使用者、 電腦、 服務帳戶或群組**對話方塊方塊中，輸入**VPN 伺服器**，然後選取**確定**。

    3. 在 **群組或使用者名稱**，選取**VPN 伺服器**。

    4. 在  **VPN 伺服器的權限**，選取**註冊**中的核取方塊**允許**資料行。

    5. 在 **群組或使用者名稱**，選取**RAS 與 IAS 伺服器**，然後選取**移除**。

7. 在 **主體名稱**索引標籤上，完成下列步驟：

    1. 選取 **在要求中提供**。

    2. 在 **憑證範本**警告對話方塊中，選取**確定**。

8. （選擇性）如果您要設定 VPN 連線能力的條件式存取，請選取**處理要求**索引標籤，然後選取**允許私密金鑰匯出**。

9. 選取 **確定**儲存 VPN 伺服器憑證範本。

10. 關閉 憑證範本主控台。

11. 在 [憑證授權單位] 嵌入式管理單元的瀏覽窗格，以滑鼠右鍵按一下**憑證範本**，選取**新增**，然後選取**要發出的憑證範本**。

12. 選取您在上述的步驟 4 中選擇的名稱，然後按一下 **確定**。

13. 關閉 [憑證授權單位] 嵌入式管理單元。

## <a name="create-the-nps-server-authentication-template"></a>建立 NPS 伺服器驗證範本

若要建立的第三個和最後一個憑證範本是 NPS 伺服器驗證 範本。 NPS 伺服器驗證範本是簡單的保護，以您在本節中稍早建立的 NPS 伺服器群組 RAS 及 IAS 伺服器範本複本。

您將設定為自動註冊此憑證。

**程序：**

1. 在 CA 上，開啟 憑證授權單位。

2. 在 [導覽] 窗格中，以滑鼠右鍵按一下**憑證範本**，然後選取**管理**。

3. 在 [憑證範本] 主控台中，以滑鼠右鍵按一下**RAS 及 IAS 伺服器**，然後選取**複製範本**。

4. 在 [新範本的內容] 對話方塊中，在**一般**索引標籤中，於**範本顯示名稱**，型別**NPS 伺服器驗證**。

5. 在 **安全性**索引標籤上，完成下列步驟：

    1. 選取 **新增**。

    2. 在 **選取使用者、 電腦、 服務帳戶或群組**對話方塊方塊中，輸入**NPS 伺服器**，然後選取**確定**。

    3. 在 **群組或使用者名稱**，選取**NPS 伺服器**。

    4. 在  **NPS 伺服器的權限**，選取**註冊**並**自動註冊**中核取方塊**允許**資料行。

    5. 在 **群組或使用者名稱**，選取**RAS 與 IAS 伺服器**，然後選取**移除**。

6. 選取 **確定**儲存 NPS 伺服器憑證範本。

7. 關閉 憑證範本主控台。

8. 在 [憑證授權單位] 嵌入式管理單元的瀏覽窗格，以滑鼠右鍵按一下**憑證範本**，選取**新增**，然後選取**要發出的憑證範本**。

9. 選取  **NPS 伺服器驗證**，然後選取**確定**。

10. 關閉 [憑證授權單位] 嵌入式管理單元。

## <a name="enroll-and-validate-the-user-certificate"></a>註冊並驗證使用者憑證

因為您使用群組原則來自動註冊使用者憑證，您只需要更新原則，和 Windows 10 自動註冊的正確憑證的使用者帳戶。 然後，您可以驗證憑證 主控台中的憑證。

**程序：**

1. 成員的身分登入已加入網域的用戶端電腦**VPN 使用者**群組。

2. 按 Windows 鍵 + R、 型別**gpupdate /force**，然後按 Enter。

3. 在 [開始] 功能表中，輸入**certmgr.msc**，然後按 Enter。

4. 在 [憑證] 嵌入式管理單元中，在**個人**，選取**憑證**。 您的憑證會出現在 [詳細資料] 窗格中。

5. 以滑鼠右鍵按一下目前的網域使用者名稱的憑證，然後選取**開啟**。

6. 在 **一般**索引標籤上，確認底下所列的日期**有效期自**今天的日期。 如果沒有，您可能選取了錯誤的憑證。

7. 選取 **確定**，並關閉 憑證 嵌入式管理單元。

## <a name="enroll-and-validate-the-server-certificates"></a>註冊並驗證伺服器憑證

不同於使用者憑證，您必須手動註冊 VPN 伺服器的憑證。 您已註冊它之後，請使用相同的程序，您使用於使用者憑證驗證。 使用者憑證，例如 NPS 伺服器自動註冊其驗證憑證，所以您只需要進行驗證。

>[!NOTE]
>您可能需要重新啟動 VPN 與 NPS 伺服器，以允許使用者更新其群組成員資格，才能完成這些步驟。

### <a name="enroll-and-validate-the-vpn-server-certificate"></a>註冊並驗證 VPN 伺服器憑證

1. 在 VPN 伺服器的 [開始] 功能表，鍵入**certlm.msc**，然後按 Enter。

2. 以滑鼠右鍵按一下**個人**，選取**所有工作**，然後選取**要求新憑證**以啟動 憑證註冊精靈。

3. 在您開始前 頁面上，選取**下一步**。

4. 在 選取憑證註冊原則 頁面中，選取**下一步**。

5. 在 要求憑證 頁面中，選取 VPN 伺服器，以選取它旁邊的核取方塊。

6. 在 VPN 伺服器核取方塊中，選取**需要更多的資訊，** 以開啟 [憑證內容] 對話方塊中，並完成下列步驟：

    1. 選取 **主旨**索引標籤上，選取**一般名稱**之下**主體名稱**中**類型**。

    2. 底下**主體名稱**，請在**值**，輸入名稱的外部網域的用戶端用來連線至 VPN，比方說，vpn.contoso.com，然後選取**新增**。

    3. 底下**別名**，請在**型別**，選取**DNS**。

    4. 底下**別名**，請在**值**，輸入您所有的用戶端用來連線至 VPN，例如伺服器名稱、 vpn.contoso.com、 vpn、 132.64.86.2。

    5. 選取 **新增**輸入每個名稱之後。

    6. 選取 **確定**時完成。

7. 選取 **註冊**。

8. 選取 **完成**。

9. 在 [憑證] 嵌入式管理單元中，在**個人**，選取**憑證**。
    
    您列出的憑證會出現在 [詳細資料] 窗格中。

10. 以滑鼠右鍵按一下 含有憑證，您的 VPN 伺服器的名稱，然後按**開啟**。

11. 在 **一般**索引標籤上，確認底下所列的日期**有效期自**今天的日期。 如果沒有，您可能選取了不正確的憑證。

12. 在上**詳細資料**索引標籤上，選取**增強金鑰使用方法**，並確認**IP 安全性 IKE 中繼**並**伺服器驗證**顯示在清單中。

13. 選取 **確定**以關閉憑證。

14. 關閉 [憑證] 嵌入式管理單元。

### <a name="validate-the-nps-server-certificate"></a>驗證 NPS 伺服器憑證

1. 重新啟動 NPS 伺服器。

2. 在 NPS 伺服器的 [開始] 功能表，鍵入**certlm.msc**，然後按 Enter。

3. 在 [憑證] 嵌入式管理單元中，在**個人**，選取**憑證**。

    您列出的憑證會出現在 [詳細資料] 窗格中。

4. 以滑鼠右鍵按一下憑證具有 NPS 伺服器的名稱，然後按**開啟**。

5. 在 **一般**索引標籤上，確認底下所列的日期**有效期自**今天的日期。 如果沒有，您可能選取了不正確的憑證。

6. 選取 **確定**以關閉憑證。

7. 關閉 [憑證] 嵌入式管理單元。

## <a name="next-steps"></a>後續步驟

[步驟 3.設定遠端存取伺服器的 Alwayson VPN](vpn-deploy-ras.md):在此步驟中，您可以設定允許 IKEv2 VPN 連線，拒絕來自其他 VPN 通訊協定，連線將發行的 IP 位址的靜態 IP 位址集區指派給已授權的 VPN 用戶端連線的遠端存取 VPN。
