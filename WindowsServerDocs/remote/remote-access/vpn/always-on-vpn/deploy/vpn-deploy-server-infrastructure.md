---
title: 設定伺服器基礎結構
description: 在此步驟中，您可以安裝及設定支援 VPN 所需的伺服器端元件。 伺服器端元件，包括設定 PKI 散發的使用者、 VPN 伺服器和 NPS 伺服器所使用的憑證。
ms.prod: windows-server-threshold
ms.technology: networking-ras
ms.topic: article
ms.assetid: ''
ms.localizationpriority: medium
ms.author: pashort
author: shortpatti
ms.date: 08/30/2018
ms.reviewer: deverette
ms.openlocfilehash: 21b494bea1990fb8424537205db483d977331465
ms.sourcegitcommit: 4893d79345cea85db427224bb106fc1bf88ffdbc
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/05/2018
ms.locfileid: "6067173"
---
# 步驟 2. 設定伺服器基礎結構

>適用於： Windows Server （半年度管道）、 Windows Server 2016、 Windows Server 2012 R2、 Windows 10

& #171; [**先前：** 步驟 1。規劃一律開啟的 VPN 部署](always-on-vpn-deploy-planning.md)<br>
& #187; [**下一步：** 步驟 3。一律在 VPN 設定的遠端存取伺服器](vpn-deploy-ras.md)


在此步驟中，您可以安裝及設定支援 VPN 所需的伺服器端元件。 伺服器端元件，包括設定 PKI 散發的使用者、 VPN 伺服器和 NPS 伺服器所使用的憑證。  您也可以設定 RRAS 支援 IKEv2 連線和 NPS 伺服器執行適用於 VPN 連線的授權。

## 在群組原則中設定憑證自動註冊
在此程序，以便自動要求網域成員的使用者和電腦憑證 」，群組原則設定網域控制站上。 如此一來，可讓 VPN 使用者要求，並擷取自動驗證 VPN 連線的使用者憑證。 同樣地，這項原則可讓 NPS 伺服器要求伺服器驗證憑證自動。 

在您手動註冊 VPN 伺服器上的憑證。

>[!TIP]
>對於非 domained 已加入的電腦，請參閱[CA 設定非網域加入電腦](#ca-configuration-for-non-domain-joined-computers)的下方。 因為 RRAS 伺服器不是已加入網域，自動註冊無法用來註冊 VPN 閘道憑證。  因此，使用離線憑證要求程序。 


1.  在網域控制站上開啟群組原則管理。

2.  在瀏覽窗格中，以滑鼠右鍵按一下您的網域 (例如，corp.contoso.com)，然後按一下**建立在這個網域中的 GPO 並連結到此處**。

3.  在新的 GPO] 對話方塊中，輸入**自動註冊原則**，然後按一下 **[確定]**。

4.  在瀏覽窗格中，以滑鼠右鍵按一下 [**自動註冊原則**，並按一下 [**編輯**]。

5.  在群組原則管理編輯器 」 中，請完成下列步驟，以設定電腦憑證自動註冊：

    1.  在瀏覽窗格中，按一下**電腦 Configuration\\Policies\\Windows Settings\\Security Settings\\Public 金鑰原則**。

    2.  在詳細資料窗格中，以滑鼠右鍵按一下 [**憑證服務用戶端 – 自動註冊**，並按一下 \ [**內容**。

    3.  在 [憑證服務用戶端 – 自動註冊內容] 對話方塊中，在 [**設定模型**中，按一下 [**啟用**]。

    4.  選取 [**更新到期的憑證，更新擱置中的憑證，並移除撤銷的憑證**，並**更新使用憑證範本的憑證**。

    5.  按一下 **[確定]**。

6.  在群組原則管理編輯器 」 中，請完成下列步驟，以設定使用者憑證自動註冊：

    1.  在瀏覽窗格中，按一下 [**使用者 Configuration\\Policies\\Windows Settings\\Security Settings\\Public 原則**。

    2.  在詳細資料窗格中，以滑鼠右鍵按一下 [**憑證服務用戶端 – 自動註冊**，並按一下 \ [**內容**。

    3.  在 [憑證服務用戶端 – 自動註冊內容] 對話方塊中，在 [**設定模型**中，按一下 [**啟用**]。

    4.  選取 [**更新到期的憑證，更新擱置中的憑證，並移除撤銷的憑證**，並**更新使用憑證範本的憑證**。

    5.  按一下 **[確定]**。

    6.  關閉 \[群組原則管理編輯器\]。

7.  關閉群組原則管理。

### CA 設定非網域加入的電腦

因為 RRAS 伺服器不是已加入網域，自動註冊無法用來註冊 VPN 閘道憑證。  因此，使用離線憑證要求程序。 

1. RRAS 在伺服器上，產生的檔案呼叫的**VPNGateway.inf**根據原則範例憑證要求提供附錄 （區段 0），以及自訂下列項目： 

   - 在 [NewRequest] 區段中，取代 vpn.contoso.com 用於主體名稱與所選 [_客戶_] VPN 端點 FQDN。

   - 在 [擴充功能] 區段中，取代 vpn.contoso.com 用於在主體替代名稱與所選 [_客戶_] VPN 端點 FQDN。

2. 儲存或將**VPNGateway.inf**檔案複製到所選的位置。

3. 從提升權限的命令提示字元中，瀏覽到資料夾包含**VPNGateway.inf**檔案和類型：

   ```
   certreq -new VPNGateway.inf VPNGateway.req
   ```

4. 將新建立的**VPNGateway.req**輸出檔案複製到憑證授權單位的伺服器或具有特殊權限存取工作站 （爪）。 

5. 儲存或將**VPNGateway.req**檔案複製到憑證授權單位的伺服器或具有特殊權限存取工作站 （爪） 上所選擇的位置。

6. 從提升權限的命令提示字元中，瀏覽至包含 VPNGateway.req 檔案類型與上一個步驟中建立的資料夾： 

   ```
   certreq -attrib “CertificateTemplate:[Customer]VPNGateway” -submit VPNgateway.req VPNgateway.cer
   ```

7. 如果系統提示由憑證授權單位清單視窗中，選取適當的企業 CA 服務憑證要求。

8. 將新建立的**VPNGateway.cer**輸出檔案複製到 RRAS 伺服器。 

9. 儲存或將**VPNGateway.cer**檔案複製到 RRAS 伺服器上所選擇的位置。

10. 從提升權限的命令提示字元中，瀏覽至包含 VPNGateway.cer 檔案類型與上一個步驟中建立的資料夾：
   
   ```
   certreq -accept VPNGateway.cer
   ```

11. 以所述[這裡](https://docs.microsoft.com/dotnet/framework/wcf/feature-details/how-to-view-certificates-with-the-mmc-snap-in)選取**的電腦帳戶**選項，以執行憑證 MMC 嵌入式管理單元。

12. 確保有效的憑證存在 RRAS 伺服器具有下列屬性：

   - **預期的用途：** 伺服器驗證，IP 安全性 IKE 中繼 

   - **憑證範本：**[_客戶_]VPN 伺服器

#### 範例： VPNGateway.inf 指令碼

您可以在此處看到用來要求使用的頻外的程序的 VPN 閘道憑證的憑證要求原則的範例指令碼。

>[!TIP]
>您可以在 VPN 提供 IP 套件的憑證要求原則資料夾下找到 VPNGateway.inf 指令碼的複本。 只更新的 「 主旨' 及 '\_continue\_' 與客戶的特定值。

```
[Version] 

Signature="$Windows NT$"

[NewRequest]
Subject = "CN=vpn.contoso.com"
Exportable = FALSE   
KeyLength = 2048     
KeySpec = 1          
KeyUsage = 0xA0      
MachineKeySet = True
ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
RequestType = PKCS10 

[Extensions]
2.5.29.17 = "{text}"
_continue_ = "dns=vpn.contoso.com&"

```

## 建立 VPN 使用者、 VPN 伺服器及 NPS 伺服器群組

在此程序時，您可以新增新的 Active Directory (AD) 群組，其中包含允許使用 VPN 連線到您的組織網路的使用者。

此群組有兩個用途：

-   它會定義哪些使用者允許 VPN 需要的使用者憑證自動註冊。

-   它會定義哪些使用者 NPS 授與權限針對 VPN 的存取權。

藉由使用自訂群組，如果您想要撤銷使用者的 VPN 存取權，您可以移除該使用者從群組。

您也可以新增包含 VPN 伺服器群組和另一個包含 NPS 伺服器的群組。 您可以使用這些群組來將憑證要求限制為其成員。

>[!NOTE] 
>我們建議您 VPN 的伺服器位於 DMA/周邊，不會加入網域。 不過，如果您想要擁有更好的管理性加入網域的 VPN 伺服器 （群組原則，備份/監視代理程式，沒有任何本機使用者管理，以此類推），然後新增 AD 群組的 VPN 伺服器憑證範本。

### 設定 VPN 使用者群組

1.  在網域控制站上開啟 Active Directory 使用者和電腦。

2.  容器或組織單位上按一下滑鼠右鍵、 按一下 [**新增]** ，按一下**群組**。

3.  在 [**群組名稱**，輸入**VPN 使用者**，然後按一下 **[確定]**。

4.  以滑鼠右鍵按一下**VPN 使用者**，並按一下 \ [**內容**。

5.  在 VPN 使用者內容對話方塊中的 [**成員**] 索引標籤中，按一下 [**新增**。

6.  在 [選取使用者] 對話方塊中，新增的所有使用者都需要 VPN 存取，並按一下 **[確定]**。

7.  關閉 Active Directory 使用者和電腦。

### 設定 VPN 伺服器和 NPS 伺服器群組

1.  在網域控制站上開啟 Active Directory 使用者和電腦。

2.  容器或組織單位上按一下滑鼠右鍵、 按一下 [**新增]** ，按一下**群組**。

3.  在 [**群組名稱**，輸入**VPN 伺服器**，然後按一下 **[確定]**。

4.  **VPN 伺服器**，以滑鼠右鍵按一下，然後按一下**屬性**。

5.  VPN 伺服器內容對話方塊中的 [**成員**] 索引標籤上按一下 \ [**加入**。

6.  按一下 [**物件類型**、 選取**電腦**] 核取方塊，並按一下 **[確定]**。

7.  在 [**輸入物件名稱來選取**，輸入您的 VPN 伺服器的名稱並按一下 **[確定]**。

8.  按一下 **[確定]** 以關閉 VPN 伺服器內容] 對話方塊。

9.  NPS 伺服器群組重複上一個步驟。

10. 關閉 Active Directory 使用者和電腦。

## 建立使用者驗證範本

在此程序時，您可以設定自訂的用戶端-伺服器驗證範本。 此範本是必要的因為您想要藉由選取已升級的相容性層級改善憑證的整體安全性並選擇 Microsoft 平台密碼編譯提供者。 這最後一項變更，可讓您用戶端電腦上使用 TPM 來保護憑證。 如需 TPM 的概觀，請參閱[信賴平台模組技術概觀](https://docs.microsoft.com/windows/device-security/tpm/trusted-platform-module-overview)。

**程序：**

1.  在 CA 上，開啟憑證授權單位。

2.  在瀏覽窗格中，以滑鼠右鍵按一下 [**憑證範本**，並按一下 [**管理**。

3.  在憑證範本主控台中，**使用者**，以滑鼠右鍵按一下，然後按一下**重複的範本**。

    >[!WARNING]
    >請勿在步驟 10 之前，隨時按**套用**或**確定**。  如果您按一下這些按鈕輸入所有參數之前，許多選擇會變成固定且不會再可編輯。 例如，**密碼編譯**索引標籤中，如果_傳統密碼編譯儲存提供者_顯示在提供者類別目錄欄位中，它會變成停用，避免任何進一步的變更。 唯一的替代方法是刪除的範本並重新建立它。  

4.  在新範本的內容] 對話方塊中，在**一般**索引標籤中，請完成下列步驟：

    1.  在 [**範本顯示名稱**，輸入**VPN 使用者驗證**。

    2.  **在 Active Directory 中的發行憑證**核取方塊。

5.  **安全性**索引標籤中，請完成下列步驟：

    1.  按一下 **\[新增\]**。

    2.  在 [選取使用者、 電腦、 服務帳戶或群組對話方塊中，輸入**VPN 使用者**，並按一下 **[確定]**。

    3.  在**群組或使用者名稱**，按一下 [ **VPN 使用者**]。

    4.  在**VPN 使用者的權限**，選取 [**允許**] 欄中**註冊**和**自動註冊**核取方塊。

       >[!TIP]
       >請務必保持選取讀取核取方塊。 換句話說，您需要註冊的讀取權限。 

    5.  在**群組或使用者名稱**，按一下**網域使用者**，然後按一下 [**移除**。

6.  在**相容性**] 索引標籤，請完成下列步驟：

    1.  在**憑證授權單位**，請按一下 [ **Windows Server2012R2**。

    2.  **Resulting 變更**] 對話方塊上，按一下 **[確定]**。

    3.  在**憑證收件者**中, 按一下**Windows8.1/Windows Server2012R2**。

    4.  **Resulting 變更**] 對話方塊上，按一下 **[確定]**。

7.  **要求處理**索引標籤中，清除 [**允許私密金鑰匯出**核取方塊。

8.  **密碼編譯**索引標籤中，請完成下列步驟：

    1.  在**提供者類別**中，按一下**金鑰儲存提供者**。

    2.  按一下**要求必須使用下列的提供者的其中一個**。

    3.  選取 [ **Microsoft 平台密碼編譯提供者**] 核取方塊。

9.  **主體名稱**索引標籤中，如果您不需要的所有使用者帳戶上所列的電子郵件地址，請清除**主體名稱中的包含電子郵件名稱**和**電子郵件名稱**的核取方塊。

10. 按一下 **[確定]** 儲存 VPN 使用者驗證憑證範本。

11. 關閉 theCertificate 範本主控台。

12. 在瀏覽窗格中的 theCertification Authoritysnap-中，以滑鼠右鍵按一下 [**憑證範本**，按一下 [**新增]** ，然後按一下**要發出的憑證範本**。

13. 按一下 [**VPN 使用者驗證**，並按一下 **[確定]**。

14. 關閉 theCertification 授權單位嵌入式管理單元。

## 建立 VPN 伺服器驗證範本

在此程序，您可以設定新的伺服器驗證範本適用於您的 VPN 伺服器。 新增 IP 安全性 (IPsec) IKE 中繼應用程式原則可讓篩選憑證的伺服器，如果有可用的伺服器驗證多個憑證擴充金鑰使用方法。

>[!IMPORTANT] 
>由於 VPN 用戶端從公用網際網路存取此伺服器，主旨及替代名稱是不同於內部伺服器名稱。 如此一來，您無法自動註冊此憑證 VPN 伺服器上。

**先決條件：**<p>
加入網域的 VPN 伺服器

**程序：** 

1.  在 CA 上，開啟憑證授權單位。

2.  在瀏覽窗格中，以滑鼠右鍵按一下 [**憑證範本**，並按一下 [**管理**。

3.  在憑證範本主控台中，以滑鼠右鍵按一下**RAS 和 IAS 伺服器**，然後按一下**重複的範本**。

4.  在新範本的內容] 對話方塊中，在**一般**索引標籤中，在 [**範本顯示名稱**，請輸入，例如**VPN 伺服器驗證**或**RADIUS 伺服器**的 VPN 伺服器的描述性名稱。

5.  **擴充功能**索引標籤中，請完成下列步驟：

    1.  按一下**應用程式原則**，然後按一下 [**編輯**。

    2.  在 [**編輯應用程式原則延伸**] 對話方塊中，按一下 [**新增**。

    3.  在 [**新增應用程式原則**] 對話方塊中，按一下**IP 安全性 IKE 中繼**]，按一下 **[確定]**。<p>新增 IP 安全性 IKE 中繼 EKU 到可協助在一個以上的伺服器驗證憑證 VPN 伺服器存在的情況下。 IP 安全性 IKE 中繼存在時，IPSec 只使用憑證驗證這兩個 EKU 的選項。 沒有這麼做，IKEv2 驗證可能會失敗，錯誤 13801： 是極 IKE 驗證認證。

    4.  按一下 **[確定]** 回到**新範本的屬性**對話方塊。

6.  **安全性**索引標籤中，請完成下列步驟：

    1.  按一下 **\[新增\]**。

    2.  在 [**選取使用者、 電腦、 服務帳戶或群組**] 對話方塊中，輸入**VPN 伺服器**，並按一下 **[確定]**。

    3.  在**群組或使用者名稱**，按一下 [ **VPN 伺服器**。

    4.  在**VPN 伺服器的權限**，選取 [**允許**] 欄中的 [**註冊**] 核取方塊。

    5.  在**群組或使用者名稱**，按一下 \ [ **RAS 和 IAS 伺服器**，並按一下 [**移除**。

7.  在 [**主體名稱**] 索引標籤，請完成下列步驟：

    1.  按一下 [**在要求中提供**。

    2.  在 [**憑證範本**警告對話方塊中，按一下 **[確定]**。

8.  （選擇性）*如果您設定的 VPN 連線的條件式存取*，**要求處理**] 索引標籤，然後按一下**允許私密金鑰匯出**來選取它。

9.  按一下 **[確定]** 儲存 VPN 伺服器憑證範本。

10. 關閉 theCertificate 範本主控台。

11. 在 thenavigation 窗格中的 Authoritysnap 中憑證，**憑證範本**上按一下滑鼠右鍵，按一下 [**新增]** ，然後按一下**要發出的憑證範本**。

12. 重新啟動的憑證授權單位服務。

13. 選取您在步驟 4 中，選擇的名稱，然後按一下 **[確定]**。

14. 關閉 theCertification 授權單位嵌入式管理單元。

## 建立 NPS 伺服器驗證範本

若要建立的第三個和最後一個憑證範本是 NPS 伺服器驗證範本。 NPS 伺服器驗證範本是簡單的保護，您稍早在本區段中建立的 NPS 伺服器群組 RAS 和 IAS 伺服器範本的複本。 

您將設定為自動註冊此憑證。

**程序：**

1.  在 CA 上，開啟憑證授權單位。

2.  在瀏覽窗格中，以滑鼠右鍵按一下 [**憑證範本**，並按一下 [**管理**。

3.  在憑證範本主控台中，以滑鼠右鍵按一下**RAS 和 IAS 伺服器**，並選取**重複的範本**。

4.  在新範本的內容] 對話方塊中，在**一般**索引標籤，在 [**範本顯示名稱**，輸入**NPS 伺服器驗證**。

5.  **安全性**索引標籤中，請完成下列步驟：

    1.  按一下 **\[新增\]**。

    2.  在 [**選取使用者、 電腦、 服務帳戶或群組**] 對話方塊中，輸入**NPS 伺服器**，並按一下 **[確定]**。

    3.  在**群組或使用者名稱**，按一下 [ **NPS 伺服器**。

    4.  在**NPS 伺服器的權限**，選取 [**允許**] 欄中**註冊**和**自動註冊**核取方塊。

    5.  在**群組或使用者名稱**，按一下 \ [ **RAS 和 IAS 伺服器**，並按一下 [**移除**。

6.  按一下 **[確定]** 儲存 NPS 伺服器憑證範本。

7.  關閉 theCertificate 範本主控台。

8.  在 thenavigation 窗格中的 Authoritysnap 中憑證，**憑證範本**上按一下滑鼠右鍵，按一下 [**新增]** ，然後按一下**要發出的憑證範本**。

9.  按一下 [**NPS 伺服器驗證**，並按一下 **[確定]**。

10. 關閉 theCertification 授權單位嵌入式管理單元。

## 註冊和驗證的使用者憑證

因為您使用群組原則自動註冊使用者的憑證，您只需要更新原則，以及 windows 10 會自動註冊的正確憑證的使用者帳戶。 然後您可以使用驗證憑證主控台中的憑證。

**程序：**

1.  **VPN 使用者**群組的成員登入加入網域的用戶端電腦。

2.  按下 Windows 鍵 + R 中輸入**gpupdate /force**，然後按 enter 鍵。

3.  [開始] 功能表中，輸入**certmgr.msc**，然後按 enter 鍵。

4.  在 [憑證嵌入式管理單元中，按一下 [**個人**] 底下的 [**憑證**]。 您的憑證會出現在詳細資料窗格中。

5.  以滑鼠右鍵按一下您目前網域、 使用者名稱的憑證，然後按一下 [**開啟**。

6.  **一般**索引標籤中，確認，**從有效**底下所列的日期為目前的日期。 如果沒有，您可能已選取了錯誤的憑證。

7.  按一下 **[確定]**，並關閉 [憑證] 嵌入式管理單元中。

## 註冊和驗證伺服器憑證

不同於使用者的憑證，您必須手動註冊 VPN 伺服器的憑證。 您已經註冊它之後，驗證它使用您用於使用者憑證相同的程序。 使用者的憑證，例如 NPS 伺服器自動註冊其驗證憑證，因此您需要做的就是驗證它。

>[!NOTE] 
>您可能需要重新啟動的 VPN 和 NPS 伺服器以允許他們更新其群組成員資格，才能完成這些步驟。

### 註冊和驗證 VPN 伺服器憑證

1.  VPN 伺服器的 [開始] 功能表中，輸入**certlm.msc**，然後按 enter 鍵。

2.  以滑鼠右鍵按一下**個人**，按一下 [**所有工作**，然後都按一下以開始憑證註冊精靈**要求新憑證**。

3.  在 \[開始之前\] 頁面上，按一下 **\[下一步\]**。

4.  在選取憑證註冊原則頁面上，按一下 [**下一步**。

5.  在要求憑證頁面上，按一下 [VPN 伺服器來選取它旁邊的核取方塊。

6.  VPN 伺服器核取方塊下的 [**更多的資訊是必要的**開啟憑證屬性對話方塊中，請完成下列步驟：

    1.  按一下 [**主體**] 索引標籤，按一下 [下**主體名稱**、**類型**中**常見的名稱**。

    2.  **主體名稱**，在 [**值**] 底下輸入的外部網域的用戶端用來連線到 VPN，例如，vpn.contoso.com 名稱，然後按一下**新增**。

    3.  按一下下方的**替代名稱****類型**，在**DNS**。

    4.  **替代名稱**下,**值**，在輸入所有的伺服器名稱用戶端用來連線到 VPN，例如，vpn.contoso.com、 vpn、 132.64.86.2。

    5.  輸入每個名稱後，按一下 [**新增**。

    6.  完成時，請按一下 [**確定**]。

7.  按一下 [**註冊**]。

8.  按一下 **\[完成\]**。

9.  在 [憑證嵌入式管理單元中，按一下 [**個人**] 底下的 [**憑證**]。<p>列出的憑證會出現在詳細資料窗格中。

10. 以滑鼠右鍵按一下您的 VPN 伺服器名稱的憑證，然後按一下 [**開啟**。

11. **一般**索引標籤中，確認，**從有效**底下所列的日期為目前的日期。 如果沒有，您可能已選取正確的憑證。

12. 在 [**詳細資料**] 索引標籤中，按一下**增強金鑰使用方法**，並確認**IP 安全性 IKE 中繼**和**伺服器驗證**顯示清單中。

13. 按一下 **[確定]** 以關閉憑證。

14. 關閉 [憑證] 嵌入式管理單元中。

### 驗證 NPS 伺服器憑證

1.  重新啟動 NPS 伺服器。

2.  在 NPS 伺服器的 [開始] 功能表中，輸入**certlm.msc**，並按 enter 鍵。

3.  在 [憑證嵌入式管理單元中，按一下 [**個人**] 底下的 [**憑證**]。<p>列出的憑證會出現在詳細資料窗格中。

4.  以滑鼠右鍵按一下具有 NPS 伺服器的名稱的憑證，然後按一下 [**開啟**。

5.  **一般**索引標籤中，確認，**從有效**底下所列的日期為目前的日期。 如果沒有，您可能已選取正確的憑證。

6.  按一下 **[確定]** 以關閉憑證。

7.  關閉 [憑證] 嵌入式管理單元中。

## 後續步驟
[步驟 3。設定遠端存取伺服器使用 Always On VPN](vpn-deploy-ras.md)： 在此步驟中，您可以設定允許 IKEv2 VPN 連線、 拒絕來自其他 VPN 通訊協定，連線，並將靜態的 IP 位址集區，以便發行憑證的 IP 位址指派給連線的遠端存取 VPN授權的 VPN 用戶端。







---
