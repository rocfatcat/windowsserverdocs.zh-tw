---
title: 部署 Hyper-V 複本
ms.technology: compute-hyper-v
description: 提供指示來設定複本、 測試容錯移轉，以及執行第一次複寫。
ms.prod: windows-server-threshold
ms.service: na
manager: dongill
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
author: KBDAzure
ms.author: kathydav
ms.date: 10/10/2016
ms.openlocfilehash: b8dcf23946d99509aafba0f8af58bf633bedd069
ms.sourcegitcommit: afb0602767de64a76aaf9ce6a60d2f0e78efb78b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/20/2019
ms.locfileid: "67280227"
---
# <a name="set-up-hyper-v-replica"></a>部署 Hyper-V 複本

>適用於：Windows Server 2016

Hyper-V 複本是 Hyper-V 角色中不可或缺的一部分。 它將提供災害復原策略，藉由從一部 HYPER-V 主機伺服器的虛擬機器複寫至另一個則是讓您可用的工作負載。  HYPER-V 複本會建立一份複本離線虛擬機器的即時虛擬機器。 請注意下列事項：  

-   **HYPER-V 主機**:主要和次要主機伺服器可以位於相同實體位置，或在不同的地理位置，以透過 WAN 複寫連結。 HYPER-V 主機可以是獨立的叢集或兩者的混合。 在伺服器之間沒有任何 Active Directory 相依性，它們不需要是網域成員。  

-   **複寫和變更追蹤**:當您針對特定的虛擬機器啟用 HYPER-V 複本時，初始複寫會建立次要主機伺服器上相同的複本虛擬機器。 發生這種情況之後，HYPER-V 複本的變更追蹤會建立並維護虛擬機器 VHD 上的變更擷取的記錄檔。 記錄檔，就會以反向順序播放到複本的複寫頻率設定為基礎的 VHD。 這表示最新的變更會儲存，並以非同步方式複寫。 複寫可以透過 HTTP 或 HTTPS。  

-   **擴充 （鏈結） 的複寫**:這可讓您從主要主機至次要複本主機到第三個裝載的次要主機、，然後複寫來複寫虛擬機器。 請注意您無法直接到第二個和第三個主要主機上進行複寫。  

    這項功能可讓 HYPER-V 複本更強固的災害復原因為中斷時可以復原從主要和延伸複本。  您可以容錯移轉到延伸複本如果您的主要和次要位置當機。 請注意，延伸的複本不支援應用程式一致複寫，而且必須使用相同的次要複本所使用的 Vhd。  

-   **容錯移轉**:如果您的主要伺服器發生故障 （或擴充中的案例中的次要複本） 位置，您可以手動起始已規劃、 測試或非計劃性容錯移轉。  

    ||測試|計劃中|非計劃之中|  
    |-|--------|-----------|-------------|  
    |我何時應該執行？|請確認虛擬機器可以容錯移轉，並在次要站台啟動<br /><br />適用於測試和訓練|在計劃性的停機和中斷期間|在發生未預期的事件時|  
    |建立重複的虛擬機器嗎？|是|否|否|  
    |其中它為何？|複本虛擬機器上|在主要機器起始上，在次要機器上完成|複本虛擬機器上|  
    |我執行的頻率？|我們建議您每月一次進行測試|一次每六個月或符合合規性需求|只有當發生災害時無法使用主要虛擬機器時|  
    |主要虛擬機器是否繼續複寫？|是|是的。 在中斷情形解決反轉複寫方向變更傳回給主要站台，以便同步處理主要和次要的複寫。|否|  
    |是否有任何資料遺失？|None|無。 在容錯移轉之後 HYPER-V 複本會複寫回到主要，以確保資料零遺失最後一組追蹤變更。|取決於事件和復原點|  
    |是否有任何停機時間？|無。 它不會影響您的生產環境。 它在容錯移轉期間建立重複的測試虛擬機器。 在您選取的容錯移轉完成後**容錯移轉**針對複本虛擬機器，並已自動清除和刪除。|計劃的中斷的持續時間|未規劃的中斷的持續時間|  

-   **復原點**:當您設定虛擬機器的複寫設定時，您會指定您想要從它所儲存的復原點。 復原點代表快照集，您可以復原的虛擬機器的時間。 如果您從最近的復原點復原，顯然是較少的資料會遺失。 您可以存取復原點最多 24 小時。  

## <a name="deployment-prerequisites"></a>部署先決條件  
以下是您應該確認在您開始之前：  

-   **找出哪些 Vhd 需要被複寫**。 特別是，Vhd，會包含資料變更很快且不使用複本伺服器之後容錯移轉，例如頁面檔案磁碟，應該排除不要複寫，以節省網路頻寬。 記下哪些 Vhd 可以排除。  

-   **決定您要同步處理資料的頻率**:複本伺服器上的資料會同步處理更新，根據您設定 （30 秒、 5 分鐘或 15 分鐘） 的複寫頻率。 您所選擇的頻率應該考慮下列各項：虛擬機器會具有低 RPO 執行重要資料嗎？ 有哪些？ 您的頻寬考量  您相當重要的虛擬機器很明顯地需要更頻繁的複寫。  

-   **決定如何復原資料**:根據預設 HYPER-V 複本只會儲存單一的復原點將會傳送從主要到次要的最新複寫。 不過如果您想要將資料復原到較早時間點的時間選項可以指定其他復原點，應該儲存 （以 24 小時的點最多）。 如果您需要額外的復原點，您應該注意，這需要更多的額外負荷的處理和儲存體資源。  

-   **找出您要複寫哪些工作負載**:標準 HYPER-V 複本複寫中維持一致的虛擬機器作業系統的容錯移轉之後狀態，但不是應用程式的狀態在虛擬機器上執行。 如果您想要能夠復原您的工作負載狀態，您可以建立應用程式一致復原點。 請注意，應用程式一致復原不提供擴充的複本站台上是否您使用延伸 （鏈結） 的複寫。  

-   **決定如何執行初始複寫的虛擬機器資料**:複寫會開始傳輸來傳輸虛擬機器的目前狀態的需求。 這個初始狀態可以直接透過現有網路傳送，它可以立即傳送或在您設定的稍後時間傳送。 您也可以使用預先存在的還原的虛擬機器 （例如，如果您已還原較早的備份複本伺服器上的虛擬機器） 當做初始複本。 或者，將初始複本複製到外部媒體，然後再將媒體實體送到複本站台，即可節省網路頻寬。  如果您想要使用預先存在的虛擬機器就會刪除所有與其相關聯的上一個快照集。  

## <a name="deployment-steps"></a>部署步驟  

### <a name="step-1-set-up-the-hyper-v-hosts"></a>步驟 1：設定 HYPER-V 主機  
您必須至少兩個與每一部伺服器上的一或多個虛擬機器的 HYPER-V 主機。 [開始使用 HYPER-V](../get-started/Get-started-with-Hyper-V-on-Windows.md)。 您要複寫虛擬機器的主機伺服器必須設定為複本伺服器。  

1.  在 HYPER-V 設定，伺服器會將虛擬機器複寫，**複寫組態**，選取**啟用此電腦做為複本伺服器**。  

2.  您可以透過 HTTP 或 HTTPS 加密複寫。 選取 **使用 Kerberos (HTTP)** 或是**使用憑證式驗證 (HTTPS**)。 根據預設會啟用 HTTP 80 以及 HTTPS 443 為複本 HYPER-V 伺服器上的防火牆例外狀況。 如果您變更預設通訊埠設定，您必須也變更防火牆例外狀況。 如果您透過 HTTPS 進行複寫，您必須選取憑證，而且您應該已經設定的憑證驗證。  

3.  進行授權，請選取**允許從任何已驗證的伺服器的複寫**允許複本伺服器接受任何成功通過驗證的主要伺服器的虛擬機器複寫流量。 選取 **允許來自指定伺服器的複寫**接受只能從您特別選取主要伺服器的流量。  

    這兩個選項中，您可以指定複寫的 Vhd 複本 HYPER-V 伺服器上的儲存。  

4.  按一下 [**確定**] 或 [**套用**]。  

### <a name="step-2-set-up-the-firewall"></a>步驟 2：設定防火牆  
若要允許在主要和次要伺服器之間的複寫，流量必須通過 Windows 防火牆 （或任何其他協力廠商防火牆）。 當您安裝 HYPER-V 角色的伺服器上的 HTTP (80) 的預設例外狀況，並建立 HTTPS (443)。 如果您使用這些標準的連接埠，您就必須啟用規則：  

-  若要啟用獨立的主機伺服器上的規則：  

    1. 開啟具有進階安全性的 Windows 防火牆，然後按一下**輸入規則**。  

    2. 若要啟用 HTTP (Kerberos) 驗證，以滑鼠右鍵按一下**HYPER-V 複本 HTTP 接聽程式 (Tcp-in)**  >**啟用規則。** 若要啟用 HTTPS 憑證型驗證，以滑鼠右鍵按一下**HYPER-V 複本 HTTPS 接聽程式 (Tcp-in)** > E**啟用規則**。  

-  若要啟用 HYPER-V 叢集上的規則，請開啟 Windows PowerShell 工作階段，使用**系統管理員身分執行**，然後執行其中一個命令：  

    -   若為 HTTP:  `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`  

    -   HTTPS: `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`  

### <a name="enable-virtual-machine-replication"></a>啟用虛擬機器複寫  
執行您想要複寫的每部虛擬機器上的下列動作：  

1.  在 **詳細資料**窗格的 HYPER-V 管理員 中，按一下以選取虛擬機器。  
    以滑鼠右鍵按一下選取的虛擬機器，然後按一下 **啟用複寫**以開啟 啟用複寫 精靈。  

2.  在 [在您開始前]  頁面上，按 [下一步]  。  

3.  在 [**指定複本伺服器**] 頁面上，在複本伺服器] 方塊中，輸入 [NetBIOS 或複本伺服器的 FQDN。 如果複本伺服器是容錯移轉叢集的一部分，請輸入 HYPER-V 複本代理人的名稱。 按一下 [下一步]  。  

4.  在 [**指定連線參數**] 頁面上，HYPER-V 複本會自動擷取設定複本伺服器的驗證和連接埠設定。 如果值不要擷取伺服器已設定為複本伺服器，並註冊在 DNS 中的核取。 如有必要的設定中的型別以手動方式。  

5.  在 **選擇複寫 Vhd**頁面上，確定您想要複寫的 Vhd 已選取，然後清除您想要從複寫排除任何 Vhd 的核取方塊。 然後按一下 [下一步]  。  

6.  在 **設定複寫頻率**頁面上，指定頻率變更應同步處理從主要到次要區域。 然後按一下 [下一步]  。  

7.  在 **設定其他復原點**頁面上，選取您想要維護的最新復原點，或建立其他的點。    如果您想要以一致的方式復原應用程式，並擁有自己的 VSS 寫入器，我們建議您的工作負載選取**磁碟區陰影複製服務 (VSS) frequenc**y 並指定建立應用程式一致快照的頻率。 請注意，必須在這兩個主要和次要 HYPER-V 伺服器上執行 HYPER-V 的 VMM 要求者服務。 然後按一下 [下一步]  。  

8.  在 **選擇初始複寫**頁面上，選取要使用的初始複寫方法。  預設值，以傳送透過網路初始複本會將主要虛擬機器組態檔 (VMCX) 和虛擬硬碟檔案 （VHDX 和 VHD） 複製您選取透過您的網路連線。 如果您要使用此選項，請確認網路頻寬可用性。 如果主要虛擬機器已設定為複寫的虛擬機器在次要網站上它可用來選取**複寫伺服器上的現有虛擬機器作為初始複本**。 您可以使用 HYPER-V 匯出到匯出主要虛擬機器和它匯入為次要伺服器上的複本虛擬機器。 針對較大的虛擬機器或有限的頻寬，您可以其選擇初始複寫的網路上發生一次更新版本，然後設定 離峰時間，或以離線媒體傳送的初始複寫資訊。  

    如果您進行離線複寫會傳輸到次要伺服器使用的外部的儲存媒體，例如硬碟或 USB 磁碟機的初始複本。 若要這樣做您要連接的外部儲存體以主要伺服器 （或在叢集中的擁有者節點），然後當您選取傳送初始複製使用外部媒體，您可以指定的位置，在本機或外部媒體上儲存初始複本的位置。  預留位置的虛擬機器會建立在複本站台上。 初始複寫完成之後的外部儲存體可以寄送到複本站台。 那里您將外部媒體連接至次要伺服器或次要叢集的擁有者節點。 您將匯入至指定位置的初始複本，並將其合併到預留位置虛擬機器。  

9. 在 **完成啟用複寫**頁面上，檢閱摘要中的資訊，然後按一下**完成。** 。 虛擬機器傳輸的資料會根據您所選擇的設定。 會出現一個對話方塊，指出已成功啟用複寫。  

10. 如果您想要設定延伸 （鏈結） 的複寫，開啟 複本伺服器，並以滑鼠右鍵按一下您想要複寫的虛擬機器。 按一下 **複寫** > **延伸複寫**以及指定複寫設定。  

## <a name="run-a-failover"></a>執行容錯移轉  
完成這些部署步驟之後複寫的環境已啟動並執行。 現在您也可以視需要執行容錯移轉。  

**測試容錯移轉**:如果您想要執行測試容錯移轉以滑鼠右鍵按一下主要虛擬機器，然後選取**複寫** > **測試容錯移轉**。 如果設定，請挑選最新或其他復原點。 將建立新的測試虛擬機器，並將其啟動次要站台上。 您已完成測試之後，請選取**停止測試容錯移轉**在複本虛擬機器，將它清除。 請注意，您只能執行一個虛擬機器測試容錯移轉一次。 [深入了解](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx)。  

**規劃的容錯移轉**:主要虛擬機器執行規劃的容錯移轉以滑鼠右鍵按一下並選取**複寫** > **計劃性容錯移轉**。 規劃的容錯移轉會執行必要條件檢查，以確保資料零遺失。 它會檢查主要虛擬機器已關機再開始容錯移轉。 虛擬機器容錯移轉之後，它會開始將變更複寫回主要站台，可用時。 請注意，針對此目的的主要伺服器應該設定為接收的複寫中，從次要伺服器，或從 HYPER-V 複本代理人，在主要叢集的情況下。 規劃的容錯移轉會傳送最後一個設定的追蹤修訂。 [深入了解](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx)。  

**非計劃性容錯移轉**:若要執行非計劃性容錯移轉，以滑鼠右鍵按一下複本虛擬機器，然後選取**複寫** > **非計劃性容錯移轉**從 HYPER-V 管理員] 或 [容錯移轉叢集管理員。 如果啟用此選項時，您可以復原最新的復原點，或從先前的復原點。 容錯移轉之後，檢查一切是否正常運作如預期般在容錯移轉的虛擬機器，然後按一下**完成**複本虛擬機器上。 [深入了解](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx)。  
