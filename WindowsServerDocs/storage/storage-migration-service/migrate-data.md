---
title: 使用儲存體遷移服務遷移檔案伺服器
description: 搜尋引擎結果主題的簡短描述
author: jasongerend
ms.author: jgerend
manager: elizapo
ms.date: 02/13/2019
ms.topic: article
ms.prod: windows-server
ms.technology: storage
ms.openlocfilehash: 20aa5fbc40efc5a3a439361dadfac0f47f4b41d8
ms.sourcegitcommit: 07c9d4ea72528401314e2789e3bc2e688fc96001
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/29/2020
ms.locfileid: "76822621"
---
# <a name="use-storage-migration-service-to-migrate-a-server"></a>使用儲存體遷移服務來遷移伺服器

本主題討論如何使用[儲存體遷移服務](overview.md)和 Windows 系統管理中心，將伺服器（包括其檔案和設定）遷移至另一部伺服器。 當您安裝服務並開啟任何必要的防火牆埠之後，遷移會執行三個步驟：清查您的伺服器、傳輸資料，以及切換到新的伺服器。

## <a name="step-0-install-storage-migration-service-and-check-firewall-ports"></a>步驟0：安裝儲存體遷移服務並檢查防火牆埠

開始之前，請先安裝儲存體遷移服務，並確定所需的防火牆埠已開啟。

1. 檢查[存放裝置遷移服務需求](overview.md#requirements)，並在您的電腦或管理伺服器上安裝[Windows 系統管理中心](../../manage/windows-admin-center/understand/windows-admin-center.md)（如果您尚未這麼做的話）。 如果要遷移已加入網域的來源電腦，您必須在與來源電腦聯結至相同網域或樹系的伺服器上，安裝並執行儲存體遷移服務。
2. 在 Windows 系統管理中心，連接到執行 Windows Server 2019 的 orchestrator 伺服器。 <br>這是您將用來安裝儲存體遷移服務並用於管理遷移的伺服器。 如果您只是要遷移一部伺服器，您可以使用目的地伺服器，只要它正在執行 Windows Server 2019 即可。 我們建議您針對任何多伺服器遷移使用不同的協調流程伺服器。
3. 移至**伺服器管理員**（在 Windows 系統管理中心） >**儲存體遷移服務**，然後選取 [**安裝**] 以安裝儲存體遷移服務及其必要元件（如 [圖 1] 所示）。
    ![儲存體遷移服務頁面的螢幕擷取畫面，其中顯示 [安裝] 按鈕](media/migrate/install.png)**圖1：安裝儲存體遷移服務**
4. 在執行 Windows Server 2019 的所有目的地伺服器上安裝儲存體遷移服務 proxy。 這會使在目的地伺服器上安裝時的傳送速率加倍。 <br>若要這麼做，請連線到 Windows 管理中心的目的地伺服器，然後移至**伺服器管理員**（在 Windows 系統管理中心） >**角色和功能**，>**功能**，選取 儲存體 **遷移服務 Proxy**，然後選取 **安裝**。 
5. 如果您想要在 Windows 容錯移轉叢集之間進行遷移，請在 orchestrator 伺服器上安裝容錯移轉叢集工具。 <br>若要這麼做，請連接到 Windows 管理中心的 orchestrator 伺服器，然後移至**伺服器管理員**（在 Windows 系統管理中心） >**角色及功能**，>**功能**，>**遠端伺服器管理工具**，>**功能管理工具**，選取 **容錯移轉叢集工具**，然後選取 **安裝**。 
6. 在所有來源伺服器上，以及任何執行 Windows Server 2012 R2 或 Windows Server 2016 的目的地伺服器上，于 Windows 系統管理中心連線到每部伺服器，移至**伺服器管理員**（在 Windows 系統管理中心） >**防火牆** > 內送**規則**，然後檢查是否已啟用下列規則：
    - 檔案及印表機共用 (SMB-In)
    - Netlogon 服務（NP-IN）
    - Windows Management Instrumentation （DCOM）
    - Windows Management Instrumentation (WMI-In)

   如果您使用的是協力廠商防火牆，則要開啟的輸入埠範圍是 TCP/445 （SMB）、TCP/135 （RPC/DCOM 端點對應程式）和 TCP 1025-65535 （RPC/DCOM 暫時埠）。 儲存體遷移服務埠為 TCP/28940 （Orchestrator）和 TCP/28941 （Proxy）。

7. 如果您使用協調器伺服器來管理遷移，而且您想要下載事件或所傳輸之資料的記錄檔，請檢查該伺服器是否已啟用 [檔案及印表機共用（SMB）] 防火牆規則。

## <a name="step-1-create-a-job-and-inventory-your-servers-to-figure-out-what-to-migrate"></a>步驟1：建立作業並清查您的伺服器，以找出要遷移的內容

在此步驟中，您會指定要遷移哪些伺服器，然後掃描它們以收集其檔案和設定的相關資訊。

1. 選取 [**新增作業**]，將作業命名為，然後選取是否要遷移使用 Samba 的 Windows 伺服器和叢集或 Linux 伺服器。 然後選取 **[確定]** 。
2. 在 [**輸入認證**] 頁面上，輸入可在您要從中遷移之伺服器上執行的系統管理員認證，然後選取 **[下一步]** 。 <br>如果您要從 Linux 伺服器進行遷移，請改為在**Samba 認證**和**Linux 認證**頁面上輸入認證，包括 SSH 密碼或私密金鑰。 

3. 選取 [**新增裝置**]，輸入來源伺服器名稱或叢集檔案伺服器的名稱，然後選取 **[確定]** 。 <br>針對您想要清查的任何其他伺服器重複此動作。

4. 選取 [**開始掃描**]。<br>當掃描完成時，頁面會更新以顯示。
    ![螢幕擷取畫面，顯示已準備好掃描的伺服器](media/migrate/inventory.png)**圖2：清查伺服器**
5. 選取每部伺服器以檢查已清查的共用、設定、網路介面卡和磁片區。 <br><br>儲存體遷移服務不會傳輸我們知道可能會干擾 Windows 操作的檔案或資料夾，因此在此版本中，您會看到位於 Windows system 資料夾中的任何共用的警告。 您必須在傳輸階段略過這些共用。 如需詳細資訊，請參閱[從傳輸中排除哪些檔案和資料夾](faq.md#what-files-and-folders-are-excluded-from-transfers)。
6. 選取 **[下一步]** 以繼續傳輸資料。

## <a name="step-2-transfer-data-from-your-old-servers-to-the-destination-servers"></a>步驟2：將資料從舊伺服器傳送到目的地伺服器

在此步驟中，您會在指定要將資料放在目的地伺服器上的位置之後，將它傳輸。

1. 在 [**傳送資料** > **輸入認證**] 頁面上，輸入可在您要遷移目的地伺服器上使用的系統管理員認證，然後選取 **[下一步]** 。
2. 在 [**新增目的地裝置和**對應] 頁面上，會列出第一部來源伺服器。 輸入您要遷移的伺服器或叢集檔案伺服器的名稱，然後選取 [**掃描裝置**]。 如果是從已加入網域的來源電腦進行遷移，則目的地伺服器必須加入相同的網域。 您也可以按一下 [建立新的 Azure VM]，然後使用嚮導在 Azure 中部署新的目的地伺服器。 這會自動調整您的 VM 大小、布建存放裝置、格式化磁片、加入網域，以及將儲存體遷移服務 proxy 新增至 Windows Server 2019 目的地。 您可以從 Windows Server 2019 （建議選項）、Windows Server 2016 和 Windows Server 2012 R2 Vm 中選擇任何大小，並使用受控磁片。   

 > [!NOTE]
   > 使用「建立新的 Azure VM」需要您具備：
   > - 有效的 Azure 訂用帳戶。
   > - 您擁有建立許可權的現有 Azure 計算資源群組。
   > - 現有的 Azure 虛擬網路和子網。 
   > - 系結至虛擬網路和子網的 Azure Express Route 或 VPN 解決方案，允許從這個 Azure IaaS VM 連線到您的內部部署用戶端、網域控制站、儲存體遷移服務協調器電腦、Windows 系統管理中心電腦、和要遷移的來源電腦。

3. 將來源磁片區對應到目的地磁片區，清除您不想要傳輸的任何共用（包括位於 Windows system 資料夾中的任何系統管理共用）的 [**包含**] 核取方塊，然後選取 **[下一步]** 。
   ![螢幕擷取畫面，其中顯示來源伺服器及其磁片區和共用，以及它們在目的地的傳輸位置](media/migrate/transfer.png)**圖3：來源伺服器及其存放裝置將傳送至其中**
4. 為其他來源伺服器新增目的地伺服器和對應，然後選取 **[下一步]** 。
5. 在 [**調整傳輸設定**] 頁面上，指定是否要遷移來源伺服器上的本機使用者和群組，然後選取 **[下一步]** 。 這可讓您在目的地伺服器上重新建立任何本機使用者和群組，如此一來，就不會遺失設定為本機使用者和群組的檔案或共用許可權。 以下是遷移本機使用者和群組時的選項：

    - 預設會選取 **[重新命名具有相同名稱的帳戶**]，並將來源伺服器上的所有本機使用者和群組遷移。 如果它在來源和目的地上找到具有相同名稱的本機使用者或群組，則會在目的地重新命名，除非它們是內建的（例如，系統管理員使用者和 Administrators 群組）。 如果您的來源或目的地伺服器是網域控制站，請勿使用此設定。
    - **重複使用相同名稱的帳戶**對應來源與目的地上的使用者和群組。 如果您的來源或目的地伺服器是網域控制站，請勿使用此設定。
    - [**不要轉移使用者和群組**] 會略過遷移本機使用者和群組，當您的來源或目的地是網域控制站，或植入 DFS 複寫的資料（DFS 複寫不支援本機群組和使用者）時，這是必要的。

   > [!NOTE]
   > 已在目的地停用遷移的使用者帳戶，並指派一個127字元的密碼，這兩者都是複雜和隨機的，因此您必須啟用它們，並在完成繼續使用時指派新密碼。 這可協助確保來源上任何忘記密碼和弱式密碼的舊帳戶不會繼續成為目的地的安全性問題。 您可能也會想要查看[本機系統管理員密碼解決方案（LAPS）](https://www.microsoft.com/download/details.aspx?id=46899) ，作為管理本機系統管理員密碼的一種方式。

6. 選取 [**驗證**]，然後選取 **[下一步]** 。
7. 選取 [**開始傳輸**] 以開始傳送資料。<br>第一次傳送時，我們會將目的地中的任何現有檔案移至備份檔案夾。 在後續的傳輸中，我們預設會重新整理目的地，而不會先進行備份。 <br>此外，儲存體遷移服務的智慧足以處理重迭的共用，我們不會在相同的作業中複製兩次相同的資料夾。
8. 在傳送完成之後，請查看目的地伺服器，確定所有專案都已正確傳輸。 只有當您想要下載任何未傳輸之檔案的記錄檔時，才選取 [**錯誤記錄**檔]。

   > [!NOTE]
   > 如果您想要保留傳輸的審核記錄，或打算在作業中執行多個轉移，請按一下 [**傳送記錄**] 或 [其他記錄儲存選項] 以儲存 CSV 複本。 每次後續的傳輸都會覆寫上一次執行的資料庫資訊。 

此時，您有三個選項：

- **移至下一個步驟**，移至，讓目的地伺服器採用來源伺服器的身分識別。
- **請考慮遷移完成，** 而不接管來源伺服器的身分識別。
- **再次傳輸**，只複製自從上次傳輸後已更新的檔案。

如果您的目標是要將檔案與 Azure 同步，您可以在傳輸檔案之後，或在移至目的地伺服器之後，使用 Azure 檔案同步來設定目的地伺服器（請參閱[規劃 Azure 檔案同步部署](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)）。

## <a name="step-3-cut-over-to-the-new-servers"></a>步驟3：切換到新的伺服器

在此步驟中，您會從來源伺服器切換到目的地伺服器，將 IP 位址和電腦名稱稱移至目的地伺服器。 完成此步驟之後，應用程式和使用者會透過您所遷移之伺服器的名稱和位址，存取新的伺服器。

1. 如果您離開了遷移作業，請在 Windows 系統管理中心移至**伺服器管理員** > **儲存體遷移服務**，然後選取您要完成的作業。
2. 在 [**切換到新的伺服器** > **輸入認證**] 頁面上，選取 **[下一步]** 以使用您先前輸入的認證。

   如果您的目的地是叢集檔案伺服器，您可能需要提供具有許可權的認證，以從網域中移除叢集，然後以新名稱重新加入該叢集。

3. 在 [**設定**切換] 頁面上，指定目的地上的哪一個網路介面卡應該從來源上的每個介面卡接管設定。 這會在進行轉換時，將 IP 位址從來源移至目的地，為來源伺服器提供新的 DHCP 或靜態 IP 位址。 您可以選擇略過所有網路遷移或特定介面。 
4. 指定在轉換後要用於來源伺服器的 IP 位址，將其位址移至目的地。 您可以使用 DHCP 或靜態位址。 如果使用靜態位址，新的子網必須與舊的子網相同，否則轉換將會失敗。
    ![螢幕擷取畫面，其中顯示來源伺服器及其 IP 位址和電腦名稱稱，以及在轉換後將會取代的內容](media/migrate/cutover.png) [**圖 4]：來源伺服器及其網路設定將如何移到目的地**
5. 指定在目的地伺服器接管其名稱之後，如何重新命名來源伺服器。 您可以使用隨機產生的名稱，或輸入一個。 然後選取 **[下一步]** 。
6. 在 [調整切換**設定**] 頁面上選取 **[下一步]** 。
7. 在 [**驗證來源和目的地裝置**] 頁面上選取 [**驗證**]，然後選取 **[下一步]** 。
8. 當您準備好要執行轉換時，請選取 [**開始**切換]。 <br>使用者和應用程式可能會在位址和名稱移動時遇到中斷，而且伺服器會重新開機數次，但不會受到遷移的影響。 轉換所需的時間長短取決於伺服器重新開機的速度，以及 Active Directory 和 DNS 複寫時間。

## <a name="see-also"></a>請參閱

- [儲存體遷移服務總覽](overview.md)
- [儲存體遷移服務常見問題（FAQ）](faq.md)
- [規劃 Azure 檔案同步部署](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)
