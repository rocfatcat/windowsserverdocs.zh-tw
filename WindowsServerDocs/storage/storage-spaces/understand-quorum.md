---
title: 了解叢集和集區仲裁
description: 瞭解叢集和集區仲裁，並提供複雜的特定範例。
ms.author: adagashe
manager: eldenc
ms.topic: article
author: adagashe
ms.date: 01/18/2019
ms.localizationpriority: medium
ms.openlocfilehash: ffd1afdc76ddefbf53ff8f78d15666f343654022
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/07/2020
ms.locfileid: "87970135"
---
# <a name="understanding-cluster-and-pool-quorum"></a>了解叢集和集區仲裁

>適用於：Windows Server 2019、Windows Server 2016

[Windows Server 容錯移轉](../../failover-clustering/failover-clustering-overview.md)叢集為工作負載提供高可用性。 如果裝載資源的節點已啟動，則會將這些資源視為高可用性;不過，叢集通常需要一半以上的節點才能執行，也就是所謂的*仲裁*。

仲裁的設計目的是要防止在網路中有分割區，而且節點的子集無法彼此通訊時，可能會發生的*分散大腦*案例。 這可能會導致兩個節點子集嘗試擁有工作負載，並寫入至相同的磁片，而這可能會造成許多問題。 不過，這會防止容錯移轉叢集的仲裁概念，這只會強制其中一個節點群組繼續執行，因此只有其中一個群組會保持連線。

仲裁會決定叢集仍然在上線時可以承受的失敗次數。 仲裁是設計用來處理叢集節點子集間的通訊發生問題時的案例，如此一來，多部伺服器就不會嘗試同時裝載資源群組和寫入相同的磁片。 藉由擁有此仲裁概念，叢集將會強制叢集服務在其中一個節點子集停止，以確保特定資源群組只有一個真正的擁有者。 一旦停止的節點可以再次與主要的節點群組通訊，它們就會自動重新加入叢集並啟動其叢集服務。

在 Windows Server 2019 和 Windows Server 2016 中，有兩個系統元件具有自己的仲裁機制：

- 叢集**仲裁**：這會在叢集層級運作 (也就是您可能會失去節點，並讓叢集保持) 
- **集區仲裁**：這會在啟用儲存空間直接存取時，在集區層級上運作 (亦即，您可能會遺失節點和磁片磁碟機，並讓集區保持) 。 存放集區設計成用於叢集和非叢集的案例，這就是為什麼它們有不同的仲裁機制。

## <a name="cluster-quorum-overview"></a>叢集仲裁總覽

下表提供每個案例的叢集仲裁結果總覽：

| 伺服器節點 | 可能存在一個伺服器節點失敗 | 可以存留一個伺服器節點失敗，然後另一個 | 可以存留兩個同時伺服器節點失敗 |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | 50/50                               | 否                                                | 否                                                 |
| 2個以上的見證  | 是                                 | 否                                                | 否                                                 |
| 3            | 是                                 | 50/50                                             | 否                                                 |
| 3 + 見證  | 是                                 | 是                                               | 否                                                 |
| 4            | 是                                 | 是                                               | 50/50                                              |
| 4 + 見證  | 是                                 | 是                                               | 是                                                |
| 5和更新版本  | 是                                 | 是                                               | 是                                                |

### <a name="cluster-quorum-recommendations"></a>叢集仲裁建議

- 如果您有兩個節點，則**需要**見證。
- 如果您有三個或四個節點，則**強烈建議使用**見證。
- 如果您可以存取網際網路，請使用**[雲端見證](../../failover-clustering/deploy-cloud-witness.md)**
- 如果您在具有其他電腦和檔案共用的 IT 環境中，請使用檔案共用見證

## <a name="how-cluster-quorum-works"></a>叢集仲裁的運作方式

當節點失敗時，或某個節點子集失去與另一個子集的聯繫時，存活的節點必須確認它們構成了*大部分*的叢集，以維持在線上。 如果他們無法驗證，則會離線。

但是，只有當叢集中的節點總數是奇數 (例如，五個節點叢集中的三個節點) 時，*多數*的概念才會完全正常運作。 那麼，如果叢集的節點數目是偶數， (說，有四個節點叢集) ？

有兩種方式可讓叢集將*投票總數*設為奇數：

1. 首先，它可以藉由新增包含額外投票的*見證*來*啟動*一個。 這需要使用者設定。
2.    或者，它可以透過*將一個假面具*節點的投票 (清空，視需要自動執行) 。

當存活的節點成功驗證它們是*多數*時，*多數*的定義就會更新為只在 survivors 中。 這可讓叢集失去一個節點，然後再遺失另一個節點，依此類推。 在連續失敗之後，調整的*總投票數*概念稱為***動態仲裁***。

### <a name="dynamic-witness"></a>動態見證

動態見證會切換見證的投票，確保*投票總數*是奇數。 如果有奇數的投票數，見證就不會有投票。 如果投票數為偶數，則見證會有投票。 動態見證會大幅降低叢集因見證失敗而中斷的風險。 叢集會根據叢集中可用的投票節點數目，決定是否要使用見證投票。

動態仲裁會以下面所述的方式與動態見證搭配運作。

### <a name="dynamic-quorum-behavior"></a>動態仲裁行為

- 如果您有**偶數**的節點，而且沒有見證，一個節點就會將*其投票量歸零*。 例如，四個節點中只有三個會得到投票，因此*投票總數*為三個，而兩 survivors 的投票則視為多數。
- 如果您有**奇數**的節點數目，而且沒有見證，*它們全都會得到投票*。
- 如果您有**偶數**的節點加上見證，*見證會投票*，因此總計為奇數。
- 如果您有**奇數**的節點數目加上見證，*見證就不會投票*。

動態仲裁可讓您以動態方式指派投票給節點，以避免失去大部分的投票，並允許叢集以一個節點執行， (稱為「上一步」) 。 讓我們以四個節點的叢集做為範例。 假設仲裁需要3個投票。

在此情況下，如果您遺失兩個節點，叢集就會關閉。

![顯示四個叢集節點的圖表，每個節點都會取得投票](media/understand-quorum/dynamic-quorum-base.png)

不過，動態仲裁會防止這種情況發生。 仲裁所需的*總投票數*現在取決於可用的節點數目。 因此，使用動態仲裁時，即使您遺失三個節點，叢集仍會保持運作。

![此圖顯示四個叢集節點，其中節點一次失敗，以及每個失敗後所需的投票數調整。](media/understand-quorum/dynamic-quorum-step-through.png)

上述案例適用于未啟用儲存空間直接存取的一般叢集。 不過，啟用儲存空間直接存取時，叢集只能支援兩個節點失敗。 這在[集區仲裁一節](#pool-quorum-overview)中有更詳細的說明。

### <a name="examples"></a>範例

#### <a name="two-nodes-without-a-witness"></a>兩個沒有見證的節點。
一個節點的投票已歸零，因此*大部分*的投票都是由總共1個**投票**所決定。 如果非投票節點意外關閉，生存者就會有1/1 和叢集不受。 如果投票節點意外關閉，則生存者會有0/1，而叢集也會關閉。 如果投票節點正常關閉，則投票會轉移至另一個節點，而叢集不受。 ***這就是設定見證非常重要的原因。***

![有兩個沒有見證的節點時，所述的仲裁](media/understand-quorum/2-node-no-witness.png)

- 可能會在一部伺服器故障後存活： **50% 的機會**。
- 可能會在一部伺服器故障後仍然**存在**，另一種是：否。
- 一次可能會存活兩個伺服器失敗：**否**。

#### <a name="two-nodes-with-a-witness"></a>具有見證的兩個節點。
這兩個節點都會投票，再加上見證投票，因此*多數*是由總共**3 個投票**所決定。 如果其中一個節點停止運作，則生存者會有2/3 和叢集不受。

![在有兩個具有見證之節點的情況下，所說明的仲裁](media/understand-quorum/2-node-witness.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然**存在**，另一種是：否。
- 一次可能會存活兩個伺服器失敗：**否**。

#### <a name="three-nodes-without-a-witness"></a>沒有見證的三個節點。
所有節點都會投票，因此*多數*是由總共**3 個投票**所決定。 如果任何節點停止運作，survivors 會是2/3 和叢集不受。 叢集會變成兩個沒有見證的節點–此時，您是在案例1中。

![在沒有見證的情況下，有三個節點的情況下會說明仲裁](media/understand-quorum/3-node-no-witness.png)

- 可以存留一部伺服器失敗：**是**。
- 可以存留一次伺服器失敗，另一種是： **50% 的機會**。
- 一次可能會存活兩個伺服器失敗：**否**。

#### <a name="three-nodes-with-a-witness"></a>具有見證的三個節點。
所有節點都會投票，因此見證不會一開始投票。 *多數*是由總共**3 個投票**所決定。 在一次失敗之後，叢集會有兩個具有見證的節點，也就是案例2。 因此，現在這兩個節點和見證都會投票。

![具有三個具有見證之節點的案例中所述的仲裁](media/understand-quorum/3-node-witness.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然存在，另一個則**是：是**。
- 一次可能會存活兩個伺服器失敗：**否**。

#### <a name="four-nodes-without-a-witness"></a>四個不含見證的節點
一個節點的投票已歸零，所以*多數*的判斷是總共**3 個投票**。 在一次失敗之後，叢集會變成三個節點，而您在案例3中。

![具有四個不含見證之節點的案例中所述的仲裁](media/understand-quorum/4-node-no-witness.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然存在，另一個則**是：是**。
- 一次可以存在兩個伺服器失敗： **50% 的機率**。

#### <a name="four-nodes-with-a-witness"></a>具有見證的四個節點。
所有節點都會投票和見證投票，因此*多數*是由總共**5 個投票**所決定。 一次失敗之後，您就會在案例4中。 在兩次同時失敗之後，您會跳到案例2。

![具有四個具有見證之節點的案例中所述的仲裁](media/understand-quorum/4-node-witness.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然存在，另一個則**是：是**。
- 一次可能會出現兩個伺服器失敗：**是**。

#### <a name="five-nodes-and-beyond"></a>五個節點和超過個。
所有節點都會投票，或只投票一次，不論是否將總計變成奇數。 儲存空間直接存取不能同時處理兩個以上的節點，所以此時不需要見證或有用處。

![在有五個節點和更遠的情況下說明的仲裁](media/understand-quorum/5-nodes.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然存在，另一個則**是：是**。
- 一次可能會出現兩個伺服器失敗：**是**。

既然我們已瞭解仲裁的運作方式，讓我們來看看仲裁的類型見證。

### <a name="quorum-witness-types"></a>仲裁見證類型

容錯移轉叢集支援三種類型的仲裁見證：

- **[雲端見證](../../failover-clustering/deploy-cloud-witness.md)**-叢集的所有節點都可存取 Azure 中的 Blob 儲存體。 它會在見證記錄檔中維護叢集資訊，但不會儲存叢集資料庫的複本。
- 檔案**共用見證**–在執行 Windows server 的檔案伺服器上設定的 SMB 檔案共用。 它會在見證記錄檔中維護叢集資訊，但不會儲存叢集資料庫的複本。
- **磁片見證**-叢集可用儲存群組中的小型叢集磁片。 此磁片具有高可用性，而且可以在節點之間進行容錯移轉。 它包含叢集資料庫的複本。  ***儲存空間直接存取不支援磁片見證***。

## <a name="pool-quorum-overview"></a>集區仲裁總覽

我們剛剛討論過叢集仲裁，它會在叢集層級運作。 現在，讓我們深入瞭解集區仲裁，它會在集區層級上運作 (也就是您可能會遺失節點和磁片磁碟機，並讓集區保持) 。 存放集區設計成用於叢集和非叢集的案例，這就是為什麼它們有不同的仲裁機制。

下表提供每個案例的集區仲裁結果總覽：

| 伺服器節點 | 可能存在一個伺服器節點失敗 | 可以存留一個伺服器節點失敗，然後另一個 | 可以存留兩個同時伺服器節點失敗 |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | 否                                  | 否                                                | 否                                                 |
| 2個以上的見證  | 是                                 | 否                                                | 否                                                 |
| 3            | 是                                 | 否                                                | 否                                                 |
| 3 + 見證  | 是                                 | 否                                                | 否                                                 |
| 4            | 是                                 | 否                                                | 否                                                 |
| 4 + 見證  | 是                                 | 是                                               | 是                                                |
| 5和更新版本  | 是                                 | 是                                               | 是                                                |

## <a name="how-pool-quorum-works"></a>集區仲裁的運作方式

當磁片磁碟機失敗，或某個磁片磁碟機子集失去與另一個子集的聯繫時，存活的磁片磁碟機必須確認它們構成了*大部分*的集區，以維持在線上。 如果他們無法驗證，則會離線。 集區是根據其是否有足夠的磁片來仲裁 (50% + 1) 而離線或保持上線狀態的實體。 集區資源擁有者 (主動叢集節點) 可以是 + 1。

但是集區仲裁的運作方式不同于叢集仲裁，方法如下：

- 集區會在叢集中使用一個節點做為見證，使其成為一個做為「集區資源擁有者」 (此節點不存在一半的磁片磁碟機) 
- 集區沒有動態仲裁
- 集區不會執行自己的移除投票的版本

### <a name="examples"></a>範例

#### <a name="four-nodes-with-a-symmetrical-layout"></a>具有對稱版面配置的四個節點。
每個16個磁片磁碟機都有一個投票，而節點二也有一個投票 (，因為它是集區資源擁有者) 。 *多數*是由總共**16 個投票**所決定。 如果節點為三和四，則存活的子集會有8個磁片磁碟機和集區資源擁有者，也就是9/16 投票。 因此，集區不受。

![集區仲裁1](media/understand-quorum/pool-1.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然存在，另一個則**是：是**。
- 一次可能會出現兩個伺服器失敗：**是**。

#### <a name="four-nodes-with-a-symmetrical-layout-and-drive-failure"></a>具有對稱配置和磁片磁碟機失敗的四個節點。
每個16個磁片磁碟機都有一個投票，而節點2也有一個投票 (，因為它是集區資源擁有者) 。 *多數*是由總共**16 個投票**所決定。 第一，磁片磁碟機7會停機。 如果節點為三和四，則存活的子集會有7個磁片磁碟機和集區資源擁有者，也就是8/16 投票。 因此，集區不會有多數和下降。

![集區仲裁2](media/understand-quorum/pool-2.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一部伺服器故障後仍然**存在**，另一種是：否。
- 一次可能會存活兩個伺服器失敗：**否**。

#### <a name="four-nodes-with-a-non-symmetrical-layout"></a>具有非對稱配置的四個節點。
24個磁片磁碟機中的每個都有一個投票，而節點二也有一個投票 (，因為它是集區資源擁有者) 。 *多數*是由總共**24 項投票**所決定。 如果節點為三和四，則存活的子集會有8個磁片磁碟機和集區資源擁有者，也就是9/24 投票。 因此，集區不會有多數和下降。

![集區仲裁3](media/understand-quorum/pool-3.png)

- 可以存留一部伺服器失敗：**是**。
- 可能會在一次伺服器失敗後仍然存在，另一個： * * 相依于 * * 如果兩個節點都已關閉，但仍可存留所有其他案例，則 (無法繼續。
- 一次可能會中斷兩個伺服器失敗： * * 相依于 * * 如果兩個節點三和四個都已關閉，但仍可存留所有其他案例，則 (無法繼續。

### <a name="pool-quorum-recommendations"></a>集區仲裁建議

- 確定叢集中的每個節點都是對稱 (每個節點都有相同數目的磁片磁碟機) 
- 啟用三向鏡像或雙重同位，讓您可以容忍節點失敗並讓虛擬磁片上線。 如需詳細資訊，請參閱我們的[大量指南頁面](plan-volumes.md)。
- 如果有兩個以上的節點已關閉，或有兩個節點和另一個節點上的磁片已關閉，則磁片區可能無法存取其資料的全部三個複本，因此會離線且無法使用。 建議您快速將伺服器帶回或更換磁片，以確保磁片區中所有資料的最大復原能力。

## <a name="more-information"></a>更多資訊

- [設定和管理仲裁](../../failover-clustering/manage-cluster-quorum.md)
- [部署雲端見證](../../failover-clustering/deploy-cloud-witness.md)
