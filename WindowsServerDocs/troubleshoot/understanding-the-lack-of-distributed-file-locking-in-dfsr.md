---
title: 瞭解（缺乏） DFSR 中的分散式檔案鎖定
description: 本文討論 Windows 中沒有多主機分散式檔案鎖定機制，特別是在 DFSR 複寫的資料夾內。
ms.prod: windows-server
ms.technology: server-general
ms.date: 06/10/2020
author: Deland-Han
ms.author: delhan
ms.openlocfilehash: 739bcd1127877d4c9b1339b64270262d9d48634f
ms.sourcegitcommit: fa9a8badf4eb366aeeca7d2905e2cad711ee8dae
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/11/2020
ms.locfileid: "84714972"
---
# <a name="understanding-the-lack-of-distributed-file-locking-in-dfsr"></a>瞭解（缺乏） DFSR 中的分散式檔案鎖定

本文討論 Windows 中沒有多主機分散式檔案鎖定機制，特別是在 DFSR 複寫的資料夾內。
  
## <a name="some-background"></a>部分背景

  - 分散式檔案鎖定–這指的是在多部電腦上擁有多個檔案複本，而當一個檔案開啟以供寫入時，所有其他複本都會被鎖定。 這會防止多個使用者同時在多部伺服器上修改檔案。
  - 分散式檔案系統複寫– [DFSR](/previous-versions/windows/desktop/dfsr/distributed-file-system-replication--dfsr-)會在以狀態為基礎的多宿主設計中運作。 在以狀態為基礎的複寫中，多宿主系統中的每個伺服器都會在其到達時套用其複本的更新，而不需要交換記錄檔（它會改為使用版本向量來維護「最新」資訊）。 在初始同步處理之後，任何一部伺服器都不會有任何授權，因此它在各種網路拓撲中都是高度可用且非常有彈性。
  - 伺服器訊息區- [SMB](/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688)是 Windows 中用來透過網路存取檔案的常見通訊協定。 簡單來說，它是一種用戶端伺服器通訊協定，它會使用重新導向器，讓遠端檔案系統看起來像是本機檔案系統。 它並非專屬於 Windows，而且很常見–知名的非 Microsoft 範例是 Samba，可讓 Linux、Mac 和其他作業系統作為 SMB 用戶端/伺服器，並參與 Windows 網路。

  
很重要的是，請務必清楚略圖您複寫資料環境中的 DFSR 和 SMB 存留處。 SMB 可讓使用者存取其檔案，而不會察覺到 DFSR。 同樣地，DFSR （使用 RPC 通訊協定）會讓伺服器之間的檔案保持同步，而且不會察覺到 SMB。 請勿混淆這篇文章和[機會鎖定](/windows/win32/fileio/opportunistic-locks)中所定義的分散式鎖定。  
  
下面就是 Brits 所說的東西。  
  
由於使用者可以修改多部伺服器上的資料，而且因為每一部 Windows 伺服器只知道本身的檔案鎖定，*而且*因為[DFSR 並不知道其他伺服器上的鎖定](/previous-versions/windows/it-pro/windows-server-2003/cc773238(v=ws.10))，所以使用者可能會覆寫彼此的變更。 DFSR 使用「最後寫入者為准」衝突演算法，因此有人必須遺失，而要儲存最後一個的人可以保留其變更。 遺失檔案複本會 chucked 到*ConflictAndDeleted*資料夾中。  
  
現在，這種方式*遠低於*大家認為的常見情況。 一般來說，在本機環境中會修改真正的共用檔案;在分公司或同一個隔資料列中。 它們通常是由相同小組的人員負責處理，因此人們通常會知道修改資料的同事。 而且，由於它們通常位於相同的網站中，因此在共用檔上工作的所有使用者都將使用相同的伺服器。 Windows SMB 在此處理這種情況。 當使用者已鎖定檔案進行修改，而他的同事嘗試編輯該檔案時，另一個使用者將會收到類似下列的錯誤：  
  
![使用中的檔案](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/1.jpg)
  
如果開啟檔案的應用程式真的很聰明（例如 Word 2007），它可能會提供您：  
  
![使用中的檔案](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/2.jpg) 
  
DFSR 確實具有鎖定檔案的機制，但它只在伺服器本身的內容中。 如果檔案的本機複本具有獨佔鎖定，DFSR 就不會將檔案複寫入或寫出。 但這並不會防止其他伺服器上的任何人修改檔案。  
  
回到主題，*在地理位置*修改共用資料的問題存在，對某些人來說，這是相當 gnarly 的。 我們偶爾會問到，DFSR 不會處理這項鎖定，而是一波神奇的東西。 事實上，這是一個有趣且難以解決的多宿主複寫系統案例。 讓我們開始探索吧。  
  
## <a name="third-party-solutions"></a>協力廠商解決方案
  
有一些廠商解決方案會遇到此問題，它們通常會透過下列一或多個方法來解決 \* ：  

  - 使用 broker 機制

> 擁有中央的「流量 cop」可讓一部伺服器感知所有其他伺服器，以及使用者已鎖定的檔案。 不幸的是，這也表示分散式鎖定系統中通常會發生單一失敗點。

![拓撲](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/3.png) 

  - 完全路由網路的需求

> 由於中央訊息代理程式必須能夠與參與檔案複寫的所有伺服器交談，因此這會移除處理複雜網路拓撲的能力。 信號拓撲和多個中樞和輪輻拓撲通常不可行。 在非完全路由的網路中，有些伺服器可能無法直接與彼此聯繫或代理人，而且只能與他可以與另一部伺服器交談的合作夥伴溝通，依此類推。 這在多主控環境中是正常的，但不是使用仲介機制。

![拓撲](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/4.png)

  - 僅限於一對伺服器

> 某些解決方案會將拓撲限制為一對伺服器，以簡化其分散式鎖定機制。 對於較大的環境，這可能不可行。

  - 利用用戶端和伺服器上的代理程式
  - 不要使用多宿主複寫
  - 不要利用 MS 叢集
  - 利用專業設備

  
***\*** 請注意，我通常 \! 不會提出死亡威脅，因為您的解決方案會執行/不會執行一或多個方法。\!*  
  
## <a name="deeper-thoughts"></a>更深入的想法  
  
當您進一步考慮這個問題時，某些基本的問題就會開始裁剪。 例如，如果有四部伺服器的資料可由四個網站中的使用者修改，而其中之一的 WAN 連線離線，我們該怎麼做？ 使用者仍然可以存取其個別的伺服器，但我們應該讓他們進行此作業嗎？ 我們不想要讓它們進行衝突的變更，但我們也希望他們能夠持續運作並使公司成本變得更好。 如果在該時間點隨意封鎖變更，即使沒有發生任何衝突，使用者也不能運作\! 沒有辦法告訴其他伺服器該檔案正在使用中，而您又回到第一部。  
  
![拓撲](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/5.png)
  
然後會有 SMB 本身和報告鎖定的錯誤處理。 我們無法真正改變 SMB 報告共用違規的方式，因為我們會中斷許多應用程式，而用戶端仍然不會瞭解新的擴充錯誤訊息。 Word 2007 這類應用程式會執行一些 undercover 的 trickery，以找出鎖定檔案的物件，但大部分的應用程式都不知道誰有使用中的檔案（或甚至是 SMB 存在）。 真的。）。 因此當使用者收到「此檔案正在使用中」訊息時，它並不特別可行–他們是否應該呼叫技術支援中心？ 技術支援人員是否能夠存取所有的檔案伺服器，以查看哪些使用者正在存取檔案？ 雜亂.  
  
因為我們想要高可用性的多宿主，所以不需要有 broker 系統;我們可能需要在所有伺服器上執行某些專案，讓它們全都可以透過非完全路由的網路進行通訊。 這需要非常複雜的同步處理技術。 它會在網路上增加一些額外負荷（雖然可能並不多），而且必須迅速快速，以確保我們不會讓使用者繼續工作。它需要 outrun 檔案複寫本身-事實上，它可能必須以某種方式實際系結到複寫。 它也必須考慮與網路相關的伺服器中斷，而不是伺服器損毀。  

![拓撲](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/6.png)
  
然後我們回到此案例的特殊用戶端軟體，它會進一步瞭解鎖定，並且可以提供使用者一些實用的資訊（「在會計中進行呼叫 Susie，並告訴她發行該檔」，抱歉，檔案鎖定拓撲已中斷，而您的系統管理員會阻止您開啟此檔案，直到其修正為止」等等）。 在 Windows 中執行的數百萬個應用程式非常有趣，讓這項功能能夠完美地播放。 有許多作業系統不受支援或無法取得軟體– Windows 2000 已超出主流支援，而 XP 很快就會推出。 Linux 和 Mac 用戶端不會有此軟體，除非他們認為這是重要的，因此客戶必須希望其廠商做出類似的動作。  
  
## <a name="more-inforamtion"></a>其他資訊
  
現在，在 DFSR 中控制這種情況的最簡單方式是使用 DFS 命名空間，以一致的命名空間引導使用者到可預測的位置。 藉由正確設定您的 DFSN 網站拓撲和伺服器連結，您可以強制使用者全部共用相同的本機伺服器，而且只允許他們在其「主要」伺服器關閉時存取遠端電腦。 在大部分的環境中，這種方式相當良好。 對 DFSR 而言，SharePoint 是一個選項，因為它的簽出/簽入系統是一種選擇。 BranchCache （即將在 Windows Server 2008 R2 和 Windows 7 中推出）可能是您的選擇，因為它是為了簡化分支案例中檔案的讀取而設計，但在最後，授權資料仍會存留在一部伺服器上-在[這裡](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj127252(v=ws.11))有更多相關資訊。 同樣地，這些廠商也有其解決方案。

