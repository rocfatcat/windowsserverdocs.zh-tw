---
title: Server Performance Advisor 使用者指南
description: Server Performance Advisor 使用者指南
ms.assetid: be99a5a9-b9c0-436b-912c-e5c5839a533d
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/16/2017
ms.topic: article
ms.prod: windows-server
ms.technology: manage
ms.openlocfilehash: 6a6ccedeeb007b9d3ab32c308fae991deb526442
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/27/2019
ms.locfileid: "71383086"
---
# <a name="server-performance-advisor-users-guide"></a>Server Performance Advisor 使用者指南

>適用于： Windows Server （半年通道）、Windows Server 2016、Windows Server 2012 R2、Windows Server 2012、Windows 10、Windows 8

本 Microsoft Server Performance Advisor （SPA）使用者指南提供如何使用 SPA 來識別部署于各種伺服器角色之系統效能瓶頸的指導方針。

SPA 可協助您進行下列動作：

* 管理您的伺服器效能，並針對伺服器效能問題進行疑難排解。

* 提供有關常見設定和效能問題的資料包表和建議。

* 根據所收集的資料，提供最佳的 pratice 建議。

> [!NOTE]
> SPA 主控台不會對伺服器進行任何變更。

如需開發 SPA Advisor 套件的詳細資訊，請參閱[Server Performance Advisor 套件開發指南](server-performance-advisor-pack-development-guide.md)。

## <a name="server-performance-advisor-overview"></a>伺服器效能審查程式總覽


本節說明 SPA 的歷程記錄、描述其目標物件和案例，並提供工具的架構總覽。

### <a name="history-of-spa"></a>SPA 的歷程記錄

原始版本的 Microsoft Server Performance Advisor （SPA）已于2005-2006 發行。 它主要是以 Windows Server 2003 為目標，包括核心作業系統和伺服器角色，例如 Internet Information Services （IIS）和 active directory。 此工具的目標是協助您評估伺服器效能，並針對伺服器效能問題進行疑難排解。

SPA 會為系統管理員提供有關常見設定和效能問題的資料包表和建議。 SPA 會從伺服器上的各種來源收集效能相關資料，例如效能計數器、登錄機碼、WMI 查詢、設定檔，以及 Windows 事件追蹤（ETW）。 根據其所收集的伺服器效能資料，SPA 可以深入瞭解目前的伺服器效能狀況，以及有關可改進之事項的問題建議。

原始 SPA 工具已有超過1000000的下載，並協助許多系統管理員管理其伺服器的效能。 這是非常成功的效能疑難排解工具。

從原始 SPA 的版本開始，伺服器效能世界中有幾項重大變更。 最值得注意的是，Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2 和 Windows Server 2008 的發行，其中包含新版本的對應伺服器角色，例如 Internet Information Services （IIS）8.5。 較新版本的 Server Performance Advisor 會將原始 SPA 的功能延伸到最近的伺服器作業系統和伺服器角色。

雖然 SPA 3.1 與原始工具共用相同的設計目標和效能分析架構，但它已經以最新的技術改寫。 它也有下列重要的改良功能：

* 可以針對執行 Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2 和 Windows Server 2008 的伺服器進行分析。

* 支援遠端分析功能，可讓 SPA 3.1 從中央主控台收集和分析資料，而不需要在要分析的伺服器上安裝程式碼。

* 會使用 Microsoft SQL Server 來進行資料分析和儲存，以啟用處理和儲存大量資料。

* 將此工具與 Advisor 套件隔開。 每個伺服器角色的效能分析邏輯都會以 advisor 套件的形式發行，而此封裝可以與工具分開發行或更新。

* 提供使用開放式架構在 SQL 腳本中開發的 Advisor 套件。 非 Microsoft 的合作物件可以開發 advisor 套件，或從 Microsoft 擴充現有的 advisor 套件，以涵蓋特殊需求。

* 支援像是並存比較報表的新功能，以及可協助您尋找異常狀況的趨勢和歷程記錄圖表。

* 提供如修改、匯入和匯出閾值的功能，可協助您微調報表和通知，並與其他 SPA 使用者共用這些 tunings。

* 支援多個專案，可以用來將目標伺服器分組。

* 提供 SPA 主控台內的週期性資料收集。

* 使用 Microsoft SQL Server （適用于 advanced users）啟用自訂查詢和報告產生。

* 自訂的 Windows PowerShell Cmdlet 可與 SPA 搭配使用

* 從 SPA 3.0 資料庫匯入和查看報表與舊版相容

### <a name="target-audience"></a>目標對象

SPA 工具主要是針對管理不同伺服器角色中少於100部伺服器的系統管理員所設計。 支援工程師也可以使用它來收集效能資料，並針對客戶的效能問題進行疑難排解。

SPA 提供的建議可協助您解決效能問題;不過，它是根據可能不適用於您的特定伺服器環境的假設。 透過 SPA 提供的建議應視為建議。 我們希望 SPA 使用者能夠充分瞭解其系統設定、使用案例，以及系統微調對整體系統行為的影響。 系統管理員應該決定是否應將 SPA 建議套用到其環境。

### <a href="" id="what-s-new-in-spa-3-1-"></a>SPA 3.1 中有什麼新功能？

SPA 3.1 中新增了下列功能和增強功能：

* Active directory Advisor 套件有助於分析伺服器 s active directory 網域服務伺服器角色的一般效能。

* 支援開發人員在 advisor 套件中新增遺失的 ETW 事件通知警示，並在產生報告時顯示警示，並在緩慢或嚴重爭用的磁片上因為高頻率記錄而遺失事件

### <a name="target-scenarios"></a>目標案例

SPA 的目標案例如下：

* **伺服器環境**

    SPA 的設計可輕鬆設定和維護。 它適用于使用1到100伺服器的伺服器環境。 如果您嘗試管理超過100部伺服器的效能，SPA 將無法妥善調整。 針對較大或較複雜的環境，您應該考慮使用 System Center Operations Manager。

* **效能疑難排解**

    您可以使用 SPA 做為效能疑難排解工具。 它提供收集高階效能資料的能力，它會對資料執行完整的 post 處理，讓您更清楚瞭解整體系統行為，並標示任何異常狀況。 當客戶懷疑發生效能問題時，您可以使用 SPA 來收集及分析伺服器的效能資料。

    SPA 會產生您可以查看的報表。 SPA 報告提供一份通知清單，其中會反白顯示潛在的問題，以及包含各種效能索引、設定和伺服器設定的資料區段。 您可以使用這份報告來識別特定的效能問題，並使用建議來尋找問題的解決方案。 報表可以與其他在不同時間或不同伺服器上產生的報表進行比較。 使用這種並存比較，您可以判斷基準一般與異常行為之間的差異。

    **注意**SPA 並非設計為「調試」或「計量」工具。 此外，從伺服器的觀點來看，它可以視為唯讀工具，而且不會修改伺服器設定。

     

* **效能索引監視**

    您可以使用 SPA 來監視伺服器的效能索引。 您可以選擇在伺服器上定期執行 SPA 以收集效能資料，然後執行趨勢圖或歷程記錄圖表來找出異常狀況。 您可以查看特定分析的報表、找出效能問題的詳細資訊，然後使用建議或其他報告資料來解決問題。

### <a name="spa-architecture"></a>SPA 架構

SPA 資料集合邏輯建基於 Windows 中的通訊協定，稱為效能記錄檔及警示（PLA）。 PLA 可讓程式從本機或遠端伺服器收集效能資料，例如效能計數器、WMI 查詢、ETW 追蹤、登錄機碼和設定檔案。 當 SPA 在目標伺服器上執行效能分析時，它會根據您選取的特定 SPA 建議程式套件，建立一組 PLA 資料收集器。 Advisor 套件包含要收集的資料來源，以及要儲存記錄檔的檔案共用。 SPA 資料收集只會儲存單一使用者帳戶;PLA 使用的相同使用者帳戶也會用來寫入記錄。

SPA 會使用 SQL Server 資料庫來儲存從目標伺服器收集的效能記錄。 SPA 會將檔案共用中的所有效能記錄匯入到資料庫，然後使用每個 advisor 套件內的資料分析邏輯來處理資料並產生報告。 Advisor 套件會分析從目標伺服器收集的效能資料，並產生 SPA 報告。 如需建立 advisor 套件的詳細資訊，請參閱[Server Performance Advisor 套件開發指南](server-performance-advisor-pack-development-guide.md)。

SPA 主控台使用者介面和互動會建立為 SPAConsole 的一部分。 您可以使用主控台來建立資料庫、新增或移除 advisor 套件、管理目標伺服器、執行效能分析，以及查看效能報告。

SPA 主控台可以在下列作業系統上執行：

* Windows 8.1

* Windows 8

* Windows 7

* Windows Server 2012 R2

* Windows Server 2012

* Windows Server 2008 R2

* Windows Server 2008

在一般商務應用程式中，有三個層級：展示層、商務邏輯層和儲存層。 SPA 是設計為主控台和資料庫的兩層產品。 主控台會當做包含特定處理常式相關邏輯的展示層，而資料庫會當做儲存層和商業邏輯層。 主控台會捕獲使用者輸入，並控制資料收集、資料處理和產生報告的步驟。 SPA 不依存于 Windows 系統服務。

下圖顯示 SPA 系統的高層級架構。 程式為：

1.  從 SPA 主控台中，您可以在指定的伺服器上執行效能分析。

2.  收集效能資料時，目標伺服器上的 PLA 會將記錄檔寫回資料收集器集合所指定的檔案共用。

3.  在目的電腦上完成資料收集之後，SPA 主控台會將記錄匯入 SQL Server 資料庫。

4.  主控台會叫用特定 advisor 套件的資料處理邏輯。

5.  Advisor 套件會處理資料，並呼叫 SPA Api，將記錄插入至 SPA 架構所定義的系統報表資料表。

6.  您可以使用主控台內的報表檢視器來查看產生的報表。 為了協助您針對效能問題進行疑難排解，SPA 提供三種類型的報告：單一報表、並列報表，以及趨勢或歷程記錄圖表。 如需報表的詳細資訊，請參閱[查看報表](#bkmk-viewingreports)。

![spa 架構](../media/server-performance-advisor/spa-user-manual-architecture.png)

## <a name="getting-started-with-spa"></a>SPA 使用者入門


### <a name="requirements"></a>需求

SPA 主控台可以安裝在 Windows 8.1、Windows 8、Windows 7、Windows Server 2012 R2、Windows Server 2012、Windows Server 2008 R2 和 Windows Server 2008 上。 不支援在舊版 Windows Server 作業系統上執行 SPA。 SPA 會在 x86 或 x64 上執行，但不支援 IA64 或 ARM 架構。

SPA 建基於 Windows Presentation Foundation （WPF）2.0，這是 Microsoft .NET Framework 4 的一部分，因此需要 .NET Framework 4。

您也需要在安裝 SPA 的同一部電腦上安裝 SQL Server 2008 R2 Express。 SQL Server 2008 R2 Express 是由 Microsoft 發行的免費資料庫引擎。 您可以從 Microsoft 下載中心下載 Microsoft SQL Server 2008 R2 Express。 雖然我們建議 SQL Server 2008 R2 Express，但較新版本的 SQL Server 也可能與 SPA 相容。

**注意**SPA 不包含 SQL Server 或 .NET Framework 作為 SPA 安裝套件的一部分。 安裝 Microsoft SQL Server 2008 R2 和 .NET Framework 4.0 之後，建議您先執行 Windows Update，再安裝 SPA。

 

因為使用者可以使用 SPA 來建立和管理資料庫，所以用來執行 SPA 的使用者帳戶應具有與 SQL Server 相同的系統管理員許可權。

### <a href="" id="bkmk-setupspa"></a>設定 SPA

SPA 封裝成 .cab 檔案，其中包含 SPA 架構的所有二進位檔、用於 advanced 案例的 Windows PowerShell Cmdlet，以及下列 advisor 套件：核心 OS、Hyper-v、active directory 和 IIS。 將 .cab 檔案解壓縮至資料夾之後，不需要進行其他安裝。 不過，若要執行 SPA，您必須從目標伺服器啟用資料收集，如下所示：

* 若要執行 PLA 資料收集，您用來執行 SPA 主控台的使用者帳戶必須是目標伺服器上的 Administrators 安全性群組的一部分。 如果目標伺服器和主控台位於相同的網域中，則網域使用者帳戶必須是目標伺服器上 [系統管理員] 安全性群組的一部分。 如果目標伺服器和主控台不在相同的網域中，請在目標伺服器上建立系統管理使用者帳戶，其具有與您用來執行 SPA 主控台的使用者帳戶相同的使用者名稱和密碼。

* 在伺服器上建立結果的共用資料夾。

* 請確定您用來執行 SPA 主控台的使用者帳戶具有共用資料夾的 [讀取] 和 [寫入] 許可權。 PLA 會使用此帳戶將記錄寫入資料夾。
SPA 主控台會使用相同的帳戶來讀取記錄，並將它們匯入至資料庫。

    **注意**ETW 會執行迴圈緩衝區來儲存追蹤，並盡可能將其移到共用資料夾。 如果伺服器忙碌中或寫入作業緩慢，ETW 會在緩衝區已滿時捨棄追蹤。 共用資料夾必須位於具有快速 i/o 存取權的伺服器上。 我們建議每部目標伺服器都有共用資料夾，以將檔案 i/o 緩慢造成的資料遺失降至最低。

     

* 若要讓 PLA 存取目標伺服器，請將 Windows 防火牆設定為允許在目標伺服器上進行遠端效能記錄檔及警示存取。 PLA 使用 TCP 通訊埠139。

* 請確定**效能記錄 & 警示**服務正在執行。

* 如果主控台和目標伺服器位於不同的子網中，您也需要在 [**效能記錄檔及警示**] 頁面上的 [**範圍**設定] 中，設定 [輸入防火牆規則] 中的 [遠端 IP 位址] 欄位，如下所示。

    ![pla 屬性](../media/server-performance-advisor/spa-user-manual-pla-firewall.png)

* 在主控台和每部目標伺服器上開啟網路探索。

* 如果目標伺服器未加入網域，請啟用下列登錄設定： **HKLM\\SOFTWARE\\Microsoft\\Windows\\Currentversion\\的原則\\system\\LocalAccountTokenFilterPolicy**。

**注意**根據預設，SPA 會將診斷記錄寫入至 SpaConsole 所在的資料夾。 如果 SPA 安裝在 Program Files 資料夾底下，只有在以系統管理員身分執行 SpaConsole 時，SPA 才能夠寫入記錄檔。

如果您想要對主控台電腦執行資料分析，則需要以系統管理員身分執行 SPA。 在本機電腦上執行時，PLA 會經歷不同的程式碼路徑，而這需要系統管理員許可權。

如果您想要針對伺服器執行 IIS SPA 建議程式套件，您必須啟用 IIS 伺服器的 WMI 查詢和 ETW 追蹤。 若要這麼做，您可以在 [**健全狀況和診斷**] 角色服務下啟用**追蹤**，以及在 [**網頁伺服器（IIS）** ] 伺服器角色的 [**管理工具**] 底下啟用 [ **IIS 管理腳本及工具**]。

 

### <a name="creating-your-first-project"></a>建立您的第一個專案

完成所有設定之後，您就可以建立第一個 SPA 專案。 如上一節所述，SPA 會將與效能資料分析相關的所有專案儲存在資料庫內。 每個 SPA 專案都會對應到單一資料庫。 **第一次使用時，嚮導**會引導您完成下列步驟。

**建立 SPA 專案**

1.  啟動 SpaConsole。 主控台進入中斷連線模式，其中 SPA 未連接到任何資料庫，而主視窗為空白。

2.  若要建立新的專案，**請按一下 [** 檔案]，然後按一下 [**新增專案**]。 這會在第一次使用 Wizard 時啟動。 第一頁顯示您在使用 wizard 時遵循的步驟：

    * 建立資料庫

    * 布建 advisor 套件

    * 將伺服器新增至目標伺服器清單

3.  按一下 **\[下一步\]** 。 [**建立專案資料庫**] 頁面會要求您提供要在其中建立資料庫之 Microsoft SQL Server 實例的名稱。 例如，如果與主控台位於同一部電腦上，您可以使用**localhost\\&lt;您的 SQL server 名稱&gt;** 。

    **注意**SQL Server 2008 R2 Express 安裝的預設實例名稱是 SQLExpress。 針對安裝在本機電腦上 SQL Server 2008 R2 Express 的實例，資料庫通常會預設為**localhost\\SQLExpress**。 不過，在 SQL Server 安裝期間可能已變更，因此您必須確定使用的是正確的 SQL Server 實例名稱。

     

4.  提供資料庫名稱。 僅允許字母、數位和底線（\_）做為資料庫名稱的有效字元。 SPA 資料庫名稱的合理建議是**spa**。 如果您輸入不正確名稱，則會出現紅色錯誤圖示。 相關聯的工具提示會提供驗證失敗的原因。

    **注意**請務必記住資料庫名稱和伺服器實例名稱，因為這些是您的專案唯一的識別碼。 如果您想要切換到此資料庫，則必須提供此資訊。

     

5.  提供伺服器實例名稱和資料庫名稱之後，第一次使用 Wizard 會產生資料庫檔案的位置。

6.  在 [**建立專案資料庫**] 頁面上，按 **[下一步]** 。 第一次使用時，Wizard 會建立資料庫，並在資料庫中產生所有 SPA 相關的資料庫架構、函數和預存程式。 視硬體和網路速度而定，此步驟可能需要幾秒鐘的時間。

    **注意：** 如果此步驟失敗，則會出現錯誤訊息。 常見的問題包括：主控台無法連接到 SQL Server 實例、建立資料庫的許可權不足，或資料庫名稱已經存在。

     

7.  當上一個步驟成功時，您會看到 [布建**advisor 套件**] 頁面。 它會列出您電腦上所有可用的 advisor 套件。 SPA 會自動掃描 SPA 根目錄下名為「 **ap** 」的資料夾。 它會列出每個 advisor 套件的完整名稱、版本和作者。

    **注意：** 如需如何在 SPA 中使用完整名稱和版本的詳細資訊，請參閱[管理 advisor 套件](#bkmk-manageadvisorpacks)

     

8.  選擇您想要在 project 資料庫中布建的 advisor 套件，然後按 **[下一步]** 。 或者，您也可以按一下 [**跳過**] 移至下一個步驟，而不需要布建任何 advisor 套件。

    **注意**您隨時都可以在使用此工具時布建 advisor 套件。 如需詳細資訊，請參閱[管理 advisor 套件](#bkmk-manageadvisorpacks)。

     

9.  在 [**新增伺服器**] 頁面上，針對要新增至目標伺服器清單的每個伺服器，有兩個必要欄位要填入：**伺服器名稱**和檔案**共用位置**。

    **注意**另外還有一個 [**備註**] 欄位，主要是用來分類或尋找伺服器。 在您有許多伺服器的實例中，您可以匯入逗號分隔值（.csv）檔案，其中包含 [伺服器名稱]、[結果] 資料夾和選擇性的 [備註] 欄位。 [**批註**] 欄位用來描述伺服器，而此詞彙可用來篩選伺服器以進行資料收集。 如果您要透過 .csv 檔案初始化伺服器，檔案內的剖析錯誤不會載入伺服器。

     

10. 若要啟用 PLA 資料收集，必須設定數個設定，如[設定 SPA](#bkmk-setupspa)中所述。 [**新增伺服器**] 頁面提供測試設定功能，可協助您針對設定問題進行疑難排解。 選取與電腦相關聯的核取方塊，然後按一下 [**測試連線能力**]。 SPA 會嘗試在目標伺服器上產生資料收集器集合，而且它會嘗試將結果匯入至資料庫。 如果所有專案都正確，則**狀態**會顯示 [**通過**]。 如果失敗，則會出現工具提示，說明失敗的原因。

11. 每一部伺服器都會自動新增至資料庫，即使它未通過設定測試也一樣。 若要從清單中移除伺服器，請選取伺服器名稱，然後按一下 [**移除**]。

12. 當所有專案都完成時，請按一下 **[完成**] 以關閉第一次使用嚮導。 如果您在完成前第一次使用 Wizard 時關閉，則所有先前的步驟都會保存，而且不會自動回復。 您需要手動進行未來的變更。

## <a name="running-analysis"></a>正在執行分析


設定資料庫之後，您可以在伺服器上執行效能分析。

每當 SPA 主控台啟動時，目前使用者所使用的最後一個專案就會自動開啟。 主視窗包含伺服器清單。 每部伺服器都有四個屬性：伺服器名稱、分析結果、目前狀態和批註。

* **伺服器名稱**伺服器的名稱，這是伺服器的識別碼。 不允許重複的名稱。

* **分析結果**根據預設，它會顯示針對伺服器執行最新效能分析的結果。 如果尚未針對伺服器執行任何效能分析，它就不會顯示任何**報告**。 如果報表產生警告，則會顯示產生最新報告時的**警告**和時間戳記。 如果在伺服器上的最新分析期間找不到任何問題，則會顯示 **[確定]** 和 [時間戳記]。

    **注意：** 如果您最近變更了系統設定，建議您再次執行分析，以評估變更的整體影響，並取得系統狀態的更新報告。 SPA 不會追蹤受測試系統的設定變更。

     

* **目前狀態**顯示目前正在伺服器上執行之效能分析工作的狀態。 您可以按一下 [**取消**] 圖示（由紅色 X 指定）來取消正在執行的工作。

* **批註**描述目前的目標伺服器。 例如，您可以使用伺服器角色（例如 SQL Server）或位置（例如 Kent）來描述您的伺服器。 SPA 會使用**伺服器名稱**和**備註**來協助搜尋及尋找適當的伺服器。 您可以在 [搜尋] 文字方塊中輸入。 如果 [**伺服器名稱**] 或 [**批註**] 資料行包含您在 [搜尋] 方塊中輸入的確切字串，伺服器就會顯示在 [伺服器] 清單中。

主控台也提供下列控制項：

* **重複**一個核取方塊，描述根據時間間隔來定期重複集合的能力。 對於大部分的伺服器安裝，您會想要讓 SPA 集合每小時重複一次，以擁有足夠的歷程記錄來進行分析。 如果您只想要執行一次集合，則不應該選取 [**重複**] 核取方塊。

* **移除週期**此按鈕可讓您取消進行中的重複收集作業。 它會取消重複的集合，但不是目前的集合（如果有的話）正在進行中。 此選項可讓您重設新的重複收集間隔，或手動執行集合。

開始進行效能分析之前，請先選取 [資料收集持續時間]。 雖然收集更多資料有助於提供更精確的伺服器效能狀況影像，但它也會產生大量的記錄檔，而且可能會對伺服器造成更多可能的影響。 根據您的特定需求選擇適當的資料收集持續時間。 每個 advisor 套件都會定義最短的有效持續時間。 您選擇的資料收集持續時間必須超過所選 advisor 套件的最短持續時間。

若要在目標伺服器上執行效能分析，請選取您想要對其執行效能分析的伺服器，然後按一下 [**執行分析**] 對話方塊隨即出現，並要求您選取要在伺服器上執行的 advisor 套件。 選取的 advisor 套件會同時執行。 產生的報告是以相同時間週期內所收集的效能資料為基礎。

**注意：** 如果您選取的伺服器有週期性效能分析正在執行，則 [**移除週期**] 按鈕可讓您取消週期性資料收集。 SPA 不允許同時在同一部電腦上有多個資料收集會話。

 

## <a href="" id="bkmk-viewingreports"></a>查看報表


在 SPA 中，有三種類型的效能分析報表：單一報表、並列報表，以及趨勢和歷程記錄圖表。

執行效能分析之後，會針對目的電腦上執行的每個 advisor 套件產生報告。 從主視窗的 [伺服器] 清單中，您可以展開 [**分析結果**]，查看在特定伺服器上執行的所有 advisor 套件。 您可以按一下報表名稱來查看單一報表。

Advisor 套件名稱旁邊有三個圖示，可顯示伺服器上最新分析執行的狀態：

* **最新**圖示顯示此伺服器上的最新效能分析針對 advisor 套件所產生的報表。

* [**尋找**] 圖示會顯示效能分析報表的清單，可讓您挑選正確的報表。 [ **Advisor 套件**] 和 [**目標伺服器**] 欄位會預先填入目前的 advisor 套件和目標伺服器資訊。 預設時間範圍設為一周，而結束日期設定為今天。 如果您按一下右上角的 [**搜尋**] 按鈕，就可以在時間範圍內取得所選伺服器和 advisor 套件的所有效能分析報告清單。

* [**視圖圖表**] 圖示會開啟 [趨勢] 和 [歷史圖表] 視圖。

下圖顯示每個 advisor 套件之後的**最新**、**尋找**和**觀看圖表**圖示：

![報表圖示](../media/server-performance-advisor/spa-user-manual-report-icons.png)

### <a name="searching-for-and-within-reports"></a>在報表中搜尋和

您可以使用**報表瀏覽器**來搜尋報表。 這可讓您依日期範圍、伺服器名稱和 advisor 套件來搜尋報表。 這是尋找上一次執行報表以外的相關報告的建議方式。 您可以透過該伺服器的**View report**取得最後一次執行報表。

當您查看特定的報表時，您可以輕鬆地依時間流覽至下一個和上一個報表，或查看相關的報表，例如同時執行的另一個 AP。 這些選項會在 [**動作**] 底下提供。

也可以在報表內進行搜尋。 有一些報表具有 [**尋找**字串] 搜尋方塊，可用於報表內的快速文字字串搜尋。 若要移除文字方塊，您可以將它關閉。 若要啟動搜尋方塊（在具有文字搜尋的 windows 中），您可以使用 Control + F 快捷方式。 [**尋找**] 方塊可讓使用者指定區分大小寫的搜尋，適當地配合 [**符合案例**] 選項。

下圖顯示 [**報表**] 索引標籤上具有字串**功能**的 [**尋找**] 搜尋方塊。

![[尋找搜尋] 方塊](../media/server-performance-advisor/spa-user-manual-find-search-box.png)

### <a name="single-report"></a>單一報表

單一報表會顯示單一電腦上一次執行 advisor 套件的效能分析結果。 此報表會顯示 advisor 套件的名稱、目標伺服器的名稱、產生報告的時間，以及資料收集的持續時間。

單一報表包含通知區段和資料區段。

### <a name="notification-section"></a>通知區段

通知區段是由一組效能分析規則所組成。 每個通知都會包含一些資料來源、一些臨界值，以及一些商務邏輯。 當您執行效能分析時，商務邏輯會根據臨界值評估資料來源，以判斷規則是否通過。 如果不是，就會出現警告，通知您有潛在的效能問題。 它也會提供可協助您解決問題的建議。 [通知] 區段一律是單一報表檢視中的第一個索引標籤。

通知區段分成兩個部分：**警告**和**其他通知**。

如果規則的資料來源符合邏輯和閾值設定的特定條件，**警告**區域中會出現警告。 警告包含下列部分：

* 警告圖示會指出潛在問題的存在。

* 規則的名稱。 例如，[**網路接收封包**捨棄] 是指向 [規則詳細資料] 頁面的連結，如[管理 advisor 套件](#bkmk-manageadvisorpacks)中所述。

* 有關潛在問題的簡單描述。

* 潛在效能問題的可能解決方法建議。

不同的伺服器可能會有極大的不同設定和使用模式，而且在所有情況下都不可能設定適用于所有伺服器的閾值和規則。 SPA 提供修改閾值的功能。 如果規則不適用您的案例，您也可以選擇停用規則。 根據預設，會啟用所有規則。 已停用的規則不會顯示在通知區域中。 如需詳細資訊，請參閱[管理 advisor 套件](#bkmk-manageadvisorpacks)。

[**其他通知**] 區域包含所有其他規則，其中不會引發警告或規則不適用。 它包含在**警告**區域中找到的類似元件。 最大的差異是，如果沒有引發警告或規則不適用，通常不會提供任何建議。

### <a name="data-sections"></a>資料區段

資料區段包含 advisor 套件根據從目標伺服器收集的原始資料所產生的效能資料。 資料區段包括一組最上層的區段和多個層級的小節。 最上層區段會顯示為索引標籤。 最上層區段底下的所有小節都會顯示在可擴充的區域中。 您可以折迭或展開每個區段，以協助專注于感興趣的區域，如下圖所示。

![資料區段](../media/server-performance-advisor/spa-user-manual-data-sections.png)

核心 OS SPA 建議程式套件和 IIS SPA 建議程式套件包含**系統總覽**區段。 本節包含有關資源使用量和設定的最上層資訊。 其他最上層區段代表效能資料的區域。 SPA 以下列方式呈現報告資料：

* **單一值**索引鍵/值組。 金鑰是一個字串，代表值的意義。 此值可以是字串、數值或布林值。 這通常用來顯示靜態資訊，例如設定、CPU 架構、總記憶體大小，以及 BIOS 版本，這不會隨著時間而改變。

* **清單值**這有時候是索引鍵/值組，但清單值可以包含多個欄位。 例如，CPU 的屬性可以顯示在含有多個資料行和多個資料列的資料表中。 每個資料列都代表一個 CPU，而每個資料行都代表 CPU 的屬性。

* **統計資料**可以視為特殊類型的單一值。 它只能包含數值資料。 在資料收集期間，許多數值資料點會波動，而不是保持不變。 例如，每次 PLA 收集效能計數器時，CPU 使用量就會變更。 僅顯示單一值無法精確地反映效能狀況。 不只顯示一個值，average、maximum、下限和90% 值是用於這類動態數值資料點。 90% 值代表該計數器在該指定收集間隔內，所有事件在其90個百分位數的活動。

* **最上層清單**通常包含特定資源的前幾名取用者，或經歷特定事件的前幾個實體。 例如，**平均 cpu 使用量的前10個**套裝程式含在資料收集期間，平均 cpu 使用率最高的前十個進程。 因為 CPU 使用量也是動態數值資料點，所以清單中也包含了 [最大值]、[最小值] 和 [90%] 值等其他統計資料，讓使用者更完整地瞭解 CPU 耗用量。

如先前章節所述，SPA 會依賴 PLA 來收集 ETW 追蹤、WMI 查詢、效能計數器、登錄機碼和設定檔，以產生報告。 請務必瞭解報表中每個資料點背後的資料來源。 SPA 透過工具提示提供這類資訊。 您可以將滑鼠指標停留在索引鍵資料行或資料列上方，以查看資料來源工具提示。 例如， **wmi： Win32\_DisDrive： Caption**表示資料來源來自 wmi 查詢、wmi 類別名稱為 Win32\_DiskDrive，而屬性為**Caption**。

### <a href="" id="side-by-side-report-"></a>並存報表

單一報表提供通知和資料區段，以協助使用者找出潛在的效能問題，但通常很難直接查看單一報表來識別潛在的效能問題。 單一報表可能包含太多資料點，因此很難找到潛在的問題。

為了解決這個問題，SPA 提供了比較兩個報表的功能。 您可以將報表與潛在問題相比較，以協助找出差異。

可以從單一報表檢視器啟動並存報表。 使用者可以按一下 [**動作**]，然後按一下 [**比較報表**] 來選取報表。 比較相同的 advisor 套件中的報表是有意義的。 您可以選擇將報表與先前的報表、時間的下一個報表，或透過搜尋功能選取的任意報表進行比較。 例如，若要隔離異常行為，您可以將基準伺服器報表與在同一部電腦上的不同時間產生的報表進行比較，或比對在另一部具有類似伺服器角色和負載的電腦上產生的報表。

並列報表看起來與單一報表非常類似。 其中包含通知區段和資料區段。 它包含與單一報表檢視器相同的通知和資料區段數目。 唯一的差別在於報表會以並列方式顯示。 每個區段都包含來源報表的資料（報表1）和目的地報表（報表2）。並列報表會顯示 advisor 套件的名稱、目標伺服器的名稱（左側的報表1和右側的報表2）、產生報告的時間，以及每份報表的資料收集持續時間。

如果您關閉 [**尋找**] 對話方塊，您可以輸入 Control + F 來重新開機它。這個對話方塊會尋找並反白顯示目前區段中的文字字串。

在 [通知] 區段中，如果兩份報告中所比較的任何結果是警告，則會列在**警告**區域中。 否則，結果會列在 [**其他通知**] 區域中。 因為並存報告的索引鍵是要識別報表之間的差異，所以不會顯示有關規則的詳細資訊。 使用者可以按一下規則名稱，以顯示規則的詳細資訊表單，以取得規則的詳細資訊。

在資料區段中，資料會以並排方式呈現，與左側的報表1中的資料和右側的 [報表 2] 中的資料相同。 SPA 會在同一個資料表中顯示單一值，但不會標記資料行**值**，而是分別命名為**Report 1**和**report 2** 。 並列報表會顯示並存資料表中所有其他形式的資料。

並列報表檢視器也會提供資料來源的相關工具提示。

### <a name="historical-and-trend-charts"></a>歷程記錄和趨勢圖

只有在顯示特定伺服器和特定 advisor 套件的趨勢和歷程記錄圖表時，才有意義。 您必須選擇時間範圍（預設為上周），然後按一下 **[確定]** 以顯示 [趨勢] 和 [歷史圖表檢視器]。

[趨勢] 和 [歷程記錄] 圖表檢視器有三個索引標籤：歷程記錄圖表、24小時趨勢圖表和7天趨勢圖。

### <a name="historical-chart"></a>歷史圖表

歷程記錄圖表會在給定的時間範圍內，顯示數值資料點的一系列值。 例如，過去15天內，IIS 在單一伺服器上的**平均要求延遲**。 歷程記錄圖表中的每個資料點都代表在一個效能分析會話中所採用的特定資料來源的值。

有幾種方式可以使用歷程記錄圖表：

1.  為了協助您在特定時間尋找資料點的異常狀況（例如，每日上午2:00，IIS 的**平均要求延遲**會從200毫秒到500毫秒）。

2.  協助讓多個資料點相互關聯。 例如，顯示過去15天內**平均要求延遲**和**平均要求計數**。 報表可能會顯示要求延遲和要求計數在相同的時間點增加，這可能表示要求延遲增加是因為要求計數增加所造成。

在歷程記錄圖表中，使用者可以執行下列動作：

* 在圖表區域中顯示多個資料數列。 在報表檢視器中，每個資料序列都會顯示為折線圖。 每個折線圖都會自動縮放以納入報表檢視器中。

* 在歷程圖表檢視器底部的資料序列清單中，加入或移除資料數列。

* 顯示或隱藏資料數列清單中的資料序列。 使用者可以按一下清單中的特定資料數列，以反白顯示圖表區域中對應的折線圖。

* 選取圖表區域內的時間週期，以放大特定的時間週期。 若要縮小，請按一下位於圖表左下角的按鈕。

* 按兩下特定資料點來調查單一報表。

* 複製資料，並將其提供給其他程式（例如 Microsoft Excel）。 這可讓您在適當時使用 Microsoft Excel 圖表功能。

### <a name="trend-charts"></a>趨勢圖

許多重複的效能問題都是由在或針對目標伺服器執行的定期工作所造成。 例如，娛樂導向網站可能會在週末期間取得更多的時間，或排程磁片備份工作可能會在每天上午2:00 關閉伺服器的效能。

趨勢圖的設計可協助您找出這類效能問題。 效能問題可能會在各種模式中重複發生。 最常見的模式是每日模式和每週模式，其中的效能問題會在一天的同一小時或一周的同一天發生。 因此，SPA 提供了24小時趨勢圖表和7天趨勢圖。

趨勢分析圖形針對一組資料提供更深入的調查，並根據一天的時間來尋找趨勢。 X 軸設定為24小時的期間，從0:00 （午夜）開始，並于23:59 結束。 SPA 不會同時顯示多個資料數列的趨勢。 您可以按一下 [**挑選資料數列**] 來選取要查看的資料數列。

為了處理資料，SPA 會尋找每小時在0:00 與0:59 之間取得的所有快照集。 SPA 會針對在該小時內拍攝的快照集，決定最小、最大、平均和 sigma 值，並將其圖形化為 k 線圖。 SPA 會針對在1:00 到1:59 之間拍攝的快照集重複此程式，然後針對2:00 到2:59，依此類推。 如果指定的小時內沒有任何快照集存在，SPA 會將該小時保留在圖形上，並繼續到下一個小時。

7天趨勢圖非常類似于24小時趨勢圖。 唯一的不同之處在于，它會根據一周中的日期，而不是一天的一小時來分組資料數列。

您在 [趨勢] 和 [歷程記錄] 圖表中選取的資料數列會儲存為使用者喜好設定。 下一次針對相同的 advisor 套件開啟 [趨勢] 和 [歷程圖表檢視器] 時，會將同一組資料數列列為預設值。

## <a name="managing-reports"></a>管理報表


### <a name="deleting-reports"></a>刪除報表

您可以移除報告，以將需要由 SPA 管理的報告數目降至最低。 根據報告的頻率和伺服器數目，我們建議您刪除不必要的報告。 雖然 SPA 不會限制它可以管理的報告，但基礎資料庫可能會有大小限制。

**注意：** 已刪除的報表無法取消刪除。

 

### <a name="exporting-and-importing-reports"></a>匯出和匯入報表

您可以將報告匯出至 XML 檔案，以傳輸至另一個 SPA 主控台，或傳送電子郵件給另一位使用者。 匯出報表並不會刪除報表。 若要匯出目前已查看的報表，請從 [**報表檢視器]** 按一下 [**動作**]，然後按一下 [**匯出**]。 若要匯出多個報表，請在 [**報表] Explorer**中，按一下 [**啟用多重選取**]，從選取方塊中選取多個報表，然後按一下 [**匯出**]。 這會將 XML 格式的報表匯出到選取的目的地目錄。

匯出的報表可以在 SPA 中查看。 匯入的報表不會新增至 SPA 資料庫。 它們主要是用來當做匯出報表的 XML 檢視器應用程式。 匯入報表的伺服器不需要安裝相同的 advisor 套件做為原始匯出的報表 SPA 主控台。

## <a href="" id="bkmk-manageadvisorpacks"></a>管理 advisor 套件


SPA 包含適用于核心作業系統、Hyper-v、active directory 和 IIS 的 advisor 套件。 SPA 提供使用 SQL 開發 advisor 套件的開放式架構，因此非 Microsoft 開發人員也可以建立 advisor 套件的版本。 有四個選項可管理 advisor 套件：布建、自訂、重設或移除。

### <a name="provision-new-advisor-packs"></a>布建新的 advisor 套件

新的 advisor 套件可以由 Microsoft 或非 Microsoft 開發人員發行。 Advisor 套件包含 provisionMetaData，以及描述邏輯的一組 SQL 腳本。

**若要布建新的 advisor 套件**

1.  複製 *% SpaRoot%* \\ap 目錄下的 advisor 套件的所有內容。

2.  在主視窗中 **，按一下 [** 設定]，然後按一下 [**設定 Advisor 套件**]。 [**設定 Advisor 套件**] 對話方塊隨即開啟。

    **注意**這個對話方塊與第一次使用 Wizard 中的 [布建**advisor 套件**] 頁面類似。 它會顯示可供管理的 advisor 套件清單。 清單中的每個 advisor 套件都具有 [名稱]、[已安裝版本]、[版本] 和 [作者] 等屬性。 Name 是 advisor 套件的完整名稱，而已安裝的版本是已在專案中布建的此 advisor 套件的版本。 如果未在目前的資料庫中布建 advisor 套件，[已安裝的版本] 文字方塊就會顯示 [**未安裝**]。 [版本] 欄位會指出此建議程式套件的版本，其會在 [advisor 套件] 資料夾底下。

     

3.  從清單中選取 [advisor] 套件。 如果尚未布建 advisor 套件，或如果 advisor 套件資料夾中有較新的版本，則會啟用 [**提供**] 按鈕。 按一下 [**布**建] 按鈕。

4.  布建完成時，所選 advisor 套件的 [**已安裝的版本**] 欄位會包含新的版本資訊。

### <a name="customize-advisor-packs"></a>自訂 advisor 套件

SPA 會定義可讓使用者修改 advisor 套件的開放式架構。 使用者可以藉由變更閾值、共用閾值，以及啟用或停用規則來修改 advisor 套件檔案。

如需如何變更和組建 advisor 套件的詳細資訊，請參閱[Server Performance Advisor 套件開發指南](server-performance-advisor-pack-development-guide.md)。

### <a name="changing-thresholds"></a>變更閾值

在 SPA 中會使用閾值來判斷是否符合規則的觸發條件。 真實客戶案例的實際臨界值可能會因為工作負載、硬體環境和商務需求而有極大的差異。 預設臨界值對目前的使用者案例可能不是正確的，因此 SPA 提供了修改現有閾值的功能。

您可以在單一或並存的報表中按一下規則名稱，以修改臨界值。 或者，若要管理特定 advisor 套件的所有規則，他們可以**從 [設定**] 功能表修改臨界值。

**變更臨界值**

1.  **在 [** 設定] 功能表中，按一下 [**設定 Advisor 套件**]，按一下要修改的 Advisor 套件名稱，然後按一下 [**設定**]。

    **注意**您會看到包含在 advisor 套件中的所有規則清單。 Advisor 套件名稱左邊的核取方塊指出是否已啟用規則。 如果規則已停用，則會在所有報表中隱藏。

     

2.  按一下您要修改的特定規則。 所選取規則的 [**規則詳細資料**] 表單隨即開啟。

[規則詳細資料] 表單包含特定規則的詳細資訊。 其中包括名稱、描述、狀態、可能的結果和閾值。 SPA 支援兩種類型的規則結果： [**警告** **] 和 [確定]** 。 針對每個類型，有建議文字和建議。

部分規則未定義臨界值。 例如， **HTTP 保持**運作規則會檢查 IIS 的布林值設定。 因此閾值清單可能是空的。 否則，會列出目前規則所使用的所有臨界值。 如需有關如何在規則中使用閾值的詳細說明，請注意這項描述的一部分。

如果從 [設定 **] 功能表啟動 [** **規則詳細資料**] 表單，閾值清單會有三個數據行： [名稱]、[原始設定] 和 [變更設定]。 如果是從單一或並存報表啟動，則也會包含報表所使用的臨界值。 使用者可以藉由變更 [**變更設定**] 資料行中的值來修改目前的臨界值，然後按一下 [**儲存**] 將變更儲存到資料庫。

對臨界值所做的所有變更，只會套用到變更後所產生的報告。 這些變更不會影響現有的報表。

### <a name="sharing-thresholds"></a>共用閾值

如果您在類似情況下管理伺服器，您可以選擇使用相同的閾值集。 您可以使用 [設定] 功能表來匯出和匯入特定 advisor**套件的臨界**值。 您可以選取特定的 advisor 套件，然後按一下 [**設定**]。 匯出的閾值檔案是 XML 格式。

匯入臨界值時，SPA 會驗證 XML 檔案格式，並確認檔案符合選取的 advisor 套件。 如果成功，SPA 會將閾值檔案中的所有值匯入到目前的專案資料庫。 與先前的變更臨界值案例類似，所有閾值變更只會對未來產生的報表生效。 現有的報表不會受到影響。

### <a name="enable-or-disable-rules"></a>啟用或停用規則

您可以從 [**規則詳細資料**] 表單啟用或停用規則。 您需要按一下 [**儲存**] 以保存所做的變更。 如果規則已停用，則不會顯示在任何報表中。 但是產生報表時，會觸發基礎商務邏輯，因此當您選擇重新啟用規則時，它會再次顯示在報表中。

### <a name="reset-advisor-packs-to-original-state"></a>將 advisor 套件重設為原始狀態

您可能會決定在資料庫中修改已布建的 advisor 套件。 除了變更閾值，您也可以變更 SQL 腳本。 SPA 不支援變更報表中繼資料，或新增或移除已布建之 advisor 套件的規則。 手動修改這些區域可能會導致非預期的行為。

如需有關變更已布建的 advisor 套件的詳細資訊，請參閱[Server Performance Advisor 套件開發指南](server-performance-advisor-pack-development-guide.md)。

如果您想要復原已布建的 advisor 套件上所做的變更，您可以選擇重設 advisor 套件。 這會覆寫所有與 advisor 封裝相關的 SQL 腳本，並重設所有的預設臨界值。 這會保留所有現有的報表。

您可以使用 [**設定 Advisor 套件**] 表單來重設 advisor 套件。 您必須選取要重設的 advisor 套件，然後按一下 [**重設**]。

### <a name="remove-advisor-packs"></a>移除 advisor 套件

當不再需要 advisor 套件時，使用者可以從資料庫中將它移除。 移除 advisor 套件會從資料庫移除有關 advisor 套件的所有專案，包括規則和閾值、所有 SQL 腳本，以及所有報告。 沒有任何動作可以復原。

您可以使用 [**設定 Advisor 套件**] 表單來移除 advisor 套件。 您必須選取要移除的 advisor 套件，**然後按一下 [** 取消布建]。

### <a name="update-existing-advisor-packs"></a>更新現有的 advisor 套件

更新現有的 advisor 套件非常類似于將 advisor 套件重設為其原始狀態。 若要將 advisor 套件更新為較新的版本，請將新的 advisor 套件複製到 advisor 套件資料夾。 只有在沒有任何報表中繼資料變更時，才會將 advisor 套件視為現有的建議程式套件的更新。 報表和規則識別碼必須相同。 否則，應該將它們視為兩個不同的 advisor 套件。

如果只有商務邏輯變更，而且不會變更 advisor 套件的任何報表中繼資料，則應該提供新的版本號碼，例如從1.0 到2.0。 如果有報表中繼資料變更，則建議程式套件應具有不同的完整名稱。 例如，您可以將 ServerPerformanceAdvisor 變更為 ServerPerformanceAdvisor. IIS. V2。

如果有較新版本的 advisor 套件存在，[**設定 Advisor 套件**] 表單中的清單會自動以最新版的 advisor 套件填入 [**版本**] 欄。 您可以選取 [advisor] 套件，然後按一下 [**重設**]。 Advisor 套件會以新的商務邏輯和臨界值進行更新。 此 advisor 套件的所有報表都會保留下來。

## <a name="managing-servers"></a>管理伺服器


SPA 提供管理目標伺服器的基本功能。 您可以選擇將新的伺服器加入目標伺服器清單、從清單中移除伺服器，或修改伺服器的備註。

**若要新增或移除伺服器或修改伺服器資訊**

1.  按一下 [設定] 功能表，然後按一下 [**設定伺服器**]。

2.  在目前存在於專案資料庫的伺服器清單中，最後一個資料列是空的。 按一下資料列，並填寫欄位。 [**伺服器名稱**] 和 [檔案**共用位置**] 資料夾欄位是必要的，而且伺服器名稱必須是唯一的。

3.  在每部伺服器的 [**備註**] 資料行中，輸入其他伺服器資訊。

    **注意**此欄位使用自由文字格式，因此您可以使用它做為描述欄位。 或使用此欄位來標記伺服器，讓它們可以在主視窗中輕鬆找到，或依位置或伺服器角色來分組伺服器。

     

4.  如果您想要使用具有大量伺服器的 SPA，SPA 支援以逗號分隔值（.csv）格式進行匯入。 檔案必須包含至少兩個欄位： [**伺服器**] 和 [檔案**共用位置**]。 第三個欄位是選擇性的**批註**，但建議您組織伺服器。 您也可以將伺服器清單匯出成 .csv 檔案，以判斷適當的格式或備份您的伺服器設定。

### <a name="searching-and-filtering"></a>搜尋和篩選

如果您管理的伺服器超過幾部，SPA 會提供基本支援，以在主視窗中快速尋找伺服器。 您可以按一下資料行標頭，以根據伺服器名稱、分析結果、目前工作狀態或備註進行排序。 您也可以選擇使用 [搜尋] 功能。 在主視窗的右上角，您可以輸入要搜尋的字串。 主視窗中的**目標伺服器**清單會使用字串來篩選伺服器，而且只會顯示具有 [名稱] 或 [批註] 欄位的伺服器，其中包含搜尋字串。

下圖顯示字串**dell**如何比對伺服器與包含**dell**的 [具有下列條件的**dell**或伺服器的字串]**批註**欄位。

![搜尋和篩選範例](../media/server-performance-advisor/spa-user-manual-find-search-example.png)

## <a name="advanced-functionality"></a>先進的功能


### <a name="working-with-spa-windows-powershell-cmdlets"></a>使用 SPA Windows PowerShell Cmdlet

SPA 主控台支援透過 UI 進行週期性資料收集。 如果該功能不足以供您的環境使用，則有一些 Windows PowerShell Cmdlet 可供「先進的系統管理員」用來自訂資料收集。 這些 Windows PowerShell Cmdlet 可讓系統管理員在目標伺服器上自動執行效能分析，並使用 SPA 進行遠端客戶支援。 例如，系統管理員可以撰寫腳本，以在特定時間間隔內叫用 SPA Cmdlet，定期取樣目標伺服器的效能狀況。

我們建議您先關閉 SPAConsole 應用程式，再使用這些 Cmdlet。

執行任何 Windows PowerShell Cmdlet 之前，您必須先在主控台電腦上註冊 Cmdlet。

**註冊 Windows PowerShell Cmdlet**

1.  從提高許可權的 Windows PowerShell 命令提示字元中，輸入**registerSpaCmdlets。** [**註冊 SPA Cmdlet 成功**] 訊息隨即出現。

2.  執行**SPA-PowerShell。** 如果您將路徑傳遞至 Windows PowerShell 腳本檔案，它就會自動執行腳本。 否則，它會開啟 Windows PowerShell 命令提示字元，其已準備好執行 SPA Windows PowerShell Cmdlet。

下表描述 SPA Windows PowerShell Cmdlet：

| Cmdlet 名稱 | Parameters | 描述 |
| ------ | ------- | ------ |
| 開始-SpaAnalysis | **-ServerName**目標伺服器的名稱。<br>**-AdvisorPackName**要在伺服器上排入佇列之 advisor 套件的完整名稱。 當有多個套件排程為同時執行時，參數的值應格式化為 AP1name，AP2name。<br>**-持續時間**資料收集的持續時間。<br>**-認證**在目標伺服器上執行資料收集之帳戶的使用者認證。<br>**-SqlInstanceName**SQL Server 實例的名稱。<br>**-SqlDatabaseName**SPA 專案資料庫的名稱。 | 在指定的伺服器上啟動 SPA 資料收集會話。 |
| 停止-SpaAnalysis | **-SqlInstanceName**SQL Server 實例的名稱。<br>**-SqlDatabaseName**SPA 專案資料庫的名稱。<br>**-ServerName**目標伺服器的名稱。 | 嘗試停止執行中的 SPA 會話。 如果會話已完成，則會傳回，而不會執行任何動作。 |
| SpaServer | **-SqlInstanceName**SQL Server 實例的名稱。<br>**-SqlDatabaseName**SPA 專案資料庫的名稱。 | 取得資料庫中的伺服器清單。 它會傳回物件的清單，包括下列屬性：名稱、狀態、檔案共用和批註。 |
| SpaAdvisorPacks | **-SqlInstanceName**SQL Server 實例的名稱<br>**-SqlDatabaseName**SPA 專案資料庫的名稱 | 取得資料庫中的 advisor 套件清單。 它會傳回物件的清單，包括下列屬性： Name、DisplayName、Author 和 Version。 |

Windows PowerShell 提供透過加密檔案傳遞認證的功能，以啟用自動化案例。 如需使用加密檔案將認證傳遞給 Cmdlet 的詳細資訊，請參閱[建立可接受認證的 Windows PowerShell 腳本](https://technet.microsoft.com/magazine/ff714574.aspx)。

### <a name="automating-spa-report-collection-by-using-windows-powershell"></a>使用 Windows PowerShell 自動化 SPA 報表集合

下列程式代表如何使用 SPA Windows PowerShell Cmdlet 自動化 SPA 報表集合的範例。

使用者認證可以透過 Windows PowerShell 進行加密和快取。 這些認證可用來登入遠端伺服器。 雖然不是 SPA 特有的，但下列範例會示範這項技術：

``` syntax
$fileName = 'D:\temp\operator.txt'
$userName = 'domainname\operator'
 
# save credential to file
$(Get-Credential).Password | convertFrom-SecureString | Set-Content $fileName
 
# load credential from file
$credential = New-Object System.Management.Automation.PsCredential $userName, $(Get-Content $fileName | convertTo-SecureString)
 
# run command
.\start-SpaAnalysis  ServerName: Server1  Credential: $credential  AdvisorPackName:Microsoft.ServerPerformanceAdvisor.CoreOS.V1 10  Duration:10  SqlInstanceName: .\SQLExpress  SqlDatabaseName:SPA8294
```

您必須先執行**Executionpolicy remoteSigned** ，才能執行此檔案。

您可以使用下列命令，從批次檔執行它：

``` syntax
PowerShell -command "& '.\RunSpa.ps1' "
```

### <a name="use-t-sql-to-generate-reports"></a>使用 T-sql 產生報表

您可以使用 SQL 來解壓縮 SPA 報表資料，而不是在 SPAConsole 中提供的自訂報表。

例如，下列 T-sql 命令會針對涵蓋過去三天的時間範圍，提供依 CPU 列出的前10部伺服器清單：

``` syntax
select TOP 10
   MachineName,
   AverageCpu
FROM (
   select
      __MachineName MachineName,
      AVG(AverageValue) AverageCpu
   FROM [SPA].[Microsoft.ServerPerformanceAdvisor.CoreOS.V1].vwCpuPerformance
   WHERE __Creationtime > dateadd(DAY, -3, GETUTcdate())
      AND Name = N'% Processor time' AND CpuId = N'_Total'
   GROUP BY __MachineName
) t
OrdER BY t.AverageCpu DESC 
```

### <a name="working-with-multiple-projects"></a>使用多個專案

在某些情況下，您可能會想要分割 SPA 所使用的 SQL Server 資料庫。 這有助於減少 SQL Server 資料庫的資料大小，或協助您以邏輯方式分割伺服器。 在這些情況下，SPA 主控台支援多個專案。 您可以按一下 [檔案 **]，然後按一下 [** **新增專案**]，以建立新的專案資料庫。 第一次使用 Wizard 時，會出現協助建立新的專案資料庫。

建立專案之後，您可以按一下 [檔案]，然後按一下 [**開啟專案** **]，在**專案之間切換。 當未完成的效能分析在目前開啟的專案內執行時，SPA 主控台不允許切換資料庫。 這是為了保護效能資料的完整性。

當您選擇建立新的專案資料庫或開啟不同的專案資料庫時，會關閉目前的專案。 當目前的專案關閉時，所有開啟的報表都會關閉。

**注意**SQL Server 2008 R2 Express 有 10 GB 的資料庫限制。 藉由使用多個專案，您可以使用一或多個 SQL Server 資料庫，並保持在 10 GB SQL Server 2008 R2 Express 限制之下。

 

### <a name="logging-and-debugging"></a>記錄和調試

SPA 提供基本的記錄功能。 它只允許將記錄寫入記錄檔，該檔案位於與 SPAConsole 相同的資料夾中。 執行 SPA 主控台的使用者帳戶必須具有安裝 SPA 之資料夾的 [寫入] 許可權，才能確保記錄檔可以寫入記錄檔。

SPA 包含下列有效的記錄層級：

* **資訊**傾印 SPA 主控台所採用之每個動作的記錄，其主要是為了進行偵錯工具而設計的。

* **警告**記錄 SPA 主控台內發生的所有失敗和例外狀況。 部分失敗只是驗證失敗，可由 SPA 主控台處理。

* **重大**只記錄 SPA 主控台無法處理的失敗和例外狀況。 這些失敗會導致 SPA 主控台損毀。 記錄會提供這類失敗的內容資訊。

根據預設，記錄層級為 Warning，這表示 SPA 只會記錄在 SPA 中發生的失敗和例外狀況。 您可以藉由編輯 SpaConsole 所在資料夾中的**SpaConsole** ，來變更記錄層級。 所有記錄檔都會寫入相同資料夾中的記錄檔 .txt 檔案。

SPA 也提供一些基本的功能來進行偵錯工具。 若要開啟 SPA 的偵錯工具，使用者必須手動修改 SPA 專案資料庫。 設定會儲存在 [設定] 資料表中。 使用者需要執行下列 SQL 腳本，以將 SPA 專案變更為 [debug] 模式：

``` syntax
UPdate [Configurations] SET Value = N'true' WHERE Name = N'Debugmode'.
```

在 [偵錯工具] 模式中，SPA 架構會保留在效能分析期間產生的所有暫存資料，讓您可以針對 advisor 套件中的問題進行疑難排解。 此腳本主要是設計來供 advisor 套件開發人員使用。

如需 SPA 中偵錯工具功能的詳細資訊，請參閱[Server Performance Advisor 套件開發指南](server-performance-advisor-pack-development-guide.md)。

### <a name="managing-the-database"></a>管理資料庫

### <a name="backup-and-restore-the-database"></a>備份和還原資料庫

SPA 主控台不提供備份和還原 SPA 資料庫的功能。 您應該使用標準 Microsoft SQL Server 工具和腳本來備份和還原資料庫。

### <a name="clean-up-the-database"></a>清除資料庫

SPA 專案資料庫的大小可能會增加，因為會執行更多效能分析。 根據預設，SPA 會保留所有報告。 您可能想要移除舊的報表，以協助改善效能。 您可以透過**報表瀏覽器**介面刪除報表。

## <a name="privacy-and-security"></a>隱私權和安全性


SPA 僅支援從目標伺服器到 SPA 主控台的資料收集。 它並非設計來將任何資訊傳送給 Microsoft 或非 Microsoft 開發人員。 如需 SPA 隱私權的詳細資訊，請參閱 Server Performance Advisor 的 Microsoft 軟體授權條款。

SPA 所收集的所有資料都會儲存在專案資料庫中。 基於部分 ETW 追蹤的本質，SPA 可能會收集可能具有高商業重要性的敏感性資訊。 您應該知道與共享 SPA 專案資料庫的存取相關聯的潛在風險。 暫存記錄檔會儲存在每部目的電腦上指定的共用資料夾底下。 雖然 SPA 會在資料匯入完成時嘗試刪除這些臨時記錄檔，但並不保證一律會刪除這些記錄檔。 您應該確保共用資料夾位於安全的位置。

SPA 建議程式套件包含用來剖析和分析效能記錄以產生效能報告的 SQL 腳本。 SPA 會嘗試限制用來執行腳本的許可權。 不過，腳本仍然有可能會透過 SPA 從目標伺服器收集機密資訊，或是取得或修改儲存在相同 SPA 專案資料庫中的機密資訊。 您必須確定布建到 SPA 專案資料庫的所有 advisor 套件都來自受信任的來源。

## <a name="errors-and-troubleshooting"></a>錯誤和疑難排解


### <a name="spaconsoleexe-does-not-start-or-write-log-file"></a>SPAConsole 不會啟動或寫入記錄檔

當您第一次嘗試執行 SPAConsole 時，如果未安裝 .NET Framework，應用程式就不會啟動或寫入記錄檔。 請先確定 compatible.NET 架構已安裝且正常運作，然後再啟動 SPA。

### <a name="locating-log-information"></a>尋找記錄資訊

SPA 會將失敗資訊儲存在 [SPA] 資料夾下的 [readme.txt] 檔案中。 詳細的錯誤訊息和呼叫堆疊資訊會寫入此資料夾。 如果您遇到需要詳細資訊來解讀的失敗，您可以開啟記錄檔 .txt 檔案以查看錯誤詳細資料。

### <a name="database-size-limitations-for-sql-server-express"></a>SQL Server Express 的資料庫大小限制

SQL Server Express 的使用者資料庫大小限制為 10 GB。 此大小資料庫具有儲存 20000-30000 報告的容量。 若要降低達到此資料庫限制的可能性，我們建議定期刪除報表，並（或）使用不具有 10 GB 使用者資料庫限制的另一個 SQL Server 版本。

### <a name="sql-server-express-log-size-and-disk-capacity"></a>SQL Server Express 記錄大小和磁片容量

如果您使用 SQL Server Express，則使用者資料庫的限制為 10 GB，但對應的記錄檔可能會超過 70 GB。 基於這些理由，建議 SQL Server Express 100 GB 或更多的可用磁碟空間。 此磁碟空間應足以儲存大約20000到30000的報表。 此記錄檔的名稱為 SPADB\_log .ldf，位於 **% Program Files%\\Microsoft SQL Server\\mssql10.mssqlserver。SQLEXPRESS\\MSSQL\\資料**。

### <a name="failure-to-connect-to-target-server"></a>無法連接到目標伺服器

當您在目標伺服器上執行效能分析時，執行 SPA 主控台的使用者帳戶必須具有特定許可權，才能將資料收集器集合人員佇列至目標伺服器上的 PLA。 Windows 防火牆設定也需要變更，以允許在通過的 PLA 通訊。 如需詳細的設定指示，請參閱[設定 SPA](#bkmk-setupspa)。

### <a name="failure-to-create-pla-data-collection-set-on-the-target-server"></a>無法在目標伺服器上建立 PLA 資料收集組

如果您收到 [無法在目標伺服器上建立 PLA 資料收集組] 訊息，請務必執行下列動作：

* 請確定**效能記錄 & 警示**服務正在執行

* [安全性設定] [**網路存取：不允許儲存密碼] 和 [網路驗證的認證**] 已停用。 必須停用安全性設定，因為 SPA 需要使用使用者認證，在目標伺服器上建立資料收集組。

### <a href="" id="running-spa-against-the-console-"></a>針對主控台執行 SPA

如果目標伺服器與 SPA 主控台相同，則 PLA 會經歷不同的通道。 即使使用者帳戶是以系統管理員許可權執行 SPA 主控台，PLA 也會失敗。 如果 SPA 主控台安裝在目標伺服器上，使用者必須以系統管理員身分啟動 SPA，以確保效能分析工作可以在主控台上執行。

### <a name="running-multiple-consoles-at-the-same-time"></a>同時執行多個主控台

SPA 不支援同時針對相同的 SPA 專案資料庫執行多個主控台。 SPA 也不提供鎖定和同步處理機制來避免發生此情況。 如果兩個 SPA 主控台同時執行，主控台的行為會因這些 SPA 主控台執行的時間序列而不一致。 為避免這種情況，所有排入佇列的效能分析會話都應該從清單中移除，然後才由啟動分析的主控台進行處理。

SPA 會保護 SPA 成功產生之每個報告的完整性。 同時，SPA 並不保證所有排入佇列的分析工作都已完成。 如果您看到效能分析會話的狀態變更不一致，或宣告系統找不到由資料收集器集合程式所產生的效能記錄檔，可能是因為多個 SPA 主控台實例以相同的方式執行。SPA 專案資料庫。

執行 SPA Windows PowerShell Cmdlet 也可能會受到針對相同 SPA 資料庫執行的 SPA 主控台所影響。 我們建議您先關閉 SPA 主控台，再執行 SPA Windows PowerShell Cmdlet。

### <a name="spaconsoleexe-recurring-collection-is-disrupted"></a>SPAConsole 重複收集中斷

當您執行 SPAConsole 並使用週期性資料收集（例如，每小時的集合）時，執行 SPAConsole 的伺服器不應該處於省電模式，因此它可以暫停。 SPA 不會檢查是否有電源儲存原則。 這個暫停的活動可能會中斷週期性週期性資料收集。

### <a name="lost-etw-events"></a>遺失 ETW 事件

為了在目標伺服器上建立最小效能影響，PLA 的設計是在收集效能資訊時以低優先順序執行。 如果目標伺服器忙碌中，則 PLA 可以卸載一些資料收集工作，以對在目標伺服器上執行的高優先順序工作進行作業。 您應該考慮設定共用資料夾，其中的事件會寫入不會與工作負載 s i/o 衝突的磁片，或更快的磁片磁碟機（例如 SSD）。 當事件被捨棄時，報表會在報表檢視中報告，因為遺失的事件可能會影響所產生效能計量的可靠性。

某些許可權問題也可能會導致略過登錄或 WMI 查詢。 不過，這比 ETW 事件遺失更不可能發生。 因此，資料收集器集合結果有時不會包含所有要求的值。 您必須確定所有 advisor 套件的 T-sql 腳本都會處理此情況。 如果資料不存在於資料收集結果中，則會在報表中將其標示為 [無資料]。

因為對 PLA 而言，ETW 事件遺失是常見的，所以根據 ETW 追蹤產生的資料點可能不會與根據（例如效能計數器）所產生的資料點一致。 例如，您可以看到 IIS 的總 CPU 使用量是80% （來自效能計數器），而前幾個 Url 只會使用10% 的所有 CPU 時間（也就是來自 ETW 追蹤的資料點）。 通常，您可以透過資料點的工具提示來查看一個資料點的資料來源。 您應該瞭解這類資料遺失的影響。

若要避免這類事件遺失，應將結果資料夾關閉到目標伺服器。

如果資料收集器結果包含 ETW 追蹤遺失以外的不完整資料，且 advisor 套件開發人員已新增 ETW 事件遺失通知的支援，則會在單一報表頂端顯示資訊列，以通知使用者可能的資料遺失導致不一致的報表。 詳細資料遺失資訊可以在記錄檔 .txt 檔案中找到。

## <a name="glossary"></a>詞彙


以下是搭配 SPA 使用的一些詞彙：

* **Advisor 套件**中繼資料和 T-sql 腳本的集合，可處理從目標伺服器收集的效能記錄。 然後，advisor 套件會從效能記錄資料產生報告。 Advisor 套件中的中繼資料會定義要從目標伺服器收集的資料，以進行效能測量。 中繼資料也會定義一組規則、臨界值和報表格式。 最常見的情況是，建議程式套件是專為單一伺服器角色撰寫，例如，Internet Information Services （IIS）。

* **SPA 主控台**SpaConsole，這是 SPA 的核心部分。 SPA 不需要在您要測試的目標伺服器上執行。 SPA 主控台包含 SPA 的所有使用者介面，從設定專案到執行分析和查看報表。 根據設計，SPA 是兩層式的應用程式。 SPA 主控台包含 UI 層和部分的商業邏輯層。 SPA 主控台會排程和處理效能分析要求。

* **SPA 架構**提供所有使用者介面、效能記錄處理、設定、錯誤處理和資料庫 Api，以及管理程式。

* **SPA 專案**一種資料庫，其中包含在 advisor 套件的目標伺服器上產生之目標伺服器、advisor 套件和效能分析報表的所有相關資訊。 您可以比較和查看相同 SPA 專案內的歷程記錄和趨勢圖。 您可以建立一個以上的專案。 SPA 專案彼此獨立，而且不會在專案之間共用資料。

* **目標伺服器**執行 Windows Server 並具有特定伺服器角色（例如 IIS）的實體電腦或虛擬機器。

* **資料分析會話**特定目標伺服器上的效能分析。 資料分析會話可以包含多個 advisor 套件。 來自這些 advisor 套件的資料收集器集合會合並成單一資料收集器集合。 單一資料分析會話的所有效能記錄都會在同一時間週期內收集。 分析在相同資料分析會話中執行的 advisor 套件所產生的報表，可協助使用者瞭解整體效能狀況，並找出效能問題的根本原因。

* **Windows 事件追蹤**Windows 中提供的高效能、低負擔、可擴充的追蹤系統。 它提供程式碼剖析和偵錯工具功能，可用於針對各種案例進行疑難排解。 SPA 會使用 ETW 事件做為產生效能報告的資料來源。 如需 ETW 的一般資訊，請參閱[使用 Etw 改善偵錯工具和效能微調](https://msdn.microsoft.com/magazine/cc163437.aspx)。

* **Windows Management Instrumentation （WMI）** Windows 中管理資料和作業的基礎結構。 您可以撰寫 WMI 腳本或應用程式，將遠端電腦上的系統管理工作自動化。 WMI 也會提供管理資料給作業系統的其他部分和產品。 SPA 會使用 WMI 類別資訊和資料點做為產生效能報告的來源。

* **效能計數器**用來提供作業系統或應用程式、服務或驅動程式執行狀況的相關資訊。 效能計數器資料有助於判斷系統瓶頸，並微調系統和應用程式效能。 作業系統、網路和裝置會提供計數器資料，讓應用程式可以取用，讓使用者以圖形方式顯示系統的執行程度。 SPA 會使用效能計數器資訊和資料點做為來源，以產生效能報告。

* **效能記錄檔及警示（PLA）** 收集效能記錄檔和追蹤，並在符合特定觸發程式時引發效能警示。 PLA 可以用來收集效能計數器、Windows 事件追蹤（ETW）、WMI 查詢、登錄機碼和設定檔案。 PLA 也支援透過遠端程序呼叫（RPC）進行遠端資料收集。 使用者定義資料收集器集合程式，其中包含要收集之資料的相關資訊、資料收集的頻率、資料收集持續時間、篩選，以及儲存結果檔案的位置。 SPA 會使用 PLA 來收集來自目標伺服器的所有效能資料。

* **單一報表**根據單一目標伺服器上一個 advisor 套件的一個資料分析會話所產生的 SPA 報表。 它可以包含通知和各種資料區段。

* **並存報表**一種 SPA 報表，可比較相同 advisor 套件的兩個單一報表。 這兩個報表可以從不同的目標伺服器，或從相同目標伺服器上的個別效能分析執行產生。 並存報表會建立比較兩個報表的功能，以協助使用者識別其中一個報表中的異常行為或設定。 並列報表包含通知和各種資料區段。 在每個區段中，這兩個報表的資料會並存列出。

* **趨勢圖**用來調查效能問題重複模式的 SPA 報表。 許多重複的效能問題都是由伺服器或用戶端電腦上的排程伺服器負載變更所造成，這可能會每日或每週發生。 SPA 提供24小時趨勢圖表和7天趨勢圖，以識別這些問題。

    使用者可以一次選擇一個或多個資料數列，這是單一報表內的數值，例如**平均 CPU 使用量總計**。 更明確地說，數值是來自單一伺服器的純量值，由單一 AP 在指定的時間實例上產生。 SPA 會將這些值分組到24個群組中，一天的每個小時都有一個（7天的報表，一周的每一天一次）。 SPA 會計算每個群組的平均值、最小值、最大值和標準差。

* **歷史圖表**SPA 報表，用來顯示一段時間內指定伺服器和 advisor 套件配對的單一報表中，特定數值的變更。 使用者可以選擇多個資料序列，並在歷程記錄圖表中顯示它們，以瞭解不同資料數列之間的相互關聯。

* **資料數列**在一段時間內從相同資料來源收集的數值資料。 相同的來源表示資料必須來自相同的目標伺服器，例如一部伺服器上 IIS 的平均要求佇列長度。

* **規則**邏輯、臨界值和描述的組合。 它們代表潛在的效能問題。 每個 advisor 套件都包含多個規則。 每個規則都是由報表產生進程所觸發。 規則會將邏輯和臨界值套用至單一報表中的資料。 如果符合條件，就會引發警告通知。 如果沒有，則會將通知設定為 [**確定]** 狀態。 如果規則不適用，則通知會設定為 [不適用（**NA**）] 狀態。

* **通知**規則向使用者顯示的資訊。 其中包括規則的狀態（ **[確定]** 、[ **NA**] 或 [**警告**]）、規則的名稱，以及可解決效能問題的可能建議。
