---
title: 效能微調遠端桌面工作階段主機
description: 遠端桌面工作階段主機的效能微調指導方針
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: hammadbu; vladmis; denisgun
author: phstee
ms.date: 10/22/2019
ms.openlocfilehash: 3227bfe3bf21343ca9b7e85a07f550b4684a2fb7
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/08/2020
ms.locfileid: "80851711"
---
# <a name="performance-tuning-remote-desktop-session-hosts"></a>效能微調遠端桌面工作階段主機


本主題討論如何選取遠端桌面工作階段主機（RD 工作階段主機）硬體、調整主機和調整應用程式。

**本主題內容：**

-   [選取適當的硬體以獲得效能](#selecting-the-proper-hardware-for-performance)

-   [調整遠端桌面工作階段主機的應用程式](#tuning-applications-for-remote-desktop-session-host)

-   [遠端桌面工作階段主機微調參數](#remote-desktop-session-host-tuning-parameters)

## <a name="selecting-the-proper-hardware-for-performance"></a>選取適當的硬體以獲得效能


針對 RD 工作階段主機伺服器部署，硬體的選擇是由應用程式集合和使用者使用它們的方式所控制。 影響使用者人數和其經驗的關鍵因素是 CPU、記憶體、磁片和圖形。 本節包含 RD 工作階段主機伺服器特有的其他指導方針，而且大部分都與 RD 工作階段主機伺服器的多使用者環境有關。

### <a name="cpu-configuration"></a>CPU 設定

在概念上，CPU 設定是藉由將所需的 CPU 乘以系統預期支援的會話數目來支援會話，同時又保有緩衝區域來處理暫時的尖峰。 多個邏輯處理器有助於減少異常的 CPU 擁塞情況，這些情況通常是由類似邏輯處理器數目的幾個 overactive 執行緒所造成。

因此，系統上的邏輯處理器越多，必須內建于 CPU 使用量估計的緩衝取邊界越低，這會導致每個 CPU 的作用中負載百分比較大。 要記住的一個重要因素是，Cpu 的數目加倍並不會有兩倍的 CPU 容量。

### <a name="memory-configuration"></a>記憶體設定

記憶體配置取決於使用者採用的應用程式;不過，您可以使用下列公式來估計所需的記憶體數量： TotalMem = OSMem + SessionMem \* NS

OSMem 是作業系統執行所需的記憶體數量（例如系統二進位影像、資料結構等等）、SessionMem 是在一個會話中執行的記憶體處理常式需要多少，而 NS 則是作用中會話的目標數目。 會話所需的記憶體數量大部分取決於會話內執行之應用程式和系統進程的私用記憶體參考集。 共用程式碼或資料頁的效果不大，因為系統上只有一個複本存在。

有一個有趣的觀察（假設備份分頁檔的磁片系統不會變更），就是系統計畫支援的並行作用中會話數目越大，每個會話的記憶體配置就越大。 如果未增加每個會話配置的記憶體數量，則作用中會話所產生的分頁錯誤數目會隨著會話數目而增加。 這些錯誤最後會造成 i/o 子系統負荷嚴重。 藉由增加每個會話所配置的記憶體數量，產生分頁錯誤的機率就會減少，這有助於降低分頁錯誤的整體速率。

### <a name="disk-configuration"></a>磁碟設定

當您設定 RD 工作階段主機伺服器時，儲存體是其中一個最受忽略的層面，而且可能是部署在此欄位中的系統最常見的限制。

在一般 RD 工作階段主機伺服器上產生的磁片活動會影響下欄區域：

-   系統檔案和應用程式二進位檔案

-   分頁檔案

-   使用者設定檔和使用者資料

在理想的情況下，這些區域應該由不同的存放裝置進行備份。 使用等量 RAID 設定或其他類型的高效能儲存體，可進一步改善效能。 我們強烈建議您使用具有電池支援之寫入快取的儲存體介面卡。 具有磁片寫入快取的控制器可提供對同步寫入作業的改良支援。 因為所有使用者都有個別的 hive，所以同步寫入作業在 RD 工作階段主機伺服器上會明顯更為常見。 登錄 hive 會使用同步寫入作業定期儲存至磁片。 若要啟用這些優化，請在 [磁片**管理] 主控台**中，開啟目的地磁片的 [內容] 對話方塊，然後在 [**原則**] 索引標籤上，選取 [在**磁片上啟用寫入**快取]，然後關閉裝置上的 [ **Windows 寫入**快取緩衝區排清] 核取方塊。

### <a name="network-configuration"></a>網路設定

RD 工作階段主機伺服器的網路使用量包含兩個主要類別：

-   RD 工作階段主機連線流量的使用方式，幾乎是由在會話內執行的應用程式和重新導向的裝置 i/o 流量所展現的繪圖模式所決定。

    例如，處理文字處理和資料輸入的應用程式每秒會耗用大約10到 100 kb 的頻寬，而豐富的圖形和影片播放會導致頻寬使用量大幅增加。

-   後端連線，例如漫遊設定檔、檔案共用的應用程式存取、資料庫伺服器、電子郵件伺服器，以及 HTTP 伺服器。

    網路流量的數量和設定檔是每個部署特有的。

## <a name="tuning-applications-for-remote-desktop-session-host"></a>調整遠端桌面工作階段主機的應用程式


在 RD 工作階段主機伺服器上，大部分的 CPU 使用率都是由應用程式驅動。 桌面應用程式通常會針對回應性優化，其目標是將應用程式回應使用者要求所需的時間降到最低。 不過，在伺服器環境中，將完成動作所需的 CPU 總使用量降到最低，以避免對其他會話造成不良影響，也同樣重要。

當您設定要在 RD 工作階段主機伺服器上使用的應用程式時，請考慮下列建議：

-   最小化背景閒置迴圈處理

    典型的範例是停用背景文法和拼寫檢查、搜尋的資料索引，以及背景儲存。

-   將應用程式執行狀態檢查或更新的頻率降至最低。

    停用這類行為，或增加輪詢反復專案與計時器引發之間的間隔，會大幅提高 CPU 使用量，因為這類活動的效果會針對許多使用中的會話快速放大。 一般範例包括連接狀態圖示和狀態列資訊更新。

-   藉由減少其同步處理頻率，將應用程式之間的資源爭用降至最低。

    這類資源的範例包括登錄機碼和設定檔。 應用程式元件和功能的範例包括狀態指示器（如 shell 通知）、背景索引或變更監視，以及離線同步處理。

-   停用註冊要從使用者登入或會話啟動開始的不必要進程。

    建立新的使用者會話時，這些程式可能會大幅提高 CPU 使用量的成本，這通常是需要大量 CPU 的程式，而且在早上的案例中可能會很耗費資源。 使用 Msconfig.exe 或 appcmd.exe 來取得在使用者登入時啟動的進程清單。 如需更詳細的資訊，您可以使用[適用于 Windows 的 Autoruns](https://technet.microsoft.com/sysinternals/bb963902.aspx)。

針對記憶體耗用量，您應該考慮下列各項：

-   確認應用程式載入的 Dll 不會重新置放。

    -   重新放置的 Dll 可以藉由選取 [處理常式 DLL 視圖] 來驗證，如下圖所示，使用[Process Explorer](https://technet.microsoft.com/sysinternals/bb896653.aspx)。

    -   在這裡，我們可以看到已重新放置了 node.js，因為 x .dll 已經佔用其預設基底位址，而 ASLR 並未啟用

        ![重新置放的 dll](../../media/perftune-guide-relocated-dlls.png)

        如果重新置放 Dll，就無法跨會話共用其程式碼，這會大幅增加會話的使用量。 這是 RD 工作階段主機伺服器最常見的記憶體相關效能問題之一。

-   若是 common language runtime （CLR）應用程式，請使用原生映射產生器（Ngen.exe）來增加頁面共用，並減少 CPU 的額外負荷。

    可能的話，請將類似的技術套用至其他類似的執行引擎。

## <a name="remote-desktop-session-host-tuning-parameters"></a>遠端桌面工作階段主機微調參數


### <a name="page-file"></a>分頁檔案

分頁檔案大小不足可能會導致應用程式或系統元件中的記憶體配置失敗。 您可以使用 [記憶體認可的位元組] 效能計數器來監視系統上已認可的虛擬記憶體數量。

### <a name="antivirus"></a>防毒軟體

在 RD 工作階段主機伺服器上安裝防毒軟體會大幅影響整體系統效能，尤其是 CPU 使用量。 強烈建議您從作用中的監看清單中排除所有存放暫存檔案的資料夾，特別是服務和其他系統元件所產生的所有資料夾。

### <a name="task-scheduler"></a>工作排程器

工作排程器可讓您檢查針對不同事件排定的工作清單。 若為 RD 工作階段主機伺服器，特別著重于設定在閒置、使用者登入或會話連線和中斷連接上執行的工作時，會很有説明。 因為部署的細節，所以可能不需要進行其中許多工。

### <a name="desktop-notification-icons"></a>桌面通知圖示

桌面上的通知圖示可能會有相當昂貴的重新整理機制。 您應該停用任何通知，方法是移除從啟動清單註冊它們的元件，或變更應用程式和系統元件上的設定以停用它們。 您可以使用 [**自訂通知] 圖示**來檢查伺服器上可用的通知清單。

### <a name="remote-desktop-protocol-data-compression"></a>遠端桌面通訊協定資料壓縮

遠端桌面通訊協定壓縮可以使用 **電腦**設定 &gt;**系統管理範本**&gt; **Windows 元件** 下的 群組原則 **Remote Desktop Session Host** ， **&gt; 遠端桌面服務 &gt;** 遠端桌面工作階段主機**遠端會話環境**&gt;**設定 RemoteFX 資料的壓縮**。&gt; 可能的值有三個：

-   已**優化以使用較少的記憶體**會耗用每個會話最少的記憶體數量，但具有最低的壓縮比率，因而達到最高的頻寬耗用量。

-   **平衡記憶體和網路頻寬**減少頻寬耗用量，同時增加記憶體耗用量（大約每個會話 200 KB）。

-   **優化以使用較少的網路頻寬**以大約每個會話 2 MB 的成本，進一步降低網路頻寬使用量。 如果您想要使用此設定，您應該在將伺服器放置於生產環境之前，使用這項設定來評估會話的最大數目並測試到該層級。

您也可以選擇不要使用遠端桌面通訊協定的壓縮演算法，因此我們只建議使用它搭配設計來優化網路流量的硬體裝置。 即使您選擇不使用壓縮演算法，還是會壓縮某些圖形資料。

### <a name="device-redirection"></a>裝置重新導向

您可以使用 **電腦**設定 &gt;**系統管理範本**&gt; **Windows 元件** 下的 群組原則 來設定裝置重新**導向 &gt; 遠端桌面服務** **&gt; 遠端桌面工作階段主機** **裝置和資源**重新導向，或使用 &gt; 中的 **會話集合**屬性 方塊。

一般而言，裝置重新導向會增加 RD 工作階段主機伺服器連線所使用的網路頻寬量，因為用戶端電腦上的裝置與伺服器會話中執行的進程之間的資料交換。 增加的程度是在伺服器上對重新導向的裝置執行之應用程式所執行的作業頻率的功能。

印表機重新導向和隨插即用裝置重新導向也會在登入時增加 CPU 使用量。 您可以透過兩種方式重新導向印表機：

-   當印表機的驅動程式必須安裝在伺服器上時，比對以印表機驅動程式為基礎的重新導向。 舊版的 Windows Server 使用此方法。

-   在 Windows Server 2008 中引進，輕鬆列印印表機驅動程式重新導向會針對所有印表機使用通用印表機驅動程式。

我們建議使用 Easy Print 方法，因為它會在連接時造成印表機安裝的 CPU 使用量較少。 符合的驅動程式方法會造成 CPU 使用量增加，因為它需要多工緩衝處理器服務來載入不同的驅動程式。 針對頻寬使用量，輕鬆列印會導致網路頻寬使用量稍微增加，但不夠明顯，無法彌補其他效能、管理性和可靠性的優勢。

音訊重新導向會導致穩定的網路流量串流。 音訊重新導向也可讓使用者執行通常具有高 CPU 耗用量的多媒體應用程式。

### <a name="client-experience-settings"></a>用戶端體驗設定

依預設，遠端桌面連線（RDC）會根據伺服器和用戶端電腦之間網路連線的適用性，自動選擇正確的體驗設定。 我們建議您將 RDC 設定保持在**自動偵測連接品質**。

針對先進的使用者，RDC 提供了一系列設定的控制權，會影響遠端桌面服務連線的網路頻寬效能。 您可以使用遠端桌面連線中的 [**體驗**] 索引標籤或 RDP 檔案中的設定來存取下列設定。

連接到任何電腦時，適用下列設定：

-   **停用壁紙**（停用背景圖樣： i：0）不會在重新導向的連接上顯示桌面背景圖樣。 如果桌面壁紙是由影像或其他具有大量繪圖成本的內容所組成，則此設定可以大幅降低頻寬使用量。

-   **點陣圖**快取（Bitmapcachepersistenable： i：1）啟用此設定時，會建立在會話中轉譯之點陣圖的用戶端快取。 它可大幅改善頻寬使用量，而且應該一律啟用（除非有其他安全性考慮）。

-   **拖曳時顯示 windows 的內容**（停用完整視窗拖曳： i：1）停用此設定時，它只會顯示視窗框架，而不是所有內容，而是在拖曳視窗時，減少頻寬。

-   **功能表和視窗動畫**（停用功能表 anims： i：1和停用游標設定： i：1）：停用這些設定時，會停用功能表上的動畫（例如淡化）和游標，藉此減少頻寬。

-   **字型平滑**效果（允許字型平滑處理： i：0）控制 ClearType 字型轉譯支援。 連接到執行 Windows 8 或 Windows Server 2012 和更新版本的電腦時，啟用或停用此設定並不會對頻寬使用量造成重大影響。 不過，對於執行 Windows 7 和 Windows 2008 R2 之前版本的電腦，啟用這種設定會大幅影響網路頻寬耗用量。

下列設定只適用于連接到執行 Windows 7 和舊版作業系統版本的電腦時：

-   **桌面撰寫**只有對執行 Windows 7 或 Windows Server 2008 R2 之電腦的遠端會話，才支援此設定。

-   **視覺化樣式**（停用主題： i：1）停用此設定時，會簡化使用傳統主題的主題繪圖，以降低頻寬。

藉由使用遠端桌面連線內的 [**體驗**] 索引標籤，您可以選擇連線速度來影響網路頻寬效能。 下列列出可用來設定連線速度的選項：

-   **自動**偵測連線品質（連線類型： i：7）啟用此設定時，遠端桌面連線會自動選擇根據連線品質而產生最佳使用者體驗的設定。 （連接到執行 Windows 8 或 Windows Server 2012 和更新版本的電腦時，建議使用此設定）。

-   **數據機（56 Kbps）** （連線類型： i：1）此設定會啟用持續性點陣圖快取。

-   **低速寬頻（256 Kbps-2 Mbps）** （連線類型： i：2）此設定會啟用持續性點陣圖快取和視覺化樣式。

-   **行動電話/衛星（具有高延遲的 2Mbps-16 Mbps）** （連線類型： i：3）此設定可啟用桌面撰寫、持續性點陣圖快取、視覺化樣式和桌面背景。

-   **高速寬頻（2 mbps – 10 mbps）** （連線類型： i：4）此設定可啟用桌面撰寫、在拖曳時顯示視窗內容、功能表和視窗動畫、持續性點陣圖快取、視覺化樣式和桌面背景。

-   **WAN （10 Mbps 或更高的高延遲）** （連線類型： i：5）此設定可啟用桌面撰寫、在拖曳時顯示視窗內容、功能表和視窗動畫、持續性點陣圖快取、視覺化樣式和桌面背景。

-   **LAN （10 Mbps 或更高版本）** （連線類型： i：6）此設定可啟用桌面撰寫、在拖曳時顯示視窗內容、功能表和視窗動畫、持續性點陣圖快取、主題和桌面背景。

### <a name="desktop-size"></a>桌面大小

您可以使用遠端桌面連線中的 [顯示] 索引標籤，或使用 RDP 設定檔（desktopwidth： i：1152和 desktopheight： i：864）來控制遠端會話的桌面大小。 桌面大小愈大，與該會話相關聯的記憶體和頻寬耗用量就愈大。 目前的桌面大小上限為 4096 x 2048。
