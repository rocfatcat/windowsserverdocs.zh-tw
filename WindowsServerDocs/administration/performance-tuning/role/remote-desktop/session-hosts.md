---
title: 效能微調遠端桌面工作階段主機
description: 效能微調指導方針 遠端桌面工作階段主機
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: e45d1abb545ad46e654c811a0347c589bd12adf0
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59863239"
---
# <a name="performance-tuning-remote-desktop-session-hosts"></a>效能微調遠端桌面工作階段主機


本主題討論如何選取遠端桌面工作階段主機 （RD 工作階段主機） 的硬體、 微調主應用程式，以及調整應用程式。

**本主題內容：**

-   [選取適當的硬體效能](#hw)

-   [調整應用程式以遠端桌面工作階段主機](#apps)

-   [調整參數的遠端桌面工作階段主機](#host)

## <a href="" id="hw"></a>選取適當的硬體效能


如需 RD 工作階段主機伺服器部署中，硬體選擇受到設定的應用程式和使用者如何使用它們。 會影響使用者和使用者體驗的數字的關鍵因素是 CPU、 記憶體、 磁碟和圖形。 本節包含專屬於 RD 工作階段主機伺服器的其他指導方針，以及大部分與相關 RD 工作階段主機伺服器的多使用者環境。

### <a name="cpu-configuration"></a>CPU 組態

CPU 組態在概念上判斷乘以所需的 CPU 支援由系統所要搜尋的支援，同時維持緩衝區域來處理暫時性尖峰的工作階段數目的工作階段。 多個邏輯處理器可協助降低異常的 CPU 擁塞情況，但這通常會因幾個活躍的執行緒所包含的邏輯處理器的數目相似。

因此，多個邏輯處理器的系統上，必須以 CPU 使用量預估值，這會產生較大的百分比，作用中的負載，每一 CPU 的內建的低坐墊邊界。 要記住的加倍的 Cpu 數目的一個重要因素會不兩倍的 CPU 容量。

### <a name="memory-configuration"></a>記憶體組態

記憶體組態是取決於使用者採用; 的應用程式不過，可以估計所需的記憶體數量，使用下列公式：TotalMem = OSMem + SessionMem \* NS

OSMem 是多少記憶體作業系統 （例如系統二進位影像資料結構，等等），執行 SessionMem 需要多少記憶體在一個工作階段中執行的處理程序需要，而 NS 作用中工作階段的目標數目。 工作階段所需的記憶體數量主要取決於為應用程式和工作階段內執行的系統處理序的私用記憶體參考。 共用的程式碼或資料頁面會有太大的影響，因為只有一個複本存在於系統上。

有一個有趣的觀察值 （假設備份分頁檔的磁碟系統不會變更） 是大量的並行作用中工作階段支援，愈大，每個工作階段的記憶體配置必須是計劃的系統。 如果配置每個工作階段的記憶體數量沒有增加，分頁錯誤數目的作用中工作階段產生的工作階段數目的增加。 最後，這些錯誤會使 I/O 子系統不勝負荷。 藉由增加配置每個工作階段的記憶體數量，會造成分頁錯誤的機率會降低，這有助於減少分頁錯誤的整體速率。

### <a name="disk-configuration"></a>磁碟設定

當您設定 RD 工作階段主機伺服器，並可以部署在欄位中的系統是最常見的限制時，儲存體是一個最常被忽略的層面。

典型的 RD 工作階段主機伺服器產生的磁碟活動會影響下列區域：

-   系統檔案和應用程式二進位檔

-   分頁檔

-   使用者設定檔和使用者資料

在理想情況下，這些區域應該備份不同的儲存體裝置。 使用等量的 RAID 組態或其他類型的高效能儲存體進一步改善效能。 我們強烈建議您在使用電池供電的寫入快取使用儲存體配接器。 磁碟寫入快取的控制站提供改善對同步寫入作業的支援。 因為所有使用者都有個別的 hive，同步寫入作業會明顯較常見，RD 工作階段主機伺服器上。 登錄區會定期儲存到磁碟，使用同步寫入作業。 若要啟用這些最佳化，從磁碟管理 主控台中，開啟**屬性**對話方塊中，目的地磁碟，然後在**原則**索引標籤上，選取**啟用寫入快取磁碟**並**關閉 Windows 寫入快取緩衝區排清**裝置核取方塊。

### <a name="network-configuration"></a>網路設定

RD 工作階段主機伺服器的網路使用量會包含兩個主要類別：

-   RD 工作階段主機連線的流量使用量取決於變數結構幾乎全都會執行內部工作階段和重新導向的裝置的 I/O 流量的應用程式，所展現的繪製模式。

    比方說，處理文字處理和輸入資料的應用程式會取用頻寬大約 10 到 100 kb / 秒，而豐富的圖形與視訊播放會大幅增加造成頻寬使用量。

-   例如漫遊設定檔，應用程式存取檔案共用、 資料庫伺服器、 電子郵件伺服器和 HTTP 伺服器的後端連線。

    磁碟區和網路流量設定檔是每個部署的特定項目。

## <a href="" id="apps"></a>調整應用程式以遠端桌面工作階段主機


大部分的 RD 工作階段主機伺服器上的 CPU 使用量會隨應用程式。 傳統型應用程式通常會向其目標是減少花費的時間可以回應使用者要求的應用程式的回應性最佳化。 不過在伺服器環境中，它是同樣重要的以完成某個動作，以避免造成負面影響其他工作階段所需的 CPU 使用量的總數量降到最低。

當您設定要用來在 RD 工作階段主機伺服器上的應用程式時，請考慮下列建議：

-   最小化背景閒置迴圈處理

    典型的範例會停用背景的文法與拼字檢查、 搜尋與編製索引的資料，並儲存背景。

-   最小化應用程式執行狀態檢查或更新的頻率。

    停用這類行為，或增加的間隔輪詢反覆項目和計時器引發大幅權益 CPU 使用量，因為這類活動的效果快速擴大許多使用中工作階段。 常見的連線狀態圖示和狀態列資訊更新。

-   藉由減少其同步處理頻率的應用程式之間的資源爭用降至最低。

    這類資源的範例包括登錄機碼和組態檔。 應用程式元件和功能的範例包括狀態指示器 （例如 shell 通知）、 背景編製索引或變更監視，以及離線同步處理。

-   停用不需要向使用者登入或工作階段啟動開始的程序。

    這些程序可以大幅參與的 CPU 使用量成本時建立新的使用者工作階段，這通常是需要大量 CPU 的處理程序，和它可以在早上案例中非常耗費資源。 使用 MsConfig.exe 或 MsInfo32.exe 來取得一份在使用者登入時啟動的處理序。 如需詳細資訊，您可以使用[Autoruns for Windows](https://technet.microsoft.com/sysinternals/bb963902.aspx)。

記憶體耗用量，您應該考慮下列各項：

-   請確認應用程式所載入的 Dll 不會重新定位。

    -   中所示下圖中，使用，可以選取處理程序 DLL 檢視中，驗證重新定位的 Dll [Process Explorer](https://technet.microsoft.com/sysinternals/bb896653.aspx)。

    -   我們可以看到該 y.dll 已重新定位，因為 x.dll 已被佔用它的預設基底位址，而且未啟用 ASLR

        ![重新定位的 dll](../../media/perftune-guide-relocated-dlls.png)

        如果 Dll 已重新定位，就無法共用其程式碼，跨工作階段，因而大幅增加工作階段的使用量。 這是其中一個最常見的記憶體相關效能問題，RD 工作階段主機伺服器上。

-   Common language runtime (CLR) 應用程式，使用原生映像產生器 (Ngen.exe) 增加頁面共用，並降低 CPU 額外負荷。

    如果可能的話，適用於其他類似的執行引擎類似的技巧。

## <a href="" id="host"></a>調整參數的遠端桌面工作階段主機


### <a name="page-file"></a>分頁檔

沒有足夠的分頁檔大小會造成記憶體配置失敗的應用程式或系統元件。 您可以使用的記憶體認可位元組 」 效能計數器，監視系統上認可的虛擬記憶體數量。

### <a name="antivirus"></a>防毒

RD 工作階段主機伺服器上安裝防毒軟體時，也將大幅影響整體系統效能，尤其是 CPU 使用量。 我們強烈建議您從清單中排除作用中監視所有保留暫存檔的資料夾，特別是那些服務和其他系統元件產生。

### <a name="task-scheduler"></a>工作排程器

工作排程器可讓您檢查不同的事件已排定的工作清單。 RD 工作階段主機伺服器，它是可將特別著重在已執行閒置，在使用者登入時，或在工作階段連線，並中斷連線的工作項目。 由於部署的細節，許多這些工作可能就不需要程式碼。

### <a name="desktop-notification-icons"></a>桌面的通知圖示

在桌面上的通知圖示可以有相當耗費資源的重新整理機制。 藉由移除從啟動清單中註冊這些元件，或藉由變更應用程式和停用它們的系統元件上的組態，您應該停用任何通知。 您可以使用**來自訂通知圖示**來檢查伺服器可用的通知清單。

### <a name="remotefx-data-compression"></a>RemoteFX 資料壓縮

可以使用下方的群組原則設定 Microsoft RemoteFX 壓縮**電腦組態&gt;系統管理範本&gt;Windows 元件&gt;Remote Desktop Services&gt;遠端桌面工作階段主機&gt;遠端工作階段環境&gt;設定 RemoteFX 資料壓縮**。 值有三種可能：

-   **若要使用較少的記憶體最佳化**所耗費的最少的每個工作階段的記憶體，但是具有最低的壓縮率，因此最高的頻寬耗用量。

-   **平衡記憶體和網路頻寬**降低頻寬耗用，同時稍微增加記憶體耗用量 (大約 200 KB 每個工作階段)。

-   **若要使用較少的網路頻寬最佳化**進一步減少網路頻寬使用成本大約 2 mb，每個工作階段。 如果您想要使用此設定，您應該評估工作階段數目上限，並測試，以該層級，這項設定之前，您將伺服器放在生產環境中。

您也可以選擇不使用 RemoteFX 的壓縮演算法。 選擇不使用 RemoteFX 的壓縮演算法會使用更多的網路頻寬，並建議僅如果您使用的硬體裝置所設計，將網路流量最佳化。 即使您選擇不使用 RemoteFX 的壓縮演算法，將會壓縮某些圖形資料。

### <a name="device-redirection"></a>裝置重新導向

使用群組原則 下也可以設定裝置重新導向**電腦組態&gt;系統管理範本&gt;Windows 元件&gt;Remote Desktop Services&gt;遠端桌面工作階段主機&gt;裝置及資源重新導向**或使用**工作階段集合**屬性方塊在 伺服器管理員 中。

一般而言，裝置重新導向會增加多少網路頻寬 RD 工作階段主機伺服器連線使用，因為用戶端電腦上的裝置和伺服器工作階段中執行的處理序之間交換資料。 增加的範圍是伺服器對重新導向的裝置執行的應用程式所執行的作業頻率的函數。

印表機重新導向 」 和 「 隨插即用裝置重新導向也會增加 CPU 使用量，在登入。 您可以重新導向印表機有兩種：

-   在伺服器上必須安裝相符的印表機驅動程式型重新導向時印表機的驅動程式。 較舊版本的 Windows Server 會使用這個方法。

-   Windows Server 2008 中引進，輕鬆列印印表機驅動程式重新導向會使用常見的印表機驅動程式的所有印表機。

因為這會導致較少的 CPU 使用量的印表機安裝在連接時，我們會建議 Easy Print 方法。 符合的驅動程式方法會造成 CPU 使用量增加，因為它需要多工緩衝處理器服務載入不同的驅動程式。 對於頻寬使用量，輕鬆列印會造成稍微增加的網路頻寬用量，但不是明顯到足以位移其他效能、 管理性和可靠性優勢。

音訊重新導向會使網路流量的穩定資料流。 音訊重新導向也可讓使用者執行，通常具有高 CPU 耗用量的多媒體應用程式。

### <a name="client-experience-settings"></a>用戶端經驗設定

根據預設，遠端桌面連線 (RDC) 會自動選擇右邊經驗適合在伺服器和用戶端電腦之間的網路連線為基礎的設定。 我們建議您在維持 RDC 組態**自動偵測連線品質**。

對於進階使用者，RDC 會提供一系列的設定會影響遠端桌面服務連線的網路頻寬效能的控制權。 您可以使用來存取 cadena siguiente**經驗**在遠端桌面連線，或為 RDP 檔案中的 [設定] 索引標籤。

連線到任何電腦時，就會套用下列設定：

-   **Disable wallpaper=i:<0** (停用桌面底色圖案： i:0#.w|contoso) 不會顯示在重新導向的連接上的桌面底色圖案。 如果桌面底色圖案包含影像或繪圖的重大成本的其他內容，這項設定可以大幅降低頻寬使用量。

-   **點陣圖快取**(Bitmapcachepersistenable:i:1) 啟用此設定時，它會建立用戶端快取的工作階段中呈現的點陣圖。 它提供顯著的改進頻寬使用量，並應一律啟用 （除非有其他安全性考量）。

-   **拖曳時顯示視窗的內容**（停用完整視窗拖曳： i:1） 停用此設定時，它會減少頻寬藉由拖曳視窗時，顯示只而不是所有內容的視窗框架。

-   **功能表及視窗動畫**（停用功能表 anims:i:1 和停用資料指標設定： i:1）：這些設定會停用時，它會減少頻寬，藉由停用 （例如淡出） 的功能表和資料指標上的動畫。

-   **字型平滑處理**(允許字型平滑處理： i:0#.w|contoso) 控制項 ClearType 字型轉譯支援。 當您連線到執行 Windows 8 或 Windows Server 2012 的電腦和更新版本，啟用或停用此設定並沒有顯著的影響頻寬使用量。 不過，針對執行早於 Windows 7 和 Windows 2008 R2 版本的電腦，啟用此設定會影響網路頻寬耗用量大幅。

連線到執行 Windows 7 和舊版作業系統的電腦時，只適用於下列設定：

-   **桌面轉譯緩衝處理**這項設定僅支援執行 Windows 7 或 Windows Server 2008 R2 的電腦的遠端工作階段。

-   **視覺化樣式**（停用的佈景主題： i:1） 停用此設定時，它會減少頻寬藉由簡化使用傳統配色 主題的佈景主題繪圖。

藉由使用**經驗** 索引標籤中遠端桌面連線，您可以選擇您的連線速度來影響網路頻寬的效能。 以下列出可用來設定您的連線速度的選項：

-   **自動偵測連線品質**(連線類型： i:7) 啟用此設定時，遠端桌面連線會自動選擇會導致根據連線品質最佳的使用者體驗的設定。 （此組態建議時，連線到執行 Windows 8 或 Windows Server 2012 的電腦和更新版本）。

-   **數據機 (56 Kbps)** (連線類型： i:1) 這項設定可讓持續性的點陣圖快取。

-   **低速度寬頻 (256 Kbps-2 Mbps)** (連線類型： i:2) 這項設定可讓持續性的點陣圖快取和視覺化樣式。

-   **行動數據/附屬 (2Mbps-16 Mbps，具有高延遲)** (連線類型： i:3) 這項設定可讓桌面轉譯緩衝處理、 持續性的點陣圖快取、 視覺化樣式，以及桌面背景。

-   **高速寬頻 (2 Mbps – 10 Mbps)** (連線類型： i:4) 這項設定可讓桌面轉譯緩衝處理、 拖曳、 功能表及視窗動畫、 持續性的點陣圖快取、 視覺化樣式，以及桌面背景時顯示視窗的內容。

-   **WAN (10 Mbps 或更高版本，具有高延遲)** (連線類型： i:5) 這項設定可讓桌面轉譯緩衝處理、 拖曳、 功能表及視窗動畫、 持續性的點陣圖快取、 視覺化樣式，以及桌面背景時顯示視窗的內容。

-   **區域網路 (10 Mbps 或更高版本)** (連線類型： i:6) 這項設定可讓桌面轉譯緩衝處理、 拖曳、 功能表及視窗動畫、 持續性的點陣圖快取、 佈景主題，以及桌面背景時顯示視窗的內容。

### <a name="desktop-size"></a>桌面大小

在 遠端桌面連線中使用 顯示 索引標籤，或使用 RDP 組態檔 （desktopwidth:i:1152 和 desktopheight:i:864），則可以控制桌面的遠端工作階段的大小。 桌面大小愈大，愈大的記憶體和頻寬耗用量與該工作階段相關聯。 目前的最大桌面大小為 4096 x 2048。
