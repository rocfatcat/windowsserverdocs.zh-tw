---
title: 效能微調遠端桌面工作階段主機
description: 遠端桌面工作階段主機的效能微調方針
ms.topic: article
ms.author: hammadbu
author: phstee
ms.date: 10/22/2019
ms.openlocfilehash: 82a89454cfab7cda9de4375c843cde81af5b0544
ms.sourcegitcommit: 7cacfc38982c6006bee4eb756bcda353c4d3dd75
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/14/2020
ms.locfileid: "90078175"
---
# <a name="performance-tuning-remote-desktop-session-hosts"></a>效能微調遠端桌面工作階段主機


本主題討論如何選取遠端桌面工作階段主機 (RD 工作階段主機) 硬體、調整主機，以及調整應用程式。

**本主題內容：**

-   [選取適當的硬體以獲得效能](#selecting-the-proper-hardware-for-performance)

-   [調整遠端桌面工作階段主機的應用程式](#tuning-applications-for-remote-desktop-session-host)

-   [遠端桌面工作階段主機微調參數](#remote-desktop-session-host-tuning-parameters)

## <a name="selecting-the-proper-hardware-for-performance"></a>選取適當的硬體以獲得效能


在 RD 工作階段主機伺服器部署中，硬體的選擇是由應用程式集和使用者使用它們的方式所控管。 影響使用者數量及其體驗的關鍵因素是 CPU、記憶體、磁片和圖形。 本節包含 RD 工作階段主機伺服器專屬的其他指導方針，而且大多與 RD 工作階段主機伺服器的多使用者環境有關。

### <a name="cpu-configuration"></a>CPU 配置

在概念上，CPU 設定的判斷方式是將所需的 CPU 乘以系統預期支援的會話數目，同時維持緩衝區區域以處理暫時的尖峰。 多個邏輯處理器可以協助減少異常的 CPU 擁塞狀況，這通常是由類似邏輯處理器數目的一些 overactive 執行緒所造成。

因此，系統上的邏輯處理器愈多，必須內建到 CPU 使用量估計的放大邊界越低，這會導致每個 CPU 的作用中負載的百分比較大。 要記住的一個重要因素是，Cpu 數目加倍並不是雙 CPU 容量。

### <a name="memory-configuration"></a>記憶體組態

記憶體設定相依于使用者所採用的應用程式;不過，您可以使用下列公式來估計所需的記憶體數量： TotalMem = OSMem + SessionMem \* NS

OSMem 是作業系統需要多少記憶體才能執行 (例如系統二進位影像、資料結構等) 、SessionMem 是在一個會話中執行的記憶體處理常式需要多少，而 NS 則是作用中會話的目標數目。 會話所需的記憶體數量大多取決於在會話中執行之應用程式和系統進程的私用記憶體參考集。 共用的程式碼或資料頁沒有任何作用，因為系統上只會有一個複本。

其中一個有趣的觀察 (假設備份分頁檔案的磁片系統不會變更) 是系統計畫支援的並行使用中會話數目愈大，每個會話的記憶體配置就愈大。 如果未增加每個會話所配置的記憶體數量，使用中會話產生的分頁錯誤數目會隨著會話數目而增加。 這些錯誤最終會耗盡 i/o 子系統。 藉由增加每個會話所配置的記憶體數量，就會減少產生分頁錯誤的機率，進而降低分頁錯誤的整體速率。

### <a name="disk-configuration"></a>磁碟設定

當您設定 RD 工作階段主機伺服器時，存放裝置是最受忽略的層面之一，在部署于現場的系統中，這可能是最常見的限制。

一般 RD 工作階段主機伺服器上產生的磁片活動會影響下欄區域：

-   系統檔案和應用程式二進位檔

-   分頁檔案

-   使用者設定檔和使用者資料

在理想情況下，這些區域應由不同的儲存裝置進行備份。 使用等量 RAID 設定或其他類型的高效能儲存體可進一步改善效能。 強烈建議您使用具有電池支援之寫入快取的儲存體介面卡。 具有磁片寫入快取的控制器可提供對同步寫入作業的增強支援。 因為所有使用者都有個別的 hive，所以 RD 工作階段主機伺服器上的同步寫入作業會更為普遍。 登錄 hive 會使用同步寫入作業定期儲存至磁片。 若要啟用這些優化，請從 [磁片管理] 主控台開啟目的地磁片的 [內容] 對話方塊，然後在 [**原則**] 索引標籤上，選取 [在**磁片上啟用寫入**快取]，並關閉裝置上的 [ **Windows 寫入**快取緩衝區清除] 核取方塊。 **Properties**

### <a name="network-configuration"></a>網路組態

RD 工作階段主機伺服器的網路使用方式包含兩種主要類別：

-   RD 工作階段主機連接流量的使用方式，幾乎是由在會話中執行的應用程式和重新導向的裝置 i/o 流量所呈現的繪圖模式所決定。

    例如，處理文字處理和資料輸入的應用程式每秒耗用大約10到 100 kb 的頻寬，而豐富的圖形和影片播放會造成頻寬使用量大幅增加。

-   後端連線，例如漫遊設定檔、對檔案共用的應用程式存取、資料庫伺服器、電子郵件伺服器，以及 HTTP 伺服器。

    網路流量的磁片區和設定檔是每個部署特有的。

## <a name="tuning-applications-for-remote-desktop-session-host"></a>調整遠端桌面工作階段主機的應用程式


RD 工作階段主機伺服器上的 CPU 使用率大多是由應用程式所驅動。 桌面應用程式的回應能力通常是將應用程式回應使用者要求所需的時間降到最低的目標。 不過，在伺服器環境中，將完成動作所需的總 CPU 使用量降到最低，以避免對其他會話造成負面影響，也同樣重要。

當您設定要在 RD 工作階段主機伺服器上使用的應用程式時，請考慮下列建議：

-   最小化背景閒置迴圈處理

    一般範例包括停用背景文法和拼寫檢查、搜尋的資料編制索引，以及背景儲存。

-   將應用程式執行狀態檢查或更新的頻率降至最低。

    停用這類行為，或增加輪詢反復專案與計時器引發之間的間隔，會大幅獲益于 CPU 使用率，因為這類活動的影響會快速放大許多使用中的會話。 一般範例包括連接狀態圖示和狀態列資訊更新。

-   藉由減少其同步處理頻率，將應用程式之間的資源爭用降至最低。

    這類資源的範例包括登錄機碼和設定檔案。 應用程式元件和功能的範例為狀態指標 (例如 shell 通知) 、背景索引或變更監視，以及離線同步處理。

-   停用註冊的不必要進程，以使用者登入或會話啟動開始。

    這些程式在建立新的使用者會話（通常是需要大量 CPU 的程式）時，可能會大幅降低 CPU 使用量的成本，而且在早上的情況下可能非常耗費資源。 使用 MsConfig.exe 或 MsInfo32.exe 來取得在使用者登入時啟動的進程清單。 如需更詳細的資訊，您可以使用 [Autoruns For Windows](/sysinternals/downloads/autoruns)。

針對記憶體耗用量，您應該考慮下列事項：

-   確認應用程式載入的 Dll 未重新置放。

    -   您可以藉由選取 [進程 DLL 視圖] 來確認重新置放的 Dll，如下圖所示，使用 [Process Explorer](/sysinternals/downloads/process-explorer)。

    -   在此，我們可以看到 y.dll 已重新放置，因為 x.dll 已經佔用其預設基底位址，而 ASLR 未啟用。

        ![重新置放的 dll](../../media/perftune-guide-relocated-dlls.png)

        如果 Dll 已重新放置，則無法在會話之間共用程式碼，這會大幅增加會話的使用量。 這是 RD 工作階段主機伺服器最常見的記憶體相關效能問題之一。

-   針對 common language runtime (CLR) 應用程式，請使用原生映射產生器 ( # A0) 來增加頁面共用並減少 CPU 額外負荷。

    可能的話，請將類似的技巧套用至其他類似的執行引擎。

## <a name="remote-desktop-session-host-tuning-parameters"></a>遠端桌面工作階段主機微調參數


### <a name="page-file"></a>分頁檔案

分頁檔案大小不足可能會導致應用程式或系統元件中的記憶體配置失敗。 您可以使用「記憶體對認可的位元組」效能計數器來監視系統上已認可的虛擬記憶體量。

### <a name="antivirus"></a>防毒

在 RD 工作階段主機伺服器上安裝防毒軟體會大幅影響整體系統效能，特別是 CPU 使用率。 強烈建議您從主動監看清單中排除所有保存暫存檔案的資料夾，特別是服務和其他系統元件所產生的檔案。

### <a name="task-scheduler"></a>工作排程器

工作排程器可讓您檢查針對不同事件排定的工作清單。 針對 RD 工作階段主機伺服器，特別著重于設定為在閒置、使用者登入，或會話連線和中斷連線時執行的工作時，會很有用。 由於部署的細節，其中有許多工作可能不需要。

### <a name="desktop-notification-icons"></a>桌面通知圖示

桌面上的通知圖示可能會有相當昂貴的重新整理機制。 您應停用任何通知，方法是從啟動清單中移除註冊它們的元件，或變更應用程式和系統元件的設定來停用。 您可以使用 [ **自訂通知] 圖示** 來檢查伺服器上的可用通知清單。

### <a name="remote-desktop-protocol-data-compression"></a>遠端桌面通訊協定資料壓縮

您可以使用 [**電腦**設定] 系統管理範本 [Windows 元件] 下的群組原則來設定遠端桌面通訊協定壓縮 &gt; **Administrative Templates** &gt; **Windows Components** &gt; **遠端桌面服務** &gt; **遠端桌面工作階段主機** &gt; **遠端會話環境** &gt; **設定 RemoteFX 資料的壓縮**。 可能的值有三種：

-   **優化以使用較少的記憶體** 耗用每個會話最少的記憶體數量，但壓縮率最低，因此頻寬耗用量最高。

-   **平衡記憶體和網路頻寬** 減少頻寬耗用量，而稍微增加記憶體耗用量 (大約每個會話) 200 KB。

-   **優化以使用較少的網路頻寬** 以大約每個會話大約 2 MB 的成本來進一步減少網路頻寬使用量。 如果您想要使用此設定，您應該在將伺服器放置於生產環境之前，先評估會話的數目上限，並使用此設定測試到該層級。

您也可以選擇不使用遠端桌面通訊協定壓縮演算法，因此我們只建議將它搭配設計用來將網路流量優化的硬體裝置使用。 即使您選擇不要使用壓縮演算法，還是會壓縮部分圖形資料。

### <a name="device-redirection"></a>裝置重新導向

您可以使用 [**電腦**設定] 系統管理範本 [Windows 元件] 下的群組原則來設定裝置重新導向 &gt; **Administrative Templates** &gt; **Windows Components** &gt; **遠端桌面服務** &gt; **遠端桌面工作階段主機** &gt; **裝置和資源**重新導向，或使用伺服器管理員中的 [**會話集合**屬性] 方塊。

裝置重新導向通常會增加 RD 工作階段主機伺服器連接所使用的網路頻寬量，因為資料會在用戶端電腦上的裝置和伺服器會話中執行的處理常式之間交換。 增加的範圍是在伺服器上對重新導向的裝置執行的應用程式所執行的作業頻率函數。

印表機重新導向和隨插即用裝置重新導向也會在登入時增加 CPU 使用量。 您可以透過兩種方式來重新導向印表機：

-   當伺服器的驅動程式必須安裝在伺服器上時，符合印表機驅動程式的重新導向。 舊版的 Windows Server 會使用這個方法。

-   Windows Server 2008 中引進的簡易列印印表機驅動程式重新導向會針對所有印表機使用一般的印表機驅動程式。

我們建議使用簡單的列印方法，因為它會在連接時，讓印表機安裝的 CPU 使用量較少。 相符的驅動程式方法會造成 CPU 使用量增加，因為它需要多工緩衝處理器服務才能載入不同的驅動程式。 針對頻寬使用量，輕鬆列印會導致網路頻寬使用量稍微增加，但不足以彌補其他效能、管理性及可靠性優勢。

音訊重新導向會造成網路流量穩定的串流。 音訊重新導向也可讓使用者執行通常具有高 CPU 耗用量的多媒體應用程式。

### <a name="client-experience-settings"></a>用戶端體驗設定

根據預設，遠端桌面連線 (RDC) 會根據伺服器與用戶端電腦之間的網路連線是否合適，自動選擇正確的體驗設定。 我們建議 RDC 設定保持 **自動偵測連接品質**。

若為 advanced users，RDC 可控制對遠端桌面服務連接的網路頻寬效能的設定範圍。 您可以使用遠端桌面連線中的 [ **體驗** ] 索引標籤或作為 RDP 檔案中的設定，來存取下列設定。

以下是連接到任何電腦時適用的設定：

-   **停用壁紙** (停用壁紙： i： 0) 不會在重新導向的連接上顯示桌面壁紙。 如果桌面壁紙包含影像或其他內容，而且有大量的繪圖成本，此設定可大幅降低頻寬使用量。

-   **點陣圖** 快取 (Bitmapcachepersistenable： i： 1) 啟用這項設定時，它會建立在會話中轉譯的點陣圖用戶端快取。 它可大幅改善頻寬的使用方式，除非) 有其他安全性考慮，否則應該一律啟用 (。

-   拖曳 (停用完整視窗拖曳**時顯示視窗的內容**： i： 1) 停用此設定時，只會顯示視窗框架，而不是在拖曳視窗時顯示所有內容，藉此減少頻寬。

-   **功能表和視窗動畫** (停用功能表 anims： i：1和停用游標設定： i： 1) ：停用這些設定時，會停用功能表上的動畫 (例如淡化) 和游標，藉以減少頻寬。

-   **字型平滑** (允許字型平滑： i： 0) 控制項 ClearType 字型轉譯支援。 連接到執行 Windows 8 或 Windows Server 2012 或更新版本的電腦時，啟用或停用此設定並不會對頻寬使用造成顯著的影響。 但是，如果電腦執行的是 Windows 7 和 Windows 2008 R2 之前的版本，啟用此設定會大幅影響網路頻寬耗用量。

下列設定只適用于連接到執行 Windows 7 和舊版作業系統版本的電腦時：

-   **桌面電腦群組合** 只有對執行 Windows 7 或 Windows Server 2008 R2 之電腦的遠端會話，才支援此設定。

-   **視覺化樣式** (停用主題： i： 1) 停用此設定時，會藉由簡化使用傳統主題的主題繪圖來減少頻寬。

藉由使用遠端桌面連線內的 [ **體驗** ] 索引標籤，您可以選擇連線速度來影響網路頻寬效能。 以下列出可用來設定連線速度的選項：

-   **自動** 偵測連線品質 (連線類型： i： 7) 啟用這項設定時，遠端桌面連線會自動選擇會根據連接品質而產生最佳使用者體驗的設定。  (在連線到執行 Windows 8 或 Windows Server 2012 及更新版本) 的電腦時，建議使用此設定。

-   **數據機 (56 Kbps) ** (連線類型： i： 1) 此設定會啟用持續性點陣圖快取。

-   **低速寬頻 (256 Kbps-2 Mbps) ** (連線類型： i： 2) 此設定可啟用持續性點陣圖快取和視覺化樣式。

-   **行動電話/附屬 (2Mbps-16 Mbps，具有高延遲) ** (連線類型： i： 3) 此設定可啟用桌面電腦群組合、持續性點陣圖快取、視覺效果樣式和桌面背景。

-   **高速寬頻 (2 mbps – 10 mbps ) ** (連線類型： i： 4) 此設定可啟用桌面組合、在拖曳時顯示視窗內容、功能表和視窗動畫、持續性點陣圖快取、視覺效果樣式和桌面背景。

-   **WAN (10 Mbps 或更高的高延遲) ** (連線類型： i： 5) 此設定可啟用桌面組合、在拖曳時顯示視窗內容、功能表和視窗動畫、持續性點陣圖快取、視覺化樣式和桌面背景。

-   **LAN (10 Mbps 或更高版本) ** (連線類型： i： 6) 此設定可啟用桌面組合、在拖曳時顯示視窗內容、功能表和視窗動畫、持續性點陣圖快取、主題和桌面背景。

### <a name="desktop-size"></a>桌面大小

您可以使用遠端桌面連線中的 [顯示] 索引標籤，或使用 RDP 設定檔 (desktopwidth： i：1152和 desktopheight： i： 864) 來控制遠端會話的桌面大小。 桌面大小愈大，與該會話相關聯的記憶體和頻寬耗用量就愈大。 目前的桌面大小上限為 4096 x 2048。