---
title: 效能微調遠端桌面虛擬化主機
description: 遠端桌面虛擬化主機的效能微調
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: da528a742a7f49513c50b22a25970d65b9e1885f
ms.sourcegitcommit: 6ef4986391607bb28593852d06cc6645e548a4b3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/07/2019
ms.locfileid: "66811379"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>效能微調遠端桌面虛擬化主機


遠端桌面虛擬主機 （RD 虛擬主機） 是一種角色服務，支援虛擬桌面基礎結構 (VDI) 案例，並可讓多個並行的使用者執行的伺服器上裝載的虛擬機器執行以 Windows 為基礎的應用程式Windows Server 2016 和 HYPER-V。

Windows Server 2016 支援兩種類型的虛擬桌面、 個人虛擬桌面和集區虛擬桌面。

**本主題內容：**

-   [一般考量](#general-considerations)

-   [效能最佳化](#performance-optimizations)

## <a name="general-considerations"></a>一般考量


### <a name="storage"></a>儲存體

儲存體是最可能的效能瓶頸，並請務必調整您的儲存體，可正確處理虛擬機器的狀態變更所產生的 I/O 負載的大小。 如果試驗或模擬並不可行，理想的指導方針是佈建四個作用中的虛擬機器一個磁碟的磁針。 使用具有良好的寫入效能 （例如 RAID 1 + 0） 的磁碟組態。

請在適當時機使用磁碟重複資料刪除和快取，以減少磁碟讀取負載，並啟用您的儲存體解決方案，以加速效能，藉由快取映像的重要部分。

### <a name="data-deduplication-and-vdi"></a>重複資料刪除和 VDI

Windows Server 2012 R2 中引入，重複資料刪除支援開啟檔案的最佳化。 若要使用重複資料刪除磁碟區上執行的虛擬機器，虛擬機器檔案必須儲存在個別的主控件，從 HYPER-V 主機上。 如果同一部電腦上執行 HYPER-V 和重複資料刪除，其中兩項功能將系統資源爭用，並對整體效能造成負面影響。

磁碟區也必須設定為使用 「 虛擬桌面基礎結構 (VDI) 」 重複資料刪除最佳化類型。 您可以使用伺服器管理員來設定此 (**檔案和存放服務** - &gt; **磁碟區** - &gt; **重複資料刪除設定**)或者，使用下列 Windows PowerShell 命令：

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

> [!NOTE]
> 開啟檔案的資料重複資料刪除最佳化僅支援 VDI 案例與 HYPER-V 透過 SMB 3.0 使用遠端存放裝置。

### <a name="memory"></a>記憶體

伺服器記憶體使用狀況是由三個主要因素所驅動：

-   作業系統的額外負荷

-   每部虛擬機器的額外負荷的 HYPER-V 服務

-   配置給每個虛擬機器的記憶體

對於典型的知識工作者的工作負載，客體虛擬機器正在執行 x86 Windows 8 或 Windows 8.1 也應該有 ~ 512 MB 的記憶體作為基準。 不過，動態記憶體可能會增加到大約 800 MB，根據工作負載的客體虛擬機器的記憶體。 適用於 x64，我們看到有關 800 MB 啟動，增加為 1024 MB。

因此，務必提供伺服器記憶體不足，無法滿足所需的客體虛擬機器，預期數目的記憶體，以及針對伺服器允許足夠的記憶體數量。

### <a name="cpu"></a>CPU

當您計劃的 rd 工作階段主機伺服器的伺服器容量時，每個實體核心的虛擬機器數目將取決於工作負載的本質。 做為起點，是合理的計劃 12 的虛擬機器，每個實體核心，然後再執行 驗證效能和密度的適當案例。 可達成的目標而定的工作負載時，可能更高的密度。

我們建議您啟用超執行緒，但請務必在計算的實體核心數目和不是邏輯處理器的數目為基礎的過度訂閱率。 這可確保預期的層級的每個 cpu 的效能。

### <a name="virtual-gpu"></a>虛擬 GPU

RD 虛擬主機的 Microsoft RemoteFX 提供豐富的圖形體驗，針對虛擬桌面基礎結構 (VDI) 透過主應用程式端的遠端處理、 轉譯擷取編碼管線、 高效率 GPU 為基礎的編碼、 節流根據用戶端活動和 DirectX 功能的虛擬 GPU。 RemoteFX 的 rd 工作階段主機將升級從 DirectX9 DirectX11 虛擬 GPU。 它亦能改善使用者體驗支援多個監視器解析度較高。

RemoteFX DirectX11 體驗，毋需硬體 GPU，透過軟體模擬的驅動程式。 雖然此軟體的 GPU 可提供良好的體驗，RemoteFX 虛擬圖形處理單元 (VGPU) 會將虛擬桌上型電腦的硬體加速的體驗。

若要利用下執行 Windows Server 2016 的伺服器上的 RemoteFX VGPU 體驗，您需要在主機伺服器上 （例如 DirectX11.1 或 WDDM 1.2） 的 GPU 驅動程式。 如需有關 RD 虛擬化主機使用 RemoteFX 的 GPU 優惠的詳細資訊，請連絡您的 GPU 提供者。

如果您使用 RemoteFX 虛擬 GPU VDI 部署中，部署容量會有所不同的使用案例和硬體組態。 當您規劃部署時，請考慮下列各項：

-   您的系統上的數字的 Gpu

-   在 Gpu 上的視訊記憶體容量

-   在您的系統上的處理器和硬體資源

### <a name="remotefx-server-system-memory"></a>RemoteFX 伺服器系統記憶體

針對使用虛擬 GPU 啟用每個虛擬桌面，RemoteFX 會使用系統記憶體，客體作業系統中和已啟用 RemoteFX 的伺服器中。 Hypervisor 會保證為客體作業系統的系統記憶體。 在伺服器上，每個虛擬 GPU 的虛擬桌上型電腦必須通告其對 hypervisor 的系統記憶體需求。 當虛擬 GPU 的虛擬桌面啟動時，hypervisor 會保留用於 VGPU 啟用虛擬桌面已啟用 RemoteFX 的伺服器中的額外系統記憶體。

已啟用 RemoteFX 伺服器的記憶體需求是記憶體的動態的因為已啟用 RemoteFX 伺服器上耗用數量是記憶體的取決於相關聯 VGPU 啟用虛擬桌面和的最大解析度的監視器數目這些監視器。

### <a name="remotefx-server-gpu-video-memory"></a>RemoteFX 伺服器 GPU 的視訊記憶體

每一台虛擬 GPU 的虛擬桌上型電腦使用的主機伺服器上的 GPU 硬體的視訊記憶體，呈現在桌面上。 除了轉譯視訊記憶體可由轉碼器來壓縮呈現的畫面。 所需的記憶體數量直接根據監視佈建到虛擬機器的數量。

監視器數目和系統螢幕解析度的視訊記憶體保留有所不同。 某些使用者可能需要較高的螢幕解析度的特定工作。 如果所有其他設定會保持不變，沒有與較低的解析度設定較大的延展性。

### <a name="remotefx-processor"></a>RemoteFX 處理器

Hypervisor 會排程在已啟用 RemoteFX 的伺服器和虛擬 GPU 的虛擬桌面在 CPU 上。 不同於系統記憶體中，沒有其他 RemoteFX 需要 hypervisor 與共用的資源相關的資訊。 執行虛擬 GPU 驅動程式和使用者模式的遠端桌面通訊協定堆疊與相關的額外 CPU 額外負荷，RemoteFX 帶入虛擬 GPU 的虛擬桌上型電腦。

在已啟用 RemoteFX 伺服器上，額外負荷增加，因為系統會執行額外的處理序 (rdvgm.exe) 每一部虛擬已啟用 GPU 的虛擬桌上型電腦。 此程序使用的圖形裝置驅動程式在 GPU 上執行命令。 轉碼器也會使用 Cpu 壓縮需要傳送回用戶端的螢幕資料。

更多虛擬處理器表示較佳使用者體驗。 我們建議配置至少兩個虛擬 Cpu，每一部虛擬已啟用 GPU 的虛擬桌上型電腦。 我們也建議使用 x64 架構，適用於虛擬已啟用 GPU 的虛擬桌面因為 x64 x86 進一步比較虛擬機器上的效能的虛擬機器。

### <a name="remotefx-gpu-processing-power"></a>RemoteFX 的 GPU 處理能力

對於每個虛擬 GPU 的虛擬桌面，沒有對應的 DirectX 處理序已啟用 RemoteFX 伺服器上執行。 此程序重新執行它接收來自 RemoteFX 虛擬桌面，到實體的 GPU 上的所有圖形命令。 適用於實體的 GPU，它就相當於同時執行多個的 DirectX 應用程式項目。

一般而言，圖形裝置和驅動程式將會進行微調，以在桌面上執行一些應用程式。 RemoteFX 會自動縮放以唯一方式是使用 Gpu。 為了測量 GPU RemoteFX 伺服器上的執行方式，已新增效能計數器來測量回應要求 RemoteFX 的 GPU。

通常當 GPU 資源的資源較少，讀取和寫入 GPU 進行長時間才能完成作業。 藉由使用效能計數器，系統管理員可以採取預防性動作，消除停機的可能性為其使用者。

下列效能計數器會測量虛擬 GPU 效能 RemoteFX 伺服器上可用：

**RemoteFX 圖形**

-   **框架已略過秒-資源不足，無法用戶端**由於資源不足，無法用戶端每秒已略過的框架數目

-   **圖形的壓縮比率**編碼的位元組輸入數目的位元組數目的比率

**RemoteFX 根 GPU 管理**

-   **資源：伺服器 gpu TDRs**總次數，在伺服器上 GPU TDR 逾時

-   **資源：執行 RemoteFX 的虛擬機器**有安裝 RemoteFX 3D 視訊卡的虛擬機器的總數目

-   **VRAM:每個 GPU 的可用 MB**未使用的專用視訊記憶體數量

-   **VRAM:每個 GPU 的保留的 %** remotefx 已保留的專用視訊記憶體的百分比

**RemoteFX 軟體**

-   **針對監視擷取率** \[1-4\]顯示 RemoteFX 擷取速率監視 1-4

-   **壓縮比率**Deprecated in Windows 8 和由取代**圖形壓縮比率**

-   **延遲的框架秒**不在一段時間內傳送圖形資料每秒畫面格數

-   **從擷取的 GPU 回應時間**延遲 RemoteFX 擷取內 （以微秒為單位） 的 GPU 作業完成

-   **GPU 回應時間呈現**測量延遲 RemoteFX 呈現中 （以百萬分之一秒為單位） 的 GPU 作業完成

-   **輸出位元組**總數 RemoteFX 輸出位元組

-   **等候用戶端計數/sec** Deprecated in Windows 8 和由取代**框架已略過秒-資源不足，無法用戶端**

**RemoteFX vGPU 管理**

-   **資源：虛擬機器的本機 TDRs** TDRs 發生在這部虛擬機器 (TDRs 傳播至虛擬機器的伺服器不會包含) 的總數

-   **資源：由伺服器所傳播的 TDRs** TDRs，發生在伺服器上，且中已傳播至虛擬機器的總次數

**RemoteFX vGPU 的虛擬機器效能**

-   **資料：叫用 顯示/sec**存在的作業，以呈現到桌面的虛擬機器，每秒的總數 （以秒為單位）

-   **資料：顯示每秒的傳出**存在虛擬機器所傳送至 GPU 伺服器每秒的作業總數

-   **資料：讀取位元組/秒**已啟用 RemoteFX 的每秒從伺服器讀取的位元組總數

-   **資料：傳送的位元組數/秒**已啟用 RemoteFX 的 GPU 每秒伺服器所傳送的位元組總數

-   **DMA:通訊緩衝區的平均延遲 （秒）** 平均花的時間 （以秒為單位） 中的通訊緩衝區

-   **DMA:DMA 緩衝區延遲 （秒）** 時間 （以秒為單位） 時完成之前會送出 DMA

-   **DMA:佇列長度**RemoteFX 3D 視訊卡的 DMA 佇列長度

-   **資源：TDR 逾時，每個 GPU**發生每個 GPU 的虛擬機器的計數的 TDR 逾時

-   **資源：TDR 逾時，每個 GPU 引擎**虛擬機器上的計數的 TDR 逾時所發生每個 GPU 引擎

除了 RemoteFX 虛擬 GPU 效能計數器，您也可以使用處理序總管 中，它會顯示視訊記憶體使用量和 GPU 使用率測量 GPU 使用率。

## <a name="performance-optimizations"></a>效能最佳化

### <a name="dynamic-memory"></a>動態記憶體

動態記憶體 」 可讓更有效率地透過平衡執行中的虛擬機器間如何分散的記憶體執行 HYPER-V 之伺服器的記憶體資源的使用率。 可在以回應其變更的工作負載的虛擬機器間以動態方式重新配置記憶體。

動態記憶體可讓您增加虛擬機器的資源，您已經有而不會犧牲效能或延展性的密度。 結果會是更有效率地使用昂貴的伺服器硬體資源，可以轉譯成方便您管理和降低成本。

來賓作業系統上執行 Windows 8 和以上具有跨越多個邏輯處理器的虛擬處理器，請考慮之間以動態的記憶體，來協助降低記憶體使用率執行，而停用動態記憶體，以便改善效能的權衡取捨是電腦拓撲感知的應用程式。 這類應用程式可以利用進行排程和記憶體配置決策的拓撲資訊。

### <a name="tiered-storage"></a>階層式存放區

RD 虛擬主機支援虛擬桌面集區的分層式儲存體。 由集合內的所有集區虛擬桌面共用的實體電腦可以使用小型、 高效能儲存體解決方案，例如鏡像的固態硬碟 (SSD)。 集區虛擬桌面可以放在成本較低的傳統儲存體，例如 RAID 1 + 0。

實體電腦應置於 SSD 是因為大部分的讀取-我/Os 從集區虛擬桌面，請移至 管理作業系統。 因此，實體電腦會使用儲存體必須維持絕佳的高每秒讀取的 I/o。

此部署組態可確保符合成本效益的效能，需要效能的位置。 SSD 提供較小的大小磁碟 (每個集合，根據設定為 ~ 20 GB) 更高的效能。 集區虛擬桌面的傳統存放裝置 (RAID 1 + 0) 會使用每個虛擬機器約 3 GB。

### <a name="csv-cache"></a>CSV 快取

容錯移轉叢集，在 Windows Server 2012 及更新版本提供快取叢集共用磁碟區 (CSV) 上。 這是非常有幫助的集區虛擬桌面集合其中大部分的讀取 I/o 來自管理作業系統。 CSV 快取的差距所提供更高的效能，因為它會快取讀取一次以上的區塊，並將其從系統記憶體，以減少 I/O。 如需 CSV 快取的詳細資訊，請參閱[如何啟用 CSV 快取](http://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx)。

### <a name="pooled-virtual-desktops"></a>集區虛擬桌面

根據預設，集區虛擬桌面會在使用者登出時，對 Windows 作業系統，因為最後一個使用者登入時會放棄因此任何變更之後回復原始狀態。

雖然可以停用復原功能，但它仍是暫時的狀況因為通常是由於各種更新虛擬桌面範本重建集區虛擬桌面集合。

合理關閉 Windows 功能和服務的持續性的狀態而定。 此外，它可以合理地關閉主要適用於非企業情節的服務。

每個特定的服務應在任何廣泛部署之前適當地評估。 以下是一些初始考量的事項：

| 服務                                      | 為什麼？                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 自動更新                                  | 重新建立虛擬桌面範本時，會更新集區虛擬桌面。                                                                                                                          |
| 離線檔案                                | 虛擬桌面一律在線上且已連線的網路服務檢視。                                                                                                                         |
| 背景重組                            | 檔案系統變更都會被捨棄之後使用者登入 （因為回復至原始狀態，或重新建立虛擬桌面範本，會導致重新建立所有集區虛擬桌面）。 |
| 休眠或睡眠                           | 針對 VDI 沒有這類概念                                                                                                                                                                                   |
| 錯誤檢查記憶體傾印                        | 沒有這類概念的集區虛擬桌面。 錯誤檢查集區虛擬桌面會開始從初始化狀態。                                                                                       |
| WLAN 自動設定                              | 針對 VDI 沒有 WiFi 裝置介面                                                                                                                                                                 |
| Windows Media Player 網路共用服務 | 取用者中心服務                                                                                                                                                                                  |
| 家用群組提供者                          | 取用者中心服務                                                                                                                                                                                  |
| 網際網路連線共用                  | 取用者中心服務                                                                                                                                                                                  |
| Media Center 擴充服務               | 取用者中心服務                                                                                                                                                                                  |
> [!NOTE]
> 這份清單不是用來完整的清單，因為任何變更都會影響預期的目標和案例。 如需詳細資訊，請參閱 <<c0> [ 經常性關閉按下動作立即取得，Windows 8 VDI 最佳化指令碼，延長的 PFE ！](http://blogs.technet.com/b/jeff_stokes/archive/2013/04/09/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe.aspx)。

 
> [!NOTE]
> 預設會啟用 Windows 8 中的 superFetch。 它是 VDI 感知，而且不應該停用。 SuperFetch 可以進一步降低記憶體耗用量透過頁面的共用記憶體，也就是有幫助的 VDI。 執行 Windows 7 的集區虛擬桌面，SuperFetch 應該停用，但適用於執行 Windows 7 的個人虛擬桌面，則應保留在。

 
