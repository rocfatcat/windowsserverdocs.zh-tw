---
title: 效能微調遠端桌面虛擬主機
description: 遠端桌面虛擬主機的效能微調
ms.topic: article
ms.author: hammadbu; vladmis; denisgun
author: phstee
ms.date: 10/22/2019
ms.openlocfilehash: 235dd0209030854f1fc883f52ab41550ab693dc5
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/07/2020
ms.locfileid: "87992078"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>效能微調遠端桌面虛擬主機

遠端桌面虛擬主機 (RD 虛擬主機) 是一項角色服務，可支援虛擬桌面基礎結構 (VDI) 案例，並可讓多個使用者在執行 Windows Server 和 Hyper-v 的伺服器上裝載的虛擬機器中執行 Windows 應用程式。

Windows Server 支援兩種類型的虛擬桌面：個人虛擬桌面和集區虛擬桌面。

## <a name="general-considerations"></a>一般考量

### <a name="storage"></a>儲存體

儲存體是最可能的效能瓶頸，因此請務必調整您的儲存體大小，以適當處理虛擬機器狀態變更所產生的 i/o 負載。 如果試驗或模擬不可行，最好的指導方針是為四部作用中的虛擬機器布建一個磁片主軸。 使用具有良好寫入效能 (的磁片設定，例如 RAID 1 + 0) 。

適當時，請使用磁片重復資料刪除和快取來減少磁片讀取負載，並讓您的儲存解決方案藉由 caching 影像的重要部分來加速效能。

### <a name="data-deduplication-and-vdi"></a>重復資料刪除和 VDI

在 Windows Server 2012 R2 中引進，重復資料刪除支援開啟檔案的優化。 若要使用在重復資料刪除磁片區上執行的虛擬機器，虛擬機器檔案必須儲存在與 Hyper-v 主機不同的主機上。 如果 Hyper-v 和重復資料刪除在同一部電腦上執行，這兩個功能將會爭用系統資源，並對整體效能造成負面影響。

磁片區也必須設定為使用「虛擬桌面基礎結構 (VDI) 「重復資料刪除」優化類型。 您可以使用伺服器管理員 (檔案**和存放服務**  - &gt; **磁片**區  - &gt; **重復資料刪除設定**) 或使用下列 Windows PowerShell 命令來進行設定：

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

> [!NOTE]
> 已開啟檔案的重復資料刪除優化僅支援使用透過 SMB 3.0 的遠端存放 Hyper-v 的 VDI 案例。

### <a name="memory"></a>Memory

伺服器記憶體使用量是由三個主要因素所驅動：

- 作業系統額外負荷

- 每個虛擬機器的 hyper-v 服務額外負荷

- 配置給每部虛擬機器的記憶體

針對一般的知識工作者工作負載，執行 x86 Window 8 或 Windows 8.1 的來賓虛擬機器應該提供 ~ 512 MB 的記憶體做為基準。 不過，視工作負載而定，動態記憶體可能會將來賓虛擬機器的記憶體增加到大約 800 MB。 在 x64 中，我們會看到大約 800 MB 的啟動，並增加到 1024 MB。

因此，請務必提供足夠的伺服器記憶體，以滿足預期的來賓虛擬機器數目所需的記憶體，並允許伺服器擁有足夠的記憶體數量。

### <a name="cpu"></a>CPU

當您規劃 RD 虛擬主機伺服器的伺服器容量時，每個實體核心的虛擬機器數目將取決於工作負載的本質。 作為起點，可合理規劃每個實體核心12部虛擬機器，然後執行適當的案例來驗證效能和密度。 根據工作負載的細節而定，可能會達到較高的密度。

我們建議您啟用超執行緒，但請務必根據實體核心數目，而不是邏輯處理器數目來計算超額訂閱比例。 這可確保每個 CPU 的預期效能層級。

## <a name="performance-optimizations"></a>效能最佳化

### <a name="dynamic-memory"></a>動態記憶體

動態記憶體藉由平衡在執行中的虛擬機器之間分散記憶體的方式，更有效率地利用執行 Hyper-v 之伺服器的記憶體資源。 記憶體可以在虛擬機器之間動態重新配置，以回應其變更的工作負載。

動態記憶體可讓您使用已有的資源增加虛擬機器密度，而不會犧牲效能或擴充性。 結果是更有效率地使用昂貴的伺服器硬體資源，這可以讓管理工作變得更容易，而且成本更低。

在執行 Windows 8 和更新版本的客體作業系統上，搭配跨越多個邏輯處理器的虛擬處理器，請考慮使用動態記憶體執行之間的取捨，以協助將記憶體使用量降到最低，並停用動態記憶體以改善電腦拓朴感知之應用程式的效能。 這類應用程式可以利用拓撲資訊來進行排程和記憶體配置決策。

### <a name="tiered-storage"></a>階層式存放區

RD 虛擬化主機支援虛擬桌面集區的分層式儲存體。 集合內所有集區式虛擬桌面共用的實體電腦，都可以使用小型、高效能的儲存體解決方案，例如鏡像的固態硬碟 (SSD) 。 集區虛擬桌面可以放在成本較低的傳統儲存體上，例如 RAID 1 + 0。

實體電腦應該放在 SSD 上，因為集區虛擬桌面的大部分讀取 i/o 都會移至管理作業系統。 因此，實體電腦使用的存放裝置必須承受每秒更高的讀取 i/o。

此部署設定可確保符合成本效益的效能，而且需要效能。 根據設定) ，SSD 在較小的磁片上提供較高的效能 (~ 每個集合 20 GB。 適用于集區虛擬桌面 (RAID 1 + 0) 的傳統儲存體會使用約每個虛擬機器 3 GB。

### <a name="csv-cache"></a>CSV 快取

Windows Server 2012 和更新版本中的容錯移轉叢集提供叢集共用磁片區上的快取 (CSV) 。 對於大多數讀取 i/o 來自管理作業系統的集區虛擬桌面集合而言，這非常有用。 CSV 快取會以數種程度來提供較高的效能，因為它會快取讀取超過一次的區塊，並從系統記憶體傳遞它們，進而減少 i/o。 如需 CSV 快取的詳細資訊，請參閱[如何啟用 csv](https://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx)快取。

### <a name="pooled-virtual-desktops"></a>集區虛擬桌面

根據預設，系統會在使用者登出之後，將集區虛擬桌面回復為初始化狀態，因此會放棄上次使用者登入後對 Windows 作業系統所做的任何變更。

雖然可以停用復原，但它仍然是暫時性的狀況，因為虛擬桌面範本的各種更新通常會重新建立集區虛擬桌面集合。

關閉相依于持續性狀態的 Windows 功能和服務是合理的。 此外，關閉主要用於非企業案例的服務是合理的。

在進行廣泛部署之前，應該先適當地評估每個特定服務。 以下是一些要考慮的初始事項：

| 服務                                      | 原因為何？                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 自動更新                                  | 重新建立虛擬桌面範本，即可更新集區虛擬桌面。                                                                                                                          |
| 離線檔案                                | 虛擬桌面一律會上線，並從網路觀點來連接。                                                                                                                         |
| 背景磁碟重組                            | 檔案系統變更會在使用者登出 (之後捨棄，因為復原到初始化狀態或重新建立虛擬桌面範本，這會導致重新建立所有的集區虛擬桌面) 。 |
| 休眠或睡眠                           | 不適用 VDI 的概念                                                                                                                                                                                   |
| Bug 檢查記憶體傾印                        | 集區虛擬桌面沒有這種概念。 錯誤檢查集區虛擬桌面將從初始化狀態開始。                                                                                       |
| WLAN 自動設定                              | VDI 沒有 WiFi 裝置介面                                                                                                                                                                 |
| Windows 媒體播放機網路共用服務 | 以取用者為中心的服務                                                                                                                                                                                  |
| 家庭群組提供者                          | 以取用者為中心的服務                                                                                                                                                                                  |
| 網際網路連線共用                  | 以取用者為中心的服務                                                                                                                                                                                  |
| Media Center 擴充服務               | 以取用者為中心的服務                                                                                                                                                                                  |
> [!NOTE]
> 這份清單不是完整清單，因為任何變更都會影響到所需的目標和案例。 如需詳細資訊，請參閱[熱門的按下、立即取得、Windows 8 VDI 優化腳本，PFE！](/archive/blogs/jeff_stokes/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe)。


> [!NOTE]
> Windows 8 中的 SuperFetch 預設為啟用。 它是 VDI 感知，不應停用。 SuperFetch 可以透過記憶體頁面共用進一步減少記憶體耗用量，這對 VDI 很有用。 執行 Windows 7 的集區虛擬桌面電腦應停用，但在執行 Windows 7 的個人虛擬桌面電腦上應該保持開啟。